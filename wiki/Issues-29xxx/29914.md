# Issue 29914: cython code for Moebius and Coxeter matrices of posets

archive/issues_029677.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\n\n\nCC:  @tscrim @videlec\n\nComponent: **combinatorics**\n\nAuthor: **Fr\u00e9d\u00e9ric Chapoton, Travis Scrimshaw**\n\nBranch/Commit: **[`f7382af`](https://github.com/sagemath/sagetrac-mirror/commit/f7382af149154c453d45f48e8830ad958dc5a0ed)**\n\nReviewer: **Travis Scrimshaw, Fr\u00e9d\u00e9ric Chapoton**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/29914_\n\n",
    "closed_at": "2020-07-08T19:33:46Z",
    "created_at": "2020-06-20T12:37:17Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "cython code for Moebius and Coxeter matrices of posets",
    "type": "issue",
    "updated_at": "2020-07-08T19:33:46Z",
    "url": "https://github.com/sagemath/sage/issues/29914",
    "user": "https://github.com/fchapoton"
}
```
<div id="comment:0"></div>



CC:  @tscrim @videlec

Component: **combinatorics**

Author: **Frédéric Chapoton, Travis Scrimshaw**

Branch/Commit: **[`f7382af`](https://github.com/sagemath/sagetrac-mirror/commit/f7382af149154c453d45f48e8830ad958dc5a0ed)**

Reviewer: **Travis Scrimshaw, Frédéric Chapoton**

_Issue created by migration from https://trac.sagemath.org/ticket/29914_





---

archive/issue_events_409216.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-06-20T12:37:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29914#event-409216"
}
```



---

archive/issue_events_409217.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-06-20T12:37:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
    "label_color": "0000ff",
    "label_name": "c: combinatorics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29914#event-409217"
}
```



---

archive/issue_events_409218.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-06-20T12:37:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29914#event-409218"
}
```



---

archive/issue_events_409219.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-06-20T12:37:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29914#event-409219"
}
```



---

archive/issue_comments_472865.json:
```json
{
    "body": "Branch: **[u/chapoton/29914](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/29914)**",
    "created_at": "2020-06-20T12:37:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472865",
    "user": "https://github.com/fchapoton"
}
```

Branch: **[u/chapoton/29914](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/29914)**



---

archive/issue_comments_472866.json:
```json
{
    "body": "Commit: **[`83c5003`](https://github.com/sagemath/sagetrac-mirror/commit/83c5003bddc679e671949559342683994a7c527e)**",
    "created_at": "2020-06-20T12:37:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472866",
    "user": "https://github.com/fchapoton"
}
```

Commit: **[`83c5003`](https://github.com/sagemath/sagetrac-mirror/commit/83c5003bddc679e671949559342683994a7c527e)**



---

archive/issue_comments_472867.json:
```json
{
    "body": "<div id=\"comment:1\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/83c5003bddc679e671949559342683994a7c527e\"><code>83c5003</code></a></td><td><code>add custom cython code for Moebius matrix and Coxeter matrix of poset</code></td></tr></table>\n",
    "created_at": "2020-06-20T12:37:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472867",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:1"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/83c5003bddc679e671949559342683994a7c527e"><code>83c5003</code></a></td><td><code>add custom cython code for Moebius matrix and Coxeter matrix of poset</code></td></tr></table>




---

archive/issue_events_409220.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-06-20T12:37:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29914#event-409220"
}
```



---

archive/issue_comments_472868.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nbot is morally green. Please review with care, as I am no cython expert.",
    "created_at": "2020-06-21T06:03:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472868",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:2" align="right">comment:2</div>

bot is morally green. Please review with care, as I am no cython expert.



---

archive/issue_comments_472869.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nSomething that you could try that might get some extra speed out is store the lengths of the positions in an array, then iterate `j` and `k` over those values. So something like this:\n\n```python\n    cdef Py_ssize_t *pos_lens = <Py_ssize_t*> sig_malloc(len(positions)*sizeof(Py_ssize_t))\n    cdef Py_ssize_t jind\n    for i in range(n - 1, -1, -1):\n        for jind in range(pos_lens[i]):\n            j = <int> (positions[jind])\n    sig_free(pos_lens)\n```\nAt least where iterating over `j` and `k` is where the C code looks somewhat bad. You probably also want to put a `sig_check` at least somewhere within one of those loops so it can catch interrupts.\n\nIt probably would be good to instead of creating a new matrix and then setting the entries, to create a `__new__` matrix and set the `A._matrix = M` so you don't move things around in memory so much.",
    "created_at": "2020-06-22T04:34:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472869",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:3" align="right">comment:3</div>

Something that you could try that might get some extra speed out is store the lengths of the positions in an array, then iterate `j` and `k` over those values. So something like this:

```python
    cdef Py_ssize_t *pos_lens = <Py_ssize_t*> sig_malloc(len(positions)*sizeof(Py_ssize_t))
    cdef Py_ssize_t jind
    for i in range(n - 1, -1, -1):
        for jind in range(pos_lens[i]):
            j = <int> (positions[jind])
    sig_free(pos_lens)
```
At least where iterating over `j` and `k` is where the C code looks somewhat bad. You probably also want to put a `sig_check` at least somewhere within one of those loops so it can catch interrupts.

It probably would be good to instead of creating a new matrix and then setting the entries, to create a `__new__` matrix and set the `A._matrix = M` so you don't move things around in memory so much.



---

archive/issue_comments_472870.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nThanks for the comments !\n\nReplying to [@tscrim](#comment%3A3):\n> Something that you could try that might get some extra speed out is store the lengths of the positions in an array, then iterate `j` and `k` over those values. So something like this:\n> \n> ```python\n>     cdef Py_ssize_t *pos_lens = <Py_ssize_t*> sig_malloc(len(positions)*sizeof(Py_ssize_t))\n>     cdef Py_ssize_t jind\n>     for i in range(n - 1, -1, -1):\n>         for jind in range(pos_lens[i]):\n>             j = <int> (positions[jind])\n>     sig_free(pos_lens)\n> ```\n> At least where iterating over `j` and `k` is where the C code looks somewhat bad. You probably also want to put a `sig_check` at least somewhere within one of those loops so it can catch interrupts.\n\nok, I will try to think about that. In my use case, the time-consuming step is not this one, but the computation of the charpoly that follows, and where magma is blazingly fast compared to Flint.\n \n> It probably would be good to instead of creating a new matrix and then setting the entries, to create a `__new__` matrix and set the `A._matrix = M` so you don't move things around in memory so much.\n\nWould you be so kind to explain a little bit more, or give me an example file to look at ?",
    "created_at": "2020-06-22T12:30:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472870",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:4" align="right">comment:4</div>

Thanks for the comments !

Replying to [@tscrim](#comment%3A3):
> Something that you could try that might get some extra speed out is store the lengths of the positions in an array, then iterate `j` and `k` over those values. So something like this:
> 
> ```python
>     cdef Py_ssize_t *pos_lens = <Py_ssize_t*> sig_malloc(len(positions)*sizeof(Py_ssize_t))
>     cdef Py_ssize_t jind
>     for i in range(n - 1, -1, -1):
>         for jind in range(pos_lens[i]):
>             j = <int> (positions[jind])
>     sig_free(pos_lens)
> ```
> At least where iterating over `j` and `k` is where the C code looks somewhat bad. You probably also want to put a `sig_check` at least somewhere within one of those loops so it can catch interrupts.

ok, I will try to think about that. In my use case, the time-consuming step is not this one, but the computation of the charpoly that follows, and where magma is blazingly fast compared to Flint.
 
> It probably would be good to instead of creating a new matrix and then setting the entries, to create a `__new__` matrix and set the `A._matrix = M` so you don't move things around in memory so much.

Would you be so kind to explain a little bit more, or give me an example file to look at ?



---

archive/issue_comments_472871.json:
```json
{
    "body": "<div id=\"comment:5\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/75d6b1bbb0a99bc526413c954eff7ed3a22e7f67\"><code>75d6b1b</code></a></td><td><code>some simplifications in Cython code for Moebius + Coxeter matrices</code></td></tr></table>\n",
    "created_at": "2020-06-23T18:32:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472871",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:5"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/75d6b1bbb0a99bc526413c954eff7ed3a22e7f67"><code>75d6b1b</code></a></td><td><code>some simplifications in Cython code for Moebius + Coxeter matrices</code></td></tr></table>




---

archive/issue_comments_472872.json:
```json
{
    "body": "Changed commit from **[`83c5003`](https://github.com/sagemath/sagetrac-mirror/commit/83c5003bddc679e671949559342683994a7c527e)** to **[`75d6b1b`](https://github.com/sagemath/sagetrac-mirror/commit/75d6b1bbb0a99bc526413c954eff7ed3a22e7f67)**",
    "created_at": "2020-06-23T18:32:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472872",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`83c5003`](https://github.com/sagemath/sagetrac-mirror/commit/83c5003bddc679e671949559342683994a7c527e)** to **[`75d6b1b`](https://github.com/sagemath/sagetrac-mirror/commit/75d6b1bbb0a99bc526413c954eff7ed3a22e7f67)**



---

archive/issue_comments_472873.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nok, here is some progress. I have not yet used your proposal for the inner loop. Do you think that this could really matter ?",
    "created_at": "2020-06-23T18:34:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472873",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:6" align="right">comment:6</div>

ok, here is some progress. I have not yet used your proposal for the inner loop. Do you think that this could really matter ?



---

archive/issue_comments_472874.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/729b4142d45e87f25ae2abbd6eb9ca87c06cd9d4\"><code>729b414</code></a></td><td><code>some details</code></td></tr></table>\n",
    "created_at": "2020-06-23T18:37:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472874",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/729b4142d45e87f25ae2abbd6eb9ca87c06cd9d4"><code>729b414</code></a></td><td><code>some details</code></td></tr></table>




---

archive/issue_comments_472875.json:
```json
{
    "body": "Changed commit from **[`75d6b1b`](https://github.com/sagemath/sagetrac-mirror/commit/75d6b1bbb0a99bc526413c954eff7ed3a22e7f67)** to **[`729b414`](https://github.com/sagemath/sagetrac-mirror/commit/729b4142d45e87f25ae2abbd6eb9ca87c06cd9d4)**",
    "created_at": "2020-06-23T18:37:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472875",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`75d6b1b`](https://github.com/sagemath/sagetrac-mirror/commit/75d6b1bbb0a99bc526413c954eff7ed3a22e7f67)** to **[`729b414`](https://github.com/sagemath/sagetrac-mirror/commit/729b4142d45e87f25ae2abbd6eb9ca87c06cd9d4)**



---

archive/issue_comments_472876.json:
```json
{
    "body": "<div id=\"comment:8\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/90a8d5b5877953f6489b50d241470fd33ecc5beb\"><code>90a8d5b</code></a></td><td><code>more details in trac 29914</code></td></tr></table>\n",
    "created_at": "2020-06-23T18:50:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472876",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:8"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/90a8d5b5877953f6489b50d241470fd33ecc5beb"><code>90a8d5b</code></a></td><td><code>more details in trac 29914</code></td></tr></table>




---

archive/issue_comments_472877.json:
```json
{
    "body": "Changed commit from **[`729b414`](https://github.com/sagemath/sagetrac-mirror/commit/729b4142d45e87f25ae2abbd6eb9ca87c06cd9d4)** to **[`90a8d5b`](https://github.com/sagemath/sagetrac-mirror/commit/90a8d5b5877953f6489b50d241470fd33ecc5beb)**",
    "created_at": "2020-06-23T18:50:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472877",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`729b414`](https://github.com/sagemath/sagetrac-mirror/commit/729b4142d45e87f25ae2abbd6eb9ca87c06cd9d4)** to **[`90a8d5b`](https://github.com/sagemath/sagetrac-mirror/commit/90a8d5b5877953f6489b50d241470fd33ecc5beb)**



---

archive/issue_comments_472878.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nThanks for doing that; sorry I didn't have time to respond as I needed a bit more time to look at it than I had.\n\nI think it could matter, but I don't know by how much. I can experiment with it, but I will need a day or two (this is the first week of finals at UQ).",
    "created_at": "2020-06-24T23:12:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472878",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:9" align="right">comment:9</div>

Thanks for doing that; sorry I didn't have time to respond as I needed a bit more time to look at it than I had.

I think it could matter, but I don't know by how much. I can experiment with it, but I will need a day or two (this is the first week of finals at UQ).



---

archive/issue_comments_472879.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nI finally have gotten to this. So my code was slightly wrong, but easy enough to fix.\n\nTimings with your branch:\n\n```\nsage: P1 = posets.BooleanLattice(5)\nsage: P2 = posets.SymmetricGroupBruhatOrderPoset(5)\nsage: P3 = posets.YoungDiagramPoset(Partition([9,5,5,5,4,4,3,1,1,1,1,1,1,1]))\nsage: P4 = posets.TamariLattice(5,3); P4\nFinite lattice containing 969 elements\nsage: P5 = posets.TamariLattice(8); P5\nFinite lattice containing 1430 elements\n\nsage: %time _ = P1._hasse_diagram.coxeter_transformation()\nCPU times: user 0 ns, sys: 3.8 ms, total: 3.8 ms\nWall time: 3.72 ms\n\nsage: %time _ = P2._hasse_diagram.coxeter_transformation()\nCPU times: user 17.2 ms, sys: 7 \u00b5s, total: 17.2 ms\nWall time: 17.1 ms\n\nsage: %time _ = P3._hasse_diagram.coxeter_transformation()\nCPU times: user 955 \u00b5s, sys: 89 \u00b5s, total: 1.04 ms\nWall time: 1.05 ms\n\nsage: %time _ = P4._hasse_diagram.coxeter_transformation()\nCPU times: user 339 ms, sys: 4.15 ms, total: 343 ms\nWall time: 342 ms\n\nsage: %time _ = P5._hasse_diagram.coxeter_transformation()\nCPU times: user 577 ms, sys: 8 ms, total: 585 ms\nWall time: 584 ms\n```\nversus with my branch:\n\n```\nsage: %time _ = P1._hasse_diagram.coxeter_transformation()\nCPU times: user 1.77 ms, sys: 0 ns, total: 1.77 ms\nWall time: 1.78 ms\n\nsage: %time _ = P2._hasse_diagram.coxeter_transformation()\nCPU times: user 8.77 ms, sys: 4.01 ms, total: 12.8 ms\nWall time: 13.4 ms\n\nsage: %time _ = P3._hasse_diagram.coxeter_transformation()\nCPU times: user 873 \u00b5s, sys: 81 \u00b5s, total: 954 \u00b5s\nWall time: 965 \u00b5s\n\nsage: %time _ = P4._hasse_diagram.coxeter_transformation()\nCPU times: user 302 ms, sys: 4.01 ms, total: 306 ms\nWall time: 305 ms\n\nsage: %time _ = P5._hasse_diagram.coxeter_transformation()\nCPU times: user 535 ms, sys: 11.7 ms, total: 547 ms\nWall time: 549 ms\n```\n\nSo I am seeing regularly a 10% speedup to the Coxeter transformation code (the larger differences seem more to be noise).\n\nI've set the branch in case you want to use it. If you don't then you can revert back to your branch and set a positive review.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ce1ab523914155f6ff444c9cfebfc14edf452344\"><code>ce1ab52</code></a></td><td><code>Merge branch 'u/chapoton/29914' of git://trac.sagemath.org/sage into u/chapoton/29914</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f7382af149154c453d45f48e8830ad958dc5a0ed\"><code>f7382af</code></a></td><td><code>Unrolling the lists into C arrays for extra speed.</code></td></tr></table>\n",
    "created_at": "2020-07-01T00:08:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472879",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:10" align="right">comment:10</div>

I finally have gotten to this. So my code was slightly wrong, but easy enough to fix.

Timings with your branch:

```
sage: P1 = posets.BooleanLattice(5)
sage: P2 = posets.SymmetricGroupBruhatOrderPoset(5)
sage: P3 = posets.YoungDiagramPoset(Partition([9,5,5,5,4,4,3,1,1,1,1,1,1,1]))
sage: P4 = posets.TamariLattice(5,3); P4
Finite lattice containing 969 elements
sage: P5 = posets.TamariLattice(8); P5
Finite lattice containing 1430 elements

sage: %time _ = P1._hasse_diagram.coxeter_transformation()
CPU times: user 0 ns, sys: 3.8 ms, total: 3.8 ms
Wall time: 3.72 ms

sage: %time _ = P2._hasse_diagram.coxeter_transformation()
CPU times: user 17.2 ms, sys: 7 µs, total: 17.2 ms
Wall time: 17.1 ms

sage: %time _ = P3._hasse_diagram.coxeter_transformation()
CPU times: user 955 µs, sys: 89 µs, total: 1.04 ms
Wall time: 1.05 ms

sage: %time _ = P4._hasse_diagram.coxeter_transformation()
CPU times: user 339 ms, sys: 4.15 ms, total: 343 ms
Wall time: 342 ms

sage: %time _ = P5._hasse_diagram.coxeter_transformation()
CPU times: user 577 ms, sys: 8 ms, total: 585 ms
Wall time: 584 ms
```
versus with my branch:

```
sage: %time _ = P1._hasse_diagram.coxeter_transformation()
CPU times: user 1.77 ms, sys: 0 ns, total: 1.77 ms
Wall time: 1.78 ms

sage: %time _ = P2._hasse_diagram.coxeter_transformation()
CPU times: user 8.77 ms, sys: 4.01 ms, total: 12.8 ms
Wall time: 13.4 ms

sage: %time _ = P3._hasse_diagram.coxeter_transformation()
CPU times: user 873 µs, sys: 81 µs, total: 954 µs
Wall time: 965 µs

sage: %time _ = P4._hasse_diagram.coxeter_transformation()
CPU times: user 302 ms, sys: 4.01 ms, total: 306 ms
Wall time: 305 ms

sage: %time _ = P5._hasse_diagram.coxeter_transformation()
CPU times: user 535 ms, sys: 11.7 ms, total: 547 ms
Wall time: 549 ms
```

So I am seeing regularly a 10% speedup to the Coxeter transformation code (the larger differences seem more to be noise).

I've set the branch in case you want to use it. If you don't then you can revert back to your branch and set a positive review.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ce1ab523914155f6ff444c9cfebfc14edf452344"><code>ce1ab52</code></a></td><td><code>Merge branch 'u/chapoton/29914' of git://trac.sagemath.org/sage into u/chapoton/29914</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f7382af149154c453d45f48e8830ad958dc5a0ed"><code>f7382af</code></a></td><td><code>Unrolling the lists into C arrays for extra speed.</code></td></tr></table>




---

archive/issue_comments_472880.json:
```json
{
    "body": "Changed branch from **[u/chapoton/29914](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/29914)** to **[u/tscrim/cython_moebius_coxeter_matrices-29914](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/cython_moebius_coxeter_matrices-29914)**",
    "created_at": "2020-07-01T00:08:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472880",
    "user": "https://github.com/tscrim"
}
```

Changed branch from **[u/chapoton/29914](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/29914)** to **[u/tscrim/cython_moebius_coxeter_matrices-29914](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/cython_moebius_coxeter_matrices-29914)**



---

archive/issue_comments_472881.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2020-07-01T00:08:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472881",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_comments_472882.json:
```json
{
    "body": "Changed commit from **[`90a8d5b`](https://github.com/sagemath/sagetrac-mirror/commit/90a8d5b5877953f6489b50d241470fd33ecc5beb)** to **[`f7382af`](https://github.com/sagemath/sagetrac-mirror/commit/f7382af149154c453d45f48e8830ad958dc5a0ed)**",
    "created_at": "2020-07-01T00:08:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472882",
    "user": "https://github.com/tscrim"
}
```

Changed commit from **[`90a8d5b`](https://github.com/sagemath/sagetrac-mirror/commit/90a8d5b5877953f6489b50d241470fd33ecc5beb)** to **[`f7382af`](https://github.com/sagemath/sagetrac-mirror/commit/f7382af149154c453d45f48e8830ad958dc5a0ed)**



---

archive/issue_comments_472883.json:
```json
{
    "body": "Changed author from **Fr\u00e9d\u00e9ric Chapoton** to **Fr\u00e9d\u00e9ric Chapoton, Travis Scrimshaw**",
    "created_at": "2020-07-01T07:08:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472883",
    "user": "https://github.com/fchapoton"
}
```

Changed author from **Frédéric Chapoton** to **Frédéric Chapoton, Travis Scrimshaw**



---

archive/issue_comments_472884.json:
```json
{
    "body": "Changed reviewer from **Travis Scrimshaw** to **Travis Scrimshaw, Fr\u00e9d\u00e9ric Chapoton**",
    "created_at": "2020-07-01T07:08:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472884",
    "user": "https://github.com/fchapoton"
}
```

Changed reviewer from **Travis Scrimshaw** to **Travis Scrimshaw, Frédéric Chapoton**



---

archive/issue_events_409221.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-07-01T07:08:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29914#event-409221"
}
```



---

archive/issue_events_409222.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-07-01T07:08:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29914#event-409222"
}
```



---

archive/issue_comments_472885.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nLooks good to me. Thanks a lot for taking some of your time to enhance the code. \n\nI am setting to positive on your behalf.",
    "created_at": "2020-07-01T07:08:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472885",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:11" align="right">comment:11</div>

Looks good to me. Thanks a lot for taking some of your time to enhance the code. 

I am setting to positive on your behalf.



---

archive/issue_comments_472886.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nNo problem. Sorry it took longer than I expected to get to this.",
    "created_at": "2020-07-01T07:38:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472886",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:12" align="right">comment:12</div>

No problem. Sorry it took longer than I expected to get to this.



---

archive/issue_events_409223.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-07-08T19:33:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29914#event-409223"
}
```



---

archive/issue_events_409224.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "f9fdd736afb6d2cad1c32e7ae646dbaaa01a51c2",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2020-07-08T19:33:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/29914#event-409224"
}
```



---

archive/issue_comments_472887.json:
```json
{
    "body": "Changed branch from **[u/tscrim/cython_moebius_coxeter_matrices-29914](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/cython_moebius_coxeter_matrices-29914)** to **[`f7382af`](https://github.com/sagemath/sagetrac-mirror/commit/f7382af149154c453d45f48e8830ad958dc5a0ed)**",
    "created_at": "2020-07-08T19:33:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/29914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/29914#issuecomment-472887",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/tscrim/cython_moebius_coxeter_matrices-29914](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/cython_moebius_coxeter_matrices-29914)** to **[`f7382af`](https://github.com/sagemath/sagetrac-mirror/commit/f7382af149154c453d45f48e8830ad958dc5a0ed)**
