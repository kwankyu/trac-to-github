# Issue 34935: Followup to #34547: fix emacs sage-shell-mode

archive/issues_034698.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\nIt turns out that sage-shell-mode in emacs uses the variable `interfaces`, deleted from `sage.interfaces.all` in #34547. We restore that variable (which is not used anywhere in the Sage library) along with a comment.\n\nComponent: **interfaces**\n\nKeywords: **emacs**\n\nAuthor: **John Palmieri**\n\nBranch/Commit: **[u/jhpalmieri/interfaces-emacs](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/interfaces-emacs) @ [`49d4ff7`](https://github.com/sagemath/sagetrac-mirror/commit/49d4ff78cc214bd7e964ec91811646218e9858cd)**\n\nReviewer: **Matthias Koeppe**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/34935_\n\n",
    "created_at": "2023-01-24T23:10:58Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
        "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/positive%20review"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Followup to #34547: fix emacs sage-shell-mode",
    "type": "issue",
    "updated_at": "2023-01-25T17:24:55Z",
    "url": "https://github.com/sagemath/sage/issues/34935",
    "user": "https://github.com/jhpalmieri"
}
```
<div id="comment:0"></div>

It turns out that sage-shell-mode in emacs uses the variable `interfaces`, deleted from `sage.interfaces.all` in #34547. We restore that variable (which is not used anywhere in the Sage library) along with a comment.

Component: **interfaces**

Keywords: **emacs**

Author: **John Palmieri**

Branch/Commit: **[u/jhpalmieri/interfaces-emacs](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/interfaces-emacs) @ [`49d4ff7`](https://github.com/sagemath/sagetrac-mirror/commit/49d4ff78cc214bd7e964ec91811646218e9858cd)**

Reviewer: **Matthias Koeppe**

_Issue created by migration from https://trac.sagemath.org/ticket/34935_





---

archive/issue_events_473014.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2023-01-24T23:10:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34935#event-473014"
}
```



---

archive/issue_events_473015.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2023-01-24T23:10:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
    "label_color": "0000ff",
    "label_name": "c: interfaces",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34935#event-473015"
}
```



---

archive/issue_events_473016.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2023-01-24T23:10:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34935#event-473016"
}
```



---

archive/issue_events_473017.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2023-01-24T23:10:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34935#event-473017"
}
```



---

archive/issue_comments_562726.json:
```json
{
    "body": "Branch: **[u/jhpalmieri/interfaces-emacs](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/interfaces-emacs)**",
    "created_at": "2023-01-24T23:11:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34935#issuecomment-562726",
    "user": "https://github.com/jhpalmieri"
}
```

Branch: **[u/jhpalmieri/interfaces-emacs](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/interfaces-emacs)**



---

archive/issue_events_473018.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2023-01-24T23:11:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34935#event-473018"
}
```



---

archive/issue_comments_562727.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8e76d0d2556593fb2c8ccbfd3ec7f051b3381ff6\"><code>8e76d0d</code></a></td><td><code>trac 34935: fix sage-shell mode in emacs</code></td></tr></table>\n",
    "created_at": "2023-01-24T23:11:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34935#issuecomment-562727",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:2"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8e76d0d2556593fb2c8ccbfd3ec7f051b3381ff6"><code>8e76d0d</code></a></td><td><code>trac 34935: fix sage-shell mode in emacs</code></td></tr></table>




---

archive/issue_comments_562728.json:
```json
{
    "body": "Commit: **[`8e76d0d`](https://github.com/sagemath/sagetrac-mirror/commit/8e76d0d2556593fb2c8ccbfd3ec7f051b3381ff6)**",
    "created_at": "2023-01-24T23:11:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34935#issuecomment-562728",
    "user": "https://github.com/jhpalmieri"
}
```

Commit: **[`8e76d0d`](https://github.com/sagemath/sagetrac-mirror/commit/8e76d0d2556593fb2c8ccbfd3ec7f051b3381ff6)**



---

archive/issue_comments_562729.json:
```json
{
    "body": "Reviewer: **Matthias Koeppe**",
    "created_at": "2023-01-24T23:21:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34935#issuecomment-562729",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **Matthias Koeppe**



---

archive/issue_events_473019.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2023-01-24T23:21:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34935#event-473019"
}
```



---

archive/issue_events_473020.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2023-01-24T23:21:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34935#event-473020"
}
```



---

archive/issue_comments_562730.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThe backslashes are not needed, but positive review nevertheless.",
    "created_at": "2023-01-24T23:21:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34935#issuecomment-562730",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:3" align="right">comment:3</div>

The backslashes are not needed, but positive review nevertheless.



---

archive/issue_comments_562731.json:
```json
{
    "body": "Changed commit from **[`8e76d0d`](https://github.com/sagemath/sagetrac-mirror/commit/8e76d0d2556593fb2c8ccbfd3ec7f051b3381ff6)** to **[`49d4ff7`](https://github.com/sagemath/sagetrac-mirror/commit/49d4ff78cc214bd7e964ec91811646218e9858cd)**",
    "created_at": "2023-01-24T23:29:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34935#issuecomment-562731",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`8e76d0d`](https://github.com/sagemath/sagetrac-mirror/commit/8e76d0d2556593fb2c8ccbfd3ec7f051b3381ff6)** to **[`49d4ff7`](https://github.com/sagemath/sagetrac-mirror/commit/49d4ff78cc214bd7e964ec91811646218e9858cd)**



---

archive/issue_events_473021.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2023-01-24T23:29:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34935#event-473021"
}
```



---

archive/issue_events_473022.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2023-01-24T23:29:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34935#event-473022"
}
```



---

archive/issue_comments_562732.json:
```json
{
    "body": "<div id=\"comment:4\"></div>\n\nBranch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/49d4ff78cc214bd7e964ec91811646218e9858cd\"><code>49d4ff7</code></a></td><td><code>trac 34935: fix sage-shell mode in emacs</code></td></tr></table>\n",
    "created_at": "2023-01-24T23:29:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34935#issuecomment-562732",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:4"></div>

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/49d4ff78cc214bd7e964ec91811646218e9858cd"><code>49d4ff7</code></a></td><td><code>trac 34935: fix sage-shell mode in emacs</code></td></tr></table>




---

archive/issue_comments_562733.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nRight, sorry, I was just copying the old lines back. Let's get rid of the backslashes.",
    "created_at": "2023-01-24T23:30:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34935#issuecomment-562733",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:5" align="right">comment:5</div>

Right, sorry, I was just copying the old lines back. Let's get rid of the backslashes.



---

archive/issue_events_473023.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2023-01-24T23:30:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34935#event-473023"
}
```



---

archive/issue_events_473024.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2023-01-24T23:30:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34935#event-473024"
}
```



---

archive/issue_comments_562734.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nWow, that's great!\n\nNow that you found the culprit, what do you think about simply removing the offending lines in `sage-shell-mode` itself?\n\nI admit that I do not understand at all why names in `interfaces` get a special treatment.\n\nAnother special case I do not understand is line 351:\n\n```\nignore_classes = [sage.interfaces.gap.Gap, sage.misc.lazy_import.LazyImport]\n```\n\nWe could actually take the opportunity do (optionally?) remove the underscore and double underscore methods from the completion list.  I never understood that the code was so simple!\n\nI would do this, if at least one further person is interested.\n\n```diff\n--- /home/martin/.emacs.d/elpa/sage-shell-mode-20221020.1012/emacs_sage_shell.py.old\t2023-01-25 07:57:39.845564969 +0100\n+++ /home/martin/.emacs.d/elpa/sage-shell-mode-20221020.1012/emacs_sage_shell.py\t2023-01-25 07:58:33.123905933 +0100\n@@ -52,8 +52,6 @@\n except:\n     pass\n \n-interfaces = ip.ev('interfaces')\n-\n _sage_const_regexp = re.compile(\"_sage_const_\")\n \n \n@@ -168,12 +166,10 @@\n         regexp = re.compile(\"^[ a-zA-Z0-9._\\\\[\\\\]]+$\")\n         if regexp.match(varname) is None:\n             return []\n-        if varname in interfaces:\n-            ls = ip.ev('dir(%s)' % (varname,))\n-        else:\n-            ls = _completions_attributes(preparse(varname))\n-            ls.extend(ip.ev('dir(%s)' % (preparse(varname),)))\n-            ls = list(sorted(set(ls)))\n+        name = preparse(varname)\n+        ls = _completions_attributes(name)\n+        ls.extend(ip.ev('dir(%s)' % (name,)))\n+        ls = list(sorted(set(ls)))\n         return ls\n     except:\n         return []\n```",
    "created_at": "2023-01-25T07:11:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34935#issuecomment-562734",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:6" align="right">comment:6</div>

Wow, that's great!

Now that you found the culprit, what do you think about simply removing the offending lines in `sage-shell-mode` itself?

I admit that I do not understand at all why names in `interfaces` get a special treatment.

Another special case I do not understand is line 351:

```
ignore_classes = [sage.interfaces.gap.Gap, sage.misc.lazy_import.LazyImport]
```

We could actually take the opportunity do (optionally?) remove the underscore and double underscore methods from the completion list.  I never understood that the code was so simple!

I would do this, if at least one further person is interested.

```diff
--- /home/martin/.emacs.d/elpa/sage-shell-mode-20221020.1012/emacs_sage_shell.py.old	2023-01-25 07:57:39.845564969 +0100
+++ /home/martin/.emacs.d/elpa/sage-shell-mode-20221020.1012/emacs_sage_shell.py	2023-01-25 07:58:33.123905933 +0100
@@ -52,8 +52,6 @@
 except:
     pass
 
-interfaces = ip.ev('interfaces')
-
 _sage_const_regexp = re.compile("_sage_const_")
 
 
@@ -168,12 +166,10 @@
         regexp = re.compile("^[ a-zA-Z0-9._\\[\\]]+$")
         if regexp.match(varname) is None:
             return []
-        if varname in interfaces:
-            ls = ip.ev('dir(%s)' % (varname,))
-        else:
-            ls = _completions_attributes(preparse(varname))
-            ls.extend(ip.ev('dir(%s)' % (preparse(varname),)))
-            ls = list(sorted(set(ls)))
+        name = preparse(varname)
+        ls = _completions_attributes(name)
+        ls.extend(ip.ev('dir(%s)' % (name,)))
+        ls = list(sorted(set(ls)))
         return ls
     except:
         return []
```



---

archive/issue_comments_562735.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [John Palmieri](#comment%3A5):\n> Right, sorry, I was just copying the old lines back. Let's get rid of the backslashes.\n\nI confirm that `9.8.beta7` + the present patch runs under `sage-shell-mode`.\n\nThanks a lot !",
    "created_at": "2023-01-25T12:51:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34935#issuecomment-562735",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [John Palmieri](#comment%3A5):
> Right, sorry, I was just copying the old lines back. Let's get rid of the backslashes.

I confirm that `9.8.beta7` + the present patch runs under `sage-shell-mode`.

Thanks a lot !



---

archive/issue_comments_562736.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [Martin Rubey](#comment%3A6):\n> Wow, that's great!\n> \n> Now that you found the culprit, what do you think about simply removing the offending lines in `sage-shell-mode` itself?\n\nI don't use sage-shell-mode, so I don't know what users would lose if we got rid of those lines. I think we should keep this change for now and then possibly change sage-shell-mode separately. If we remove this from sage-shell-mode, then some time after that, we can remove the `interfaces` variable from Sage. (We probably should keep it for a while for people using older versions of sage-shell-mode.)",
    "created_at": "2023-01-25T17:24:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34935",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34935#issuecomment-562736",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [Martin Rubey](#comment%3A6):
> Wow, that's great!
> 
> Now that you found the culprit, what do you think about simply removing the offending lines in `sage-shell-mode` itself?

I don't use sage-shell-mode, so I don't know what users would lose if we got rid of those lines. I think we should keep this change for now and then possibly change sage-shell-mode separately. If we remove this from sage-shell-mode, then some time after that, we can remove the `interfaces` variable from Sage. (We probably should keep it for a while for people using older versions of sage-shell-mode.)
