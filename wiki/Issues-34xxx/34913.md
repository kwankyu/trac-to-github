# Issue 34913: Subclassing Graph and overriding constructor breaks inherited .plot() method

archive/issues_034676.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\nWhile working on ticket 25933 I came across a slightly annoying issue with the Graph.plot() method.\n\nConsider the following code subclassing the Graph class\n\n```\nclass GraphSubclass(Graph):    \n    def __init__(self, a_param):\n\n        ### some code ###\n        \n        # call graph constructor\n        super().__init__([[0,1],[1,2]])    \n```\n\nObviously the above code is a useless toy example, but it should be clear why we might want to create a graph subclass with a different constructor.\n\nMost methods work correctly when inherited\n\n```\ng=GraphSubclass(\"foo\")\ng.am()\n# [0 1 0]\n# [1 0 1]\n# [0 1 0]\ng.edges()\n#[(0, 1, None), (1, 2, None)]\n```\netc.\n\nHowever calling .plot() doesn't work, and raises an error (i've pasted the stack trace at the end of the ticket)\n\nNot sure if this is easy to fix, but it feels like we should be able to call `.plot()` on an object defined as above and have it function correctly.\n\nA hack to fix it is to do something like\n\n```\ndef plot(self):\n\n    self.__class__=Graph\n    p=self.plot()\n    self.__class__=GraphSubclass\n\n    return p\n```\n\nBut this is kind of ugly and doesn't feel like the best way for the code to be structured.\n\nError stacktrace:\n\n```\ng.plot()\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\nInput In [11], in <cell line: 1>()\n----> 1 g.plot()\n\nFile ~/Documents/sage/src/sage/misc/decorators.py:491, in options.__call__.<locals>.wrapper(*args, **kwds)\n    489     options['__original_opts'] = kwds\n    490 options.update(kwds)\n--> 491 return func(*args, **options)\n\nFile ~/Documents/sage/src/sage/graphs/generic_graph.py:20652, in GenericGraph.plot(self, **options)\n  20343 @options()\n  20344 def plot(self, **options):\n  20345     r\"\"\"\n  20346     Return a :class:`~sage.plot.graphics.Graphics` object representing the\n  20347     (di)graph.\n   (...)\n  20650         ['black', 'purple', 'yellow', 'yellow']\n  20651     \"\"\"\n> 20652     return self.graphplot(**options).plot()\n\nFile ~/Documents/sage/src/sage/graphs/generic_graph.py:20296, in GenericGraph.graphplot(self, **options)\n  20263 \"\"\"\n  20264 Return a :class:`~sage.graphs.graph_plot.GraphPlot` object.\n  20265 \n   (...)\n  20293     Graphics object consisting of 22 graphics primitives\n  20294 \"\"\"\n  20295 from sage.graphs.graph_plot import GraphPlot\n> 20296 return GraphPlot(graph=self, options=options)\n\nFile ~/Documents/sage/src/sage/graphs/graph_plot.py:312, in GraphPlot.__init__(self, graph, options)\n    309 self._loops = self._graph.has_loops()\n    310 self._arcdigraph = self._graph.is_directed() and self._arcs\n--> 312 self.set_pos()\n    313 self.set_vertices()\n    314 self.set_edges()\n\nFile ~/Documents/sage/src/sage/graphs/graph_plot.py:389, in GraphPlot.set_pos(self)\n    330 def set_pos(self):\n    331     \"\"\"\n    332     Set the position plotting parameters for this GraphPlot.\n    333 \n   (...)\n    387         Graphics object consisting of 6 graphics primitives\n    388     \"\"\"\n--> 389     self._pos = self._graph.layout(**self._options)\n    390     # Make sure the positions are floats (trac #10124)\n    391     self._pos = {k: (float(v[0]), float(v[1]))\n    392                  for k, v in self._pos.items()}\n\nFile ~/Documents/sage/src/sage/graphs/generic_graph.py:19469, in GenericGraph.layout(self, layout, pos, dim, save_pos, **options)\n  19466         layout = 'default'\n  19468 if hasattr(self, \"layout_%s\" % layout):\n> 19469     pos = getattr(self, \"layout_%s\" % layout)(dim=dim, **options)\n  19470 elif layout is not None:\n  19471     raise ValueError(\"unknown layout algorithm: %s\" % layout)\n\nFile ~/Documents/sage/src/sage/graphs/generic_graph.py:19507, in GenericGraph.layout_spring(self, by_component, **options)\n  19480 def layout_spring(self, by_component=True, **options):\n  19481     \"\"\"\n  19482     Return a spring layout for this graph.\n  19483 \n   (...)\n  19505         Graphics object consisting of 34 graphics primitives\n  19506     \"\"\"\n> 19507     return spring_layout_fast(self, by_component=by_component, **options)\n\nFile ~/Documents/sage/src/sage/graphs/generic_graph_pyx.pyx:170, in sage.graphs.generic_graph_pyx.spring_layout_fast()\n    168 \"\"\"\n    169 if by_component:\n--> 170     return layout_split(spring_layout_fast, G, iterations=iterations,\n    171                         dim=dim, vpos=vpos, rescale=rescale,\n    172                         height=height, **options)\n\nFile ~/Documents/sage/src/sage/graphs/generic_graph_pyx.pyx:77, in sage.graphs.generic_graph_pyx.layout_split()\n     75 \"\"\"\n     76 from copy import copy\n---> 77 Gs = G.connected_components_subgraphs()\n     78 pos = {}\n     79 left = 0\n\nFile ~/Documents/sage/src/sage/graphs/connectivity.pyx:239, in sage.graphs.connectivity.connected_components_subgraphs()\n    237     raise TypeError(\"the input must be a Sage graph\")\n    238 \n--> 239 return [G.subgraph(c, inplace=False) for c in connected_components(G, sort=False)]\n    240 \n    241 \n\nFile ~/Documents/sage/src/sage/graphs/generic_graph.py:13174, in GenericGraph.subgraph(self, vertices, edges, inplace, vertex_property, edge_property, algorithm, immutable)\n  13169     return self._subgraph_by_deleting(vertices=vertices, edges=edges,\n  13170                                       inplace=inplace,\n  13171                                       edge_property=edge_property,\n  13172                                       immutable=immutable)\n  13173 else:\n> 13174     return self._subgraph_by_adding(vertices=vertices, edges=edges,\n  13175                                     edge_property=edge_property,\n  13176                                     immutable=immutable)\n\nFile ~/Documents/sage/src/sage/graphs/generic_graph.py:13285, in GenericGraph._subgraph_by_adding(self, vertices, edges, edge_property, immutable)\n  13178 def _subgraph_by_adding(self, vertices=None, edges=None, edge_property=None, immutable=None):\n  13179     r\"\"\"\n  13180     Return the subgraph containing the given vertices and edges.\n  13181 \n   (...)\n  13283         {3: 'v3', 4: 'v4', 5: 'v5'}\n  13284     \"\"\"\n> 13285     G = self.__class__(weighted=self._weighted, loops=self.allows_loops(),\n  13286                        multiedges=self.allows_multiple_edges())\n  13287     G.name(\"Subgraph of (%s)\" % self.name())\n  13288     if edges is None and edge_property is None:\n\nTypeError: __init__() got an unexpected keyword argument 'weighted'\n```\n\nComponent: **graph theory**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/34913_\n\n",
    "created_at": "2023-01-15T18:28:28Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20graph%20theory",
        "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Subclassing Graph and overriding constructor breaks inherited .plot() method",
    "type": "issue",
    "updated_at": "2023-01-29T23:06:23Z",
    "url": "https://github.com/sagemath/sage/issues/34913",
    "user": "https://github.com/Bruno-TT"
}
```
<div id="comment:0"></div>

While working on ticket 25933 I came across a slightly annoying issue with the Graph.plot() method.

Consider the following code subclassing the Graph class

```
class GraphSubclass(Graph):    
    def __init__(self, a_param):

        ### some code ###
        
        # call graph constructor
        super().__init__([[0,1],[1,2]])    
```

Obviously the above code is a useless toy example, but it should be clear why we might want to create a graph subclass with a different constructor.

Most methods work correctly when inherited

```
g=GraphSubclass("foo")
g.am()
# [0 1 0]
# [1 0 1]
# [0 1 0]
g.edges()
#[(0, 1, None), (1, 2, None)]
```
etc.

However calling .plot() doesn't work, and raises an error (i've pasted the stack trace at the end of the ticket)

Not sure if this is easy to fix, but it feels like we should be able to call `.plot()` on an object defined as above and have it function correctly.

A hack to fix it is to do something like

```
def plot(self):

    self.__class__=Graph
    p=self.plot()
    self.__class__=GraphSubclass

    return p
```

But this is kind of ugly and doesn't feel like the best way for the code to be structured.

Error stacktrace:

```
g.plot()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
Input In [11], in <cell line: 1>()
----> 1 g.plot()

File ~/Documents/sage/src/sage/misc/decorators.py:491, in options.__call__.<locals>.wrapper(*args, **kwds)
    489     options['__original_opts'] = kwds
    490 options.update(kwds)
--> 491 return func(*args, **options)

File ~/Documents/sage/src/sage/graphs/generic_graph.py:20652, in GenericGraph.plot(self, **options)
  20343 @options()
  20344 def plot(self, **options):
  20345     r"""
  20346     Return a :class:`~sage.plot.graphics.Graphics` object representing the
  20347     (di)graph.
   (...)
  20650         ['black', 'purple', 'yellow', 'yellow']
  20651     """
> 20652     return self.graphplot(**options).plot()

File ~/Documents/sage/src/sage/graphs/generic_graph.py:20296, in GenericGraph.graphplot(self, **options)
  20263 """
  20264 Return a :class:`~sage.graphs.graph_plot.GraphPlot` object.
  20265 
   (...)
  20293     Graphics object consisting of 22 graphics primitives
  20294 """
  20295 from sage.graphs.graph_plot import GraphPlot
> 20296 return GraphPlot(graph=self, options=options)

File ~/Documents/sage/src/sage/graphs/graph_plot.py:312, in GraphPlot.__init__(self, graph, options)
    309 self._loops = self._graph.has_loops()
    310 self._arcdigraph = self._graph.is_directed() and self._arcs
--> 312 self.set_pos()
    313 self.set_vertices()
    314 self.set_edges()

File ~/Documents/sage/src/sage/graphs/graph_plot.py:389, in GraphPlot.set_pos(self)
    330 def set_pos(self):
    331     """
    332     Set the position plotting parameters for this GraphPlot.
    333 
   (...)
    387         Graphics object consisting of 6 graphics primitives
    388     """
--> 389     self._pos = self._graph.layout(**self._options)
    390     # Make sure the positions are floats (trac #10124)
    391     self._pos = {k: (float(v[0]), float(v[1]))
    392                  for k, v in self._pos.items()}

File ~/Documents/sage/src/sage/graphs/generic_graph.py:19469, in GenericGraph.layout(self, layout, pos, dim, save_pos, **options)
  19466         layout = 'default'
  19468 if hasattr(self, "layout_%s" % layout):
> 19469     pos = getattr(self, "layout_%s" % layout)(dim=dim, **options)
  19470 elif layout is not None:
  19471     raise ValueError("unknown layout algorithm: %s" % layout)

File ~/Documents/sage/src/sage/graphs/generic_graph.py:19507, in GenericGraph.layout_spring(self, by_component, **options)
  19480 def layout_spring(self, by_component=True, **options):
  19481     """
  19482     Return a spring layout for this graph.
  19483 
   (...)
  19505         Graphics object consisting of 34 graphics primitives
  19506     """
> 19507     return spring_layout_fast(self, by_component=by_component, **options)

File ~/Documents/sage/src/sage/graphs/generic_graph_pyx.pyx:170, in sage.graphs.generic_graph_pyx.spring_layout_fast()
    168 """
    169 if by_component:
--> 170     return layout_split(spring_layout_fast, G, iterations=iterations,
    171                         dim=dim, vpos=vpos, rescale=rescale,
    172                         height=height, **options)

File ~/Documents/sage/src/sage/graphs/generic_graph_pyx.pyx:77, in sage.graphs.generic_graph_pyx.layout_split()
     75 """
     76 from copy import copy
---> 77 Gs = G.connected_components_subgraphs()
     78 pos = {}
     79 left = 0

File ~/Documents/sage/src/sage/graphs/connectivity.pyx:239, in sage.graphs.connectivity.connected_components_subgraphs()
    237     raise TypeError("the input must be a Sage graph")
    238 
--> 239 return [G.subgraph(c, inplace=False) for c in connected_components(G, sort=False)]
    240 
    241 

File ~/Documents/sage/src/sage/graphs/generic_graph.py:13174, in GenericGraph.subgraph(self, vertices, edges, inplace, vertex_property, edge_property, algorithm, immutable)
  13169     return self._subgraph_by_deleting(vertices=vertices, edges=edges,
  13170                                       inplace=inplace,
  13171                                       edge_property=edge_property,
  13172                                       immutable=immutable)
  13173 else:
> 13174     return self._subgraph_by_adding(vertices=vertices, edges=edges,
  13175                                     edge_property=edge_property,
  13176                                     immutable=immutable)

File ~/Documents/sage/src/sage/graphs/generic_graph.py:13285, in GenericGraph._subgraph_by_adding(self, vertices, edges, edge_property, immutable)
  13178 def _subgraph_by_adding(self, vertices=None, edges=None, edge_property=None, immutable=None):
  13179     r"""
  13180     Return the subgraph containing the given vertices and edges.
  13181 
   (...)
  13283         {3: 'v3', 4: 'v4', 5: 'v5'}
  13284     """
> 13285     G = self.__class__(weighted=self._weighted, loops=self.allows_loops(),
  13286                        multiedges=self.allows_multiple_edges())
  13287     G.name("Subgraph of (%s)" % self.name())
  13288     if edges is None and edge_property is None:

TypeError: __init__() got an unexpected keyword argument 'weighted'
```

Component: **graph theory**

_Issue created by migration from https://trac.sagemath.org/ticket/34913_





---

archive/issue_events_472864.json:
```json
{
    "actor": "https://github.com/Bruno-TT",
    "created_at": "2023-01-15T18:28:28Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/34913",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34913#event-472864"
}
```



---

archive/issue_events_472865.json:
```json
{
    "actor": "https://github.com/Bruno-TT",
    "created_at": "2023-01-15T18:28:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34913",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20graph%20theory",
    "label_color": "0000ff",
    "label_name": "c: graph theory",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34913#event-472865"
}
```



---

archive/issue_events_472866.json:
```json
{
    "actor": "https://github.com/Bruno-TT",
    "created_at": "2023-01-15T18:28:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34913",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34913#event-472866"
}
```



---

archive/issue_events_472867.json:
```json
{
    "actor": "https://github.com/Bruno-TT",
    "created_at": "2023-01-15T18:28:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34913",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34913#event-472867"
}
```



---

archive/issue_comments_562618.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -38,7 +38,7 @@\n \n     self.__class__=Graph\n     p=self.plot()\n-    self.__class__=CorrelationGraph\n+    self.__class__=GraphSubclass\n \n     return p\n ```\n``````\n",
    "created_at": "2023-01-16T12:23:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34913",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34913#issuecomment-562618",
    "user": "https://github.com/Bruno-TT"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -38,7 +38,7 @@
 
     self.__class__=Graph
     p=self.plot()
-    self.__class__=CorrelationGraph
+    self.__class__=GraphSubclass
 
     return p
 ```
``````




---

archive/issue_events_472868.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2023-01-29T23:06:23Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/34913",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34913#event-472868"
}
```
