# Issue 34547: Interfaces: use more lazy imports, restore top-level functions maxima_console etc.

archive/issues_034310.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\nVarious files in `sage/interfaces/` have this pattern:\n\n```\nclass Octave(...):\n    ....\n\noctave = Octave()\n```\nWhen combined with `from .octave import Octave, octave` in `sage/interfaces/all.py`, this means that an instance of `Octave` is created when Sage starts up. I think we should avoid this with lazy imports.\n\n\nDepends on #16522\n\nComponent: **interfaces**\n\nAuthor: **John Palmieri**\n\nBranch: **[`09f5d92`](https://github.com/sagemath/sagetrac-mirror/commit/09f5d9205f3eeab7e89309f453e803d8e996b918)**\n\nReviewer: **Matthias Koeppe**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/34547_\n\n",
    "closed_at": "2023-01-05T23:16:50Z",
    "created_at": "2022-09-16T22:38:07Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Interfaces: use more lazy imports, restore top-level functions maxima_console etc.",
    "type": "issue",
    "updated_at": "2023-01-24T23:11:47Z",
    "url": "https://github.com/sagemath/sage/issues/34547",
    "user": "https://github.com/jhpalmieri"
}
```
<div id="comment:0"></div>

Various files in `sage/interfaces/` have this pattern:

```
class Octave(...):
    ....

octave = Octave()
```
When combined with `from .octave import Octave, octave` in `sage/interfaces/all.py`, this means that an instance of `Octave` is created when Sage starts up. I think we should avoid this with lazy imports.


Depends on #16522

Component: **interfaces**

Author: **John Palmieri**

Branch: **[`09f5d92`](https://github.com/sagemath/sagetrac-mirror/commit/09f5d9205f3eeab7e89309f453e803d8e996b918)**

Reviewer: **Matthias Koeppe**

_Issue created by migration from https://trac.sagemath.org/ticket/34547_





---

archive/issue_events_469517.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-09-16T22:38:07Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469517"
}
```



---

archive/issue_events_469518.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-09-16T22:38:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
    "label_color": "0000ff",
    "label_name": "c: interfaces",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469518"
}
```



---

archive/issue_events_469519.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-09-16T22:38:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469519"
}
```



---

archive/issue_events_469520.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-09-16T22:38:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469520"
}
```



---

archive/issue_comments_558344.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\n+1",
    "created_at": "2022-09-16T22:50:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558344",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:1" align="right">comment:1</div>

+1



---

archive/issue_comments_558345.json:
```json
{
    "body": "Branch: **[u/jhpalmieri/lazy_imports_for_interfaces](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/lazy_imports_for_interfaces)**",
    "created_at": "2022-09-17T05:16:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558345",
    "user": "https://github.com/jhpalmieri"
}
```

Branch: **[u/jhpalmieri/lazy_imports_for_interfaces](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/lazy_imports_for_interfaces)**



---

archive/issue_comments_558346.json:
```json
{
    "body": "Commit: **[`b483758`](https://github.com/sagemath/sagetrac-mirror/commit/b483758c68fbed9625f16fe0a23e06ae4a7b1bf4)**",
    "created_at": "2022-09-17T05:18:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558346",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[`b483758`](https://github.com/sagemath/sagetrac-mirror/commit/b483758c68fbed9625f16fe0a23e06ae4a7b1bf4)**



---

archive/issue_comments_558347.json:
```json
{
    "body": "<div id=\"comment:3\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b483758c68fbed9625f16fe0a23e06ae4a7b1bf4\"><code>b483758</code></a></td><td><code>trac 34547: use lazy imports in much of sage.interfaces.all</code></td></tr></table>\n",
    "created_at": "2022-09-17T05:18:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558347",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:3"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b483758c68fbed9625f16fe0a23e06ae4a7b1bf4"><code>b483758</code></a></td><td><code>trac 34547: use lazy imports in much of sage.interfaces.all</code></td></tr></table>




---

archive/issue_events_469521.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-09-17T05:21:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469521"
}
```



---

archive/issue_comments_558348.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nHere is a first attempt. I'll mark it as ready for review, but I am certainly open to changes. If I made changes for the imports for `magma` and `polymake`, I got problems with pickling, so I have left those as they were before.",
    "created_at": "2022-09-17T05:21:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558348",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:4" align="right">comment:4</div>

Here is a first attempt. I'll mark it as ready for review, but I am certainly open to changes. If I made changes for the imports for `magma` and `polymake`, I got problems with pickling, so I have left those as they were before.



---

archive/issue_comments_558349.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nRegarding the change\n\n```\n-interfaces = ['gap', 'gap3', 'giac', 'gp', 'mathematica', 'gnuplot', \\\n-              'kash', 'magma', 'macaulay2', 'maple', 'maxima', \\\n-              'mathematica', 'mwrank', 'octave', 'r', \\\n-              'singular', 'sage0', 'sage']\n```\nDo we need to deprecate this before just removing it? I don't know what purpose it was supposed to serve, except perhaps it is the remnants of some old code that once looped through it.",
    "created_at": "2022-09-17T18:38:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558349",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:5" align="right">comment:5</div>

Regarding the change

```
-interfaces = ['gap', 'gap3', 'giac', 'gp', 'mathematica', 'gnuplot', \
-              'kash', 'magma', 'macaulay2', 'maple', 'maxima', \
-              'mathematica', 'mwrank', 'octave', 'r', \
-              'singular', 'sage0', 'sage']
```
Do we need to deprecate this before just removing it? I don't know what purpose it was supposed to serve, except perhaps it is the remnants of some old code that once looped through it.



---

archive/issue_comments_558350.json:
```json
{
    "body": "Changed commit from **[`b483758`](https://github.com/sagemath/sagetrac-mirror/commit/b483758c68fbed9625f16fe0a23e06ae4a7b1bf4)** to **[`250da03`](https://github.com/sagemath/sagetrac-mirror/commit/250da03c8602100d6df6b405e23ded5644bdc217)**",
    "created_at": "2022-09-17T18:42:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558350",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`b483758`](https://github.com/sagemath/sagetrac-mirror/commit/b483758c68fbed9625f16fe0a23e06ae4a7b1bf4)** to **[`250da03`](https://github.com/sagemath/sagetrac-mirror/commit/250da03c8602100d6df6b405e23ded5644bdc217)**



---

archive/issue_comments_558351.json:
```json
{
    "body": "<div id=\"comment:6\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/250da03c8602100d6df6b405e23ded5644bdc217\"><code>250da03</code></a></td><td><code>trac 34547: use lazy imports in much of sage.interfaces.all</code></td></tr></table>\n",
    "created_at": "2022-09-17T18:42:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558351",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:6"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/250da03c8602100d6df6b405e23ded5644bdc217"><code>250da03</code></a></td><td><code>trac 34547: use lazy imports in much of sage.interfaces.all</code></td></tr></table>




---

archive/issue_comments_558352.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -6,5 +6,5 @@\n \n octave = Octave()\n ```\n-When combined with `from .octave import Octave, octave` in sage/interfaces/all.py`, this means that an instance of `Octave` is created when Sage starts up. I think we should avoid this with lazy imports.\n+When combined with `from .octave import Octave, octave` in `sage/interfaces/all.py`, this means that an instance of `Octave` is created when Sage starts up. I think we should avoid this with lazy imports.\n \n``````\n",
    "created_at": "2022-09-17T18:45:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558352",
    "user": "https://github.com/jhpalmieri"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -6,5 +6,5 @@
 
 octave = Octave()
 ```
-When combined with `from .octave import Octave, octave` in sage/interfaces/all.py`, this means that an instance of `Octave` is created when Sage starts up. I think we should avoid this with lazy imports.
+When combined with `from .octave import Octave, octave` in `sage/interfaces/all.py`, this means that an instance of `Octave` is created when Sage starts up. I think we should avoid this with lazy imports.
 
``````




---

archive/issue_comments_558353.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nWhere do the \".all\" namespaces actually get used and for what? Are they just to trigger initialization of modules? Or do people use them to access symbols too? They certainly be *importing* symbols from them. Especially with lazy imports, that leads to undesirable side-effects (see e.g. #16522):\n\n```\nsage: type(maxima_calculus)\n<class 'sage.misc.lazy_import.LazyImport'>\nsage: type(sage.calculus.calculus.maxima)\n<class 'sage.misc.lazy_import.LazyImport'>\nsage: sage.calculus.calculus.maxima is maxima_calculus  # they are the same object\nTrue\nsage: maxima_calculus(1)\n1\nsage: type(maxima_calculus)\n<class 'sage.misc.lazy_import.LazyImport'>\nsage: type(sage.calculus.calculus.maxima)\n<class 'sage.interfaces.maxima_lib.MaximaLib'>\n```\nSo as you can see, we end up with a `LazyImport` object bound in two places. Calling it removes one of the shims but not the other (it can't! it doesn't have a reference to the relevant namespace!).\nThis object rebinding is only tried upon the first resolution of the lazy object, but it does mean that the shim in the wrong location stays in place (and these shims are not perfect replacements for their objects)\n\nThe delayed instantiation of interfaces is laudable but, as you can see, can introduce new problems. What *does* work is lazy importing the object *where you need it*, but I'm not so sure we need these objects at the 'all' level. Certainly the `from <...>.all import *` done in `sage.all` propagates this problem. The tool `clean_namespace` at [the branch at #16522](https://github.com/sagemath/sagetrac-mirror/commit/419e8cbcea8ddc94ea5740625656d1a9ec09b6ee) can clean it up after import ...",
    "created_at": "2022-09-18T01:51:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558353",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:8" align="right">comment:8</div>

Where do the ".all" namespaces actually get used and for what? Are they just to trigger initialization of modules? Or do people use them to access symbols too? They certainly be *importing* symbols from them. Especially with lazy imports, that leads to undesirable side-effects (see e.g. #16522):

```
sage: type(maxima_calculus)
<class 'sage.misc.lazy_import.LazyImport'>
sage: type(sage.calculus.calculus.maxima)
<class 'sage.misc.lazy_import.LazyImport'>
sage: sage.calculus.calculus.maxima is maxima_calculus  # they are the same object
True
sage: maxima_calculus(1)
1
sage: type(maxima_calculus)
<class 'sage.misc.lazy_import.LazyImport'>
sage: type(sage.calculus.calculus.maxima)
<class 'sage.interfaces.maxima_lib.MaximaLib'>
```
So as you can see, we end up with a `LazyImport` object bound in two places. Calling it removes one of the shims but not the other (it can't! it doesn't have a reference to the relevant namespace!).
This object rebinding is only tried upon the first resolution of the lazy object, but it does mean that the shim in the wrong location stays in place (and these shims are not perfect replacements for their objects)

The delayed instantiation of interfaces is laudable but, as you can see, can introduce new problems. What *does* work is lazy importing the object *where you need it*, but I'm not so sure we need these objects at the 'all' level. Certainly the `from <...>.all import *` done in `sage.all` propagates this problem. The tool `clean_namespace` at [the branch at #16522](https://github.com/sagemath/sagetrac-mirror/commit/419e8cbcea8ddc94ea5740625656d1a9ec09b6ee) can clean it up after import ...



---

archive/issue_comments_558354.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [Nils Bruin](#comment%3A8):\n> Where do the \".all\" namespaces actually get used and for what? Are they just to trigger initialization of modules? \n\n`sage.interfaces` is a namespace package, so we're getting rid of imports from `sage.interfaces.all` within the Sage library, see #34201. When this is done, all that will remain is the reimport into `sage.all`, to fill the interactive top level as the only purpose.",
    "created_at": "2022-09-18T04:01:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558354",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [Nils Bruin](#comment%3A8):
> Where do the ".all" namespaces actually get used and for what? Are they just to trigger initialization of modules? 

`sage.interfaces` is a namespace package, so we're getting rid of imports from `sage.interfaces.all` within the Sage library, see #34201. When this is done, all that will remain is the reimport into `sage.all`, to fill the interactive top level as the only purpose.



---

archive/issue_comments_558355.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nRight now, `git grep \"from.*interfaces.all.*import\" src/sage` only reveals the import in `sage.all`. There are a few matches for `git grep \"import.*interfaces.all\" src/sage`.",
    "created_at": "2022-09-18T05:40:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558355",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:10" align="right">comment:10</div>

Right now, `git grep "from.*interfaces.all.*import" src/sage` only reveals the import in `sage.all`. There are a few matches for `git grep "import.*interfaces.all" src/sage`.



---

archive/issue_comments_558356.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nMaybe we need to keep the one in `src/sage/repl/interface_magic.py`?",
    "created_at": "2022-09-18T05:43:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558356",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:11" align="right">comment:11</div>

Maybe we need to keep the one in `src/sage/repl/interface_magic.py`?



---

archive/issue_comments_558357.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [Matthias K\u00f6ppe](#comment%3A9):\n> Replying to [Nils Bruin](#comment%3A8):\n> > Where do the \".all\" namespaces actually get used and for what? Are they just to trigger initialization of modules? \n> \n> \n> `sage.interfaces` is a namespace package, so we're getting rid of imports from `sage.interfaces.all` within the Sage library, see #34201. When this is done, all that will remain is the reimport into `sage.all`, to fill the interactive top level as the only purpose.\n\nAh, OK, so our current infrastructure actually guarantees that `LazyImport`s in `sage.all` end up broken in the toplevel. Possible fixes would be to build the global namespace piecemeal and recreate appropriate `LazyImport` objects rather than just referencing them, or just do the copy and then clean them up with something like `clean_namespace` (see #16522). The latter is much easier to implement. It looks like cleaning `sage.all` and the toplevel namespace upon construction would give us a lot of benefit for relatively low effort.\n\nOne reason to ensure `LazyImport` shims don't stay lying around, especially at top level, is that documentation is only partially transparently reported. Compare:\n\n```\nsage: sage.calculus.calculus.maxima? # reports doc but with wrong type, signature, and source file\nsage: sage.calculus.calculus.maxima? # second time is OK\n```\n\nversus\n\n```\nsage: maxima_calculus? # never gets type, signature, and source file right\n```\n\nNote:\n\n```\nsage: maxima_calculus?? # finds source but is still missing type and signature\n```",
    "created_at": "2022-09-18T17:35:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558357",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [Matthias KÃ¶ppe](#comment%3A9):
> Replying to [Nils Bruin](#comment%3A8):
> > Where do the ".all" namespaces actually get used and for what? Are they just to trigger initialization of modules? 
> 
> 
> `sage.interfaces` is a namespace package, so we're getting rid of imports from `sage.interfaces.all` within the Sage library, see #34201. When this is done, all that will remain is the reimport into `sage.all`, to fill the interactive top level as the only purpose.

Ah, OK, so our current infrastructure actually guarantees that `LazyImport`s in `sage.all` end up broken in the toplevel. Possible fixes would be to build the global namespace piecemeal and recreate appropriate `LazyImport` objects rather than just referencing them, or just do the copy and then clean them up with something like `clean_namespace` (see #16522). The latter is much easier to implement. It looks like cleaning `sage.all` and the toplevel namespace upon construction would give us a lot of benefit for relatively low effort.

One reason to ensure `LazyImport` shims don't stay lying around, especially at top level, is that documentation is only partially transparently reported. Compare:

```
sage: sage.calculus.calculus.maxima? # reports doc but with wrong type, signature, and source file
sage: sage.calculus.calculus.maxima? # second time is OK
```

versus

```
sage: maxima_calculus? # never gets type, signature, and source file right
```

Note:

```
sage: maxima_calculus?? # finds source but is still missing type and signature
```



---

archive/issue_comments_558358.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [Nils Bruin](#comment%3A12):\n> so our current infrastructure actually guarantees that `LazyImport`s in `sage.all` end up broken in the toplevel. Possible fixes would be to [...] or just do the copy and then clean them up with something like `clean_namespace` (see #16522). The latter is much easier to implement. It looks like cleaning `sage.all` and the toplevel namespace upon construction would give us a lot of benefit for relatively low effort.\n\nThanks for the pointer to #16522. I haven't looked at the details, but this sounds promising.",
    "created_at": "2022-09-18T18:15:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558358",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [Nils Bruin](#comment%3A12):
> so our current infrastructure actually guarantees that `LazyImport`s in `sage.all` end up broken in the toplevel. Possible fixes would be to [...] or just do the copy and then clean them up with something like `clean_namespace` (see #16522). The latter is much easier to implement. It looks like cleaning `sage.all` and the toplevel namespace upon construction would give us a lot of benefit for relatively low effort.

Thanks for the pointer to #16522. I haven't looked at the details, but this sounds promising.



---

archive/issue_comments_558359.json:
```json
{
    "body": "<div id=\"comment:14\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9566546fec29409bb5d700275495720b224cfa01\"><code>9566546</code></a></td><td><code>trac 34547: remove two \"import sage.interfaces.all\" lines</code></td></tr></table>\n",
    "created_at": "2022-09-18T20:10:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558359",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:14"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9566546fec29409bb5d700275495720b224cfa01"><code>9566546</code></a></td><td><code>trac 34547: remove two "import sage.interfaces.all" lines</code></td></tr></table>




---

archive/issue_comments_558360.json:
```json
{
    "body": "Changed commit from **[`250da03`](https://github.com/sagemath/sagetrac-mirror/commit/250da03c8602100d6df6b405e23ded5644bdc217)** to **[`9566546`](https://github.com/sagemath/sagetrac-mirror/commit/9566546fec29409bb5d700275495720b224cfa01)**",
    "created_at": "2022-09-18T20:10:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558360",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`250da03`](https://github.com/sagemath/sagetrac-mirror/commit/250da03c8602100d6df6b405e23ded5644bdc217)** to **[`9566546`](https://github.com/sagemath/sagetrac-mirror/commit/9566546fec29409bb5d700275495720b224cfa01)**



---

archive/issue_comments_558361.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nIs this branch okay, or do we need to do something to accommodate #16522?",
    "created_at": "2022-12-03T22:07:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558361",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:15" align="right">comment:15</div>

Is this branch okay, or do we need to do something to accommodate #16522?



---

archive/issue_comments_558362.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nAre these changes:\n\n```\n--- a/src/sage/interfaces/axiom.py\n+++ b/src/sage/interfaces/axiom.py\n@@ -490,7 +490,7 @@ class Axiom(PanAxiom):\n         \"\"\"\n         EXAMPLES::\n \n-            sage: axiom.__reduce__()\n+            sage: Axiom().__reduce__()\n             (<function reduce_load_Axiom at 0x...>, ())\n```\nneeded because of #16522?",
    "created_at": "2022-12-05T19:06:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558362",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">comment:16</div>

Are these changes:

```
--- a/src/sage/interfaces/axiom.py
+++ b/src/sage/interfaces/axiom.py
@@ -490,7 +490,7 @@ class Axiom(PanAxiom):
         """
         EXAMPLES::
 
-            sage: axiom.__reduce__()
+            sage: Axiom().__reduce__()
             (<function reduce_load_Axiom at 0x...>, ())
```
needed because of #16522?



---

archive/issue_comments_558363.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nI see the following with this branch:\n\n```\nsage: axiom.__reduce__\n<built-in method __reduce__ of sage.misc.lazy_import.LazyImport object at 0x19a6991c0>\nsage: Axiom().__reduce__\n<bound method Axiom.__reduce__ of Axiom>\nsage: axiom.__reduce__()\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\nCell In [7], line 1\n----> 1 axiom.__reduce__()\n\nFile /usr/local/Cellar/python@3.10/3.10.8/Frameworks/Python.framework/Versions/3.10/lib/python3.10/copyreg.py:76, in _reduce_ex(self, proto)\n     74 else:\n     75     if base is cls:\n---> 76         raise TypeError(f\"cannot pickle {cls.__name__!r} object\")\n     77     state = base(self)\n     78 args = (cls, base, state)\n\nTypeError: cannot pickle 'LazyImport' object\nsage: Axiom().__reduce__()\n(<function reduce_load_Axiom at 0x19d557c70>, ())\n```\nI don't understand why this change is necessary.",
    "created_at": "2022-12-05T20:36:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558363",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:17" align="right">comment:17</div>

I see the following with this branch:

```
sage: axiom.__reduce__
<built-in method __reduce__ of sage.misc.lazy_import.LazyImport object at 0x19a6991c0>
sage: Axiom().__reduce__
<bound method Axiom.__reduce__ of Axiom>
sage: axiom.__reduce__()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
Cell In [7], line 1
----> 1 axiom.__reduce__()

File /usr/local/Cellar/python@3.10/3.10.8/Frameworks/Python.framework/Versions/3.10/lib/python3.10/copyreg.py:76, in _reduce_ex(self, proto)
     74 else:
     75     if base is cls:
---> 76         raise TypeError(f"cannot pickle {cls.__name__!r} object")
     77     state = base(self)
     78 args = (cls, base, state)

TypeError: cannot pickle 'LazyImport' object
sage: Axiom().__reduce__()
(<function reduce_load_Axiom at 0x19d557c70>, ())
```
I don't understand why this change is necessary.



---

archive/issue_comments_558364.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nMaybe it is #16522.",
    "created_at": "2022-12-05T20:37:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558364",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:18" align="right">comment:18</div>

Maybe it is #16522.



---

archive/issue_comments_558365.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nYes, I think this should be solved via #16522 instead of working around it in the doctests",
    "created_at": "2022-12-05T21:01:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558365",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:19" align="right">comment:19</div>

Yes, I think this should be solved via #16522 instead of working around it in the doctests



---

archive/issue_comments_558366.json:
```json
{
    "body": "Dependencies: **#16522**",
    "created_at": "2022-12-05T21:01:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558366",
    "user": "https://github.com/mkoeppe"
}
```

Dependencies: **#16522**



---

archive/issue_comments_558367.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI don't think #16522 will prevent this problem: I don't think special methods like `__reduce__`, which are present of `LazyImport` objects, trigger resolution. According to [https://docs.python.org/3/reference/datamodel.html#object.__getattr__](https://docs.python.org/3/reference/datamodel.html#object.__getattr__), the `__getattr__` method, which is the one `LazyImport` uses, only gets invoked when normal attribute lookup fails.\n\nThis is why most slot methods are separately wrapped to trigger resolution, because these would never fail.",
    "created_at": "2022-12-05T22:31:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558367",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:20" align="right">comment:20</div>

I don't think #16522 will prevent this problem: I don't think special methods like `__reduce__`, which are present of `LazyImport` objects, trigger resolution. According to [https://docs.python.org/3/reference/datamodel.html#object.__getattr__](https://docs.python.org/3/reference/datamodel.html#object.__getattr__), the `__getattr__` method, which is the one `LazyImport` uses, only gets invoked when normal attribute lookup fails.

This is why most slot methods are separately wrapped to trigger resolution, because these would never fail.



---

archive/issue_comments_558368.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nThe `__reduce__` doctests look pretty artificial. Would there be more meaningful ones that we could use as replacements?",
    "created_at": "2022-12-05T22:55:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558368",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:21" align="right">comment:21</div>

The `__reduce__` doctests look pretty artificial. Would there be more meaningful ones that we could use as replacements?



---

archive/issue_comments_558369.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nBy the way, an alternate approach to this ticket would be to remove the top-level imports of some of these packages altogether: make users explicitly import them when needed. Potentially affected packages, all from `src/interfaces`:\n- axiom\n- ecm\n- 4ti2\n- fricas\n- frobby\n- gap3\n- genus2reduction\n- gfan\n- giac (pexpect interface)\n- gnuplot\n- kash\n- lie\n- lisp\n- macaulay2\n- magma (not currently changed by this ticket)\n- magma_free\n- maple\n- mathematica\n- mathics\n- matlab\n- mupad\n- mwrank\n- octave\n- polymake (not currently changed by this ticket)\n- povray\n- psage\n- qepcad\n- qsieve\n- r\n- read_data\n- scilab\n- tachyon\nThese do not have to be treated all the same, of course.",
    "created_at": "2022-12-12T18:54:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558369",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:22" align="right">comment:22</div>

By the way, an alternate approach to this ticket would be to remove the top-level imports of some of these packages altogether: make users explicitly import them when needed. Potentially affected packages, all from `src/interfaces`:
- axiom
- ecm
- 4ti2
- fricas
- frobby
- gap3
- genus2reduction
- gfan
- giac (pexpect interface)
- gnuplot
- kash
- lie
- lisp
- macaulay2
- magma (not currently changed by this ticket)
- magma_free
- maple
- mathematica
- mathics
- matlab
- mupad
- mwrank
- octave
- polymake (not currently changed by this ticket)
- povray
- psage
- qepcad
- qsieve
- r
- read_data
- scilab
- tachyon
These do not have to be treated all the same, of course.



---

archive/issue_comments_558370.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [Nils Bruin](#comment%3A20):\n> I don't think #16522 will prevent this problem\n\nYou are right.",
    "created_at": "2022-12-18T20:53:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558370",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [Nils Bruin](#comment%3A20):
> I don't think #16522 will prevent this problem

You are right.



---

archive/issue_events_469522.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-18T20:54:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469522"
}
```



---

archive/issue_events_469523.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-18T20:54:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469523"
}
```



---

archive/issue_comments_558371.json:
```json
{
    "body": "Reviewer: **Matthias Koeppe**",
    "created_at": "2022-12-18T20:54:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558371",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **Matthias Koeppe**



---

archive/issue_comments_558372.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nLGTM.",
    "created_at": "2022-12-18T20:54:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558372",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:24" align="right">comment:24</div>

LGTM.



---

archive/issue_comments_558373.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nBut maybe we should also take care of these ones in the same ticket:\n\n```\n        from .axiom import axiom_console\n        from .fricas import fricas_console\n        from .gap import gap_console\n...\n```",
    "created_at": "2022-12-18T20:58:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558373",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:25" align="right">comment:25</div>

But maybe we should also take care of these ones in the same ticket:

```
        from .axiom import axiom_console
        from .fricas import fricas_console
        from .gap import gap_console
...
```



---

archive/issue_comments_558374.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nCan you explain when those imports are triggered? I see this with vanilla Sage:\n\n```\nsage: from sage.repl.rich_output.display_manager import get_display_manager as _get_display_manager\nsage: _get_display_manager().is_in_terminal()\nTrue\nsage: axiom_console()\n---------------------------------------------------------------------------\nNameError                                 Traceback (most recent call last)\nCell In [5], line 1\n----> 1 axiom_console()\n\nNameError: name 'axiom_console' is not defined\nsage: gap_console()\n---------------------------------------------------------------------------\nNameError                                 Traceback (most recent call last)\nCell In [7], line 1\n----> 1 gap_console()\n\nNameError: name 'gap_console' is not defined\n```",
    "created_at": "2022-12-19T02:37:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558374",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:26" align="right">comment:26</div>

Can you explain when those imports are triggered? I see this with vanilla Sage:

```
sage: from sage.repl.rich_output.display_manager import get_display_manager as _get_display_manager
sage: _get_display_manager().is_in_terminal()
True
sage: axiom_console()
---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)
Cell In [5], line 1
----> 1 axiom_console()

NameError: name 'axiom_console' is not defined
sage: gap_console()
---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)
Cell In [7], line 1
----> 1 gap_console()

NameError: name 'gap_console' is not defined
```



---

archive/issue_comments_558375.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nThey are supposed to be defined in terminal sessions. But they are missing already in 9.8.beta5",
    "created_at": "2022-12-19T06:55:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558375",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:27" align="right">comment:27</div>

They are supposed to be defined in terminal sessions. But they are missing already in 9.8.beta5



---

archive/issue_comments_558376.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nAt the time of importing the module, _get_display_manager() returns \"The Sage display manager using the simple backend simple\".",
    "created_at": "2022-12-19T07:03:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558376",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:28" align="right">comment:28</div>

At the time of importing the module, _get_display_manager() returns "The Sage display manager using the simple backend simple".



---

archive/issue_comments_558377.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nNot sure what change broke this; perhaps a recent upgrade ipython.\n\nI think we can just unconditionally lazy_import these functions",
    "created_at": "2022-12-19T07:19:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558377",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:29" align="right">comment:29</div>

Not sure what change broke this; perhaps a recent upgrade ipython.

I think we can just unconditionally lazy_import these functions



---

archive/issue_events_469524.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2022-12-19T17:57:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469524"
}
```



---

archive/issue_events_469525.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2022-12-19T17:57:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469525"
}
```



---

archive/issue_comments_558378.json:
```json
{
    "body": "<div id=\"comment:30\"></div>\n\nBranch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5f08ad805cd2563e109afc7bb96dd15319c58197\"><code>5f08ad8</code></a></td><td><code>trac 34547: use lazy imports in much of sage.interfaces.all</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5cdfa88b7300116ba01cd12f898dfd88f4d33009\"><code>5cdfa88</code></a></td><td><code>trac 34547: remove two \"import sage.interfaces.all\" lines</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4f0dc5149ac77aebaf8652898167ae5f05382b2b\"><code>4f0dc51</code></a></td><td><code>trac 34547: more lazy imports in interfaces/all.py</code></td></tr></table>\n",
    "created_at": "2022-12-19T17:57:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558378",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:30"></div>

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5f08ad805cd2563e109afc7bb96dd15319c58197"><code>5f08ad8</code></a></td><td><code>trac 34547: use lazy imports in much of sage.interfaces.all</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5cdfa88b7300116ba01cd12f898dfd88f4d33009"><code>5cdfa88</code></a></td><td><code>trac 34547: remove two "import sage.interfaces.all" lines</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4f0dc5149ac77aebaf8652898167ae5f05382b2b"><code>4f0dc51</code></a></td><td><code>trac 34547: more lazy imports in interfaces/all.py</code></td></tr></table>




---

archive/issue_comments_558379.json:
```json
{
    "body": "Changed commit from **[`9566546`](https://github.com/sagemath/sagetrac-mirror/commit/9566546fec29409bb5d700275495720b224cfa01)** to **[`4f0dc51`](https://github.com/sagemath/sagetrac-mirror/commit/4f0dc5149ac77aebaf8652898167ae5f05382b2b)**",
    "created_at": "2022-12-19T17:57:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558379",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`9566546`](https://github.com/sagemath/sagetrac-mirror/commit/9566546fec29409bb5d700275495720b224cfa01)** to **[`4f0dc51`](https://github.com/sagemath/sagetrac-mirror/commit/4f0dc5149ac77aebaf8652898167ae5f05382b2b)**



---

archive/issue_comments_558380.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nHere is a branch that lazily imports all of these. The other option would be just to delete them.",
    "created_at": "2022-12-19T18:02:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558380",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:31" align="right">comment:31</div>

Here is a branch that lazily imports all of these. The other option would be just to delete them.



---

archive/issue_comments_558381.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nThis is still conditionalizing these imports. I think we should just remove the test `if _get_display_manager().is_in_terminal()` and always lazy_import these bindings",
    "created_at": "2022-12-19T22:04:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558381",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:32" align="right">comment:32</div>

This is still conditionalizing these imports. I think we should just remove the test `if _get_display_manager().is_in_terminal()` and always lazy_import these bindings



---

archive/issue_comments_558382.json:
```json
{
    "body": "Changed commit from **[`4f0dc51`](https://github.com/sagemath/sagetrac-mirror/commit/4f0dc5149ac77aebaf8652898167ae5f05382b2b)** to **[`c1b3670`](https://github.com/sagemath/sagetrac-mirror/commit/c1b3670c593b2c22dd3099e1d2f6506c3cb3441e)**",
    "created_at": "2022-12-20T00:56:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558382",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`4f0dc51`](https://github.com/sagemath/sagetrac-mirror/commit/4f0dc5149ac77aebaf8652898167ae5f05382b2b)** to **[`c1b3670`](https://github.com/sagemath/sagetrac-mirror/commit/c1b3670c593b2c22dd3099e1d2f6506c3cb3441e)**



---

archive/issue_comments_558383.json:
```json
{
    "body": "<div id=\"comment:33\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c1b3670c593b2c22dd3099e1d2f6506c3cb3441e\"><code>c1b3670</code></a></td><td><code>trac 34547: unconditionally lazily import *_console</code></td></tr></table>\n",
    "created_at": "2022-12-20T00:56:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558383",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:33"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c1b3670c593b2c22dd3099e1d2f6506c3cb3441e"><code>c1b3670</code></a></td><td><code>trac 34547: unconditionally lazily import *_console</code></td></tr></table>




---

archive/issue_comments_558384.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nLet's try this.",
    "created_at": "2022-12-20T01:11:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558384",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:34" align="right">comment:34</div>

Let's try this.



---

archive/issue_events_469526.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-20T02:25:59Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "title_is": "Interfaces: use more lazy imports, restore top-level functions maxima_console etc.",
    "title_was": "Interface issues: should use more lazy imports",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469526"
}
```



---

archive/issue_events_469527.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-20T02:25:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469527"
}
```



---

archive/issue_events_469528.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-20T02:25:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469528"
}
```



---

archive/issue_comments_558385.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nThank you. The right place for these `*_console` imports is perhaps in `sage.all_cmdline`, but I can't get that to work.",
    "created_at": "2022-12-20T05:42:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558385",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:36" align="right">comment:36</div>

Thank you. The right place for these `*_console` imports is perhaps in `sage.all_cmdline`, but I can't get that to work.



---

archive/issue_comments_558386.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nNo, it works. Should I make that change?",
    "created_at": "2022-12-20T05:44:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558386",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:37" align="right">comment:37</div>

No, it works. Should I make that change?



---

archive/issue_events_469529.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-12-20T05:44:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469529"
}
```



---

archive/issue_events_469530.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-12-20T05:44:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469530"
}
```



---

archive/issue_comments_558387.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\n(Commands like `gap_console` do not work in the Jupyter notebook.)",
    "created_at": "2022-12-20T05:51:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558387",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:38" align="right">comment:38</div>

(Commands like `gap_console` do not work in the Jupyter notebook.)



---

archive/issue_comments_558388.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nYou may recall that lazy_import of non-function objects can lead to very unexpected outcomes. It may be the case that with these _console objects this is less problematic, because people will likely not be interested in its id or its hash (or its identity in general), but I think you need to have a good reason to use it anyway. Would much be lost if these _console objects were *not* available from `interfaces`?\n\nBy the way, note that the creation of the `Octave()` instance does *not* involve creating the process. That only happens once there's actually interaction with it. So it may well be that the cost of creating these console objects is actually pretty low. There may still be an argument to not create them by default, but I suspect the real reason for that is closer to a reason for not having these default instances in the first place.",
    "created_at": "2022-12-20T06:26:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558388",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:39" align="right">comment:39</div>

You may recall that lazy_import of non-function objects can lead to very unexpected outcomes. It may be the case that with these _console objects this is less problematic, because people will likely not be interested in its id or its hash (or its identity in general), but I think you need to have a good reason to use it anyway. Would much be lost if these _console objects were *not* available from `interfaces`?

By the way, note that the creation of the `Octave()` instance does *not* involve creating the process. That only happens once there's actually interaction with it. So it may well be that the cost of creating these console objects is actually pretty low. There may still be an argument to not create them by default, but I suspect the real reason for that is closer to a reason for not having these default instances in the first place.



---

archive/issue_comments_558389.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nMaybe I\u2019m misunderstanding, but aren\u2019t these `console` objects actually functions? So it should be okay to lazily import them. (I didn\u2019t check all of them, but all of the ones I checked are functions.)",
    "created_at": "2022-12-20T07:15:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558389",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:40" align="right">comment:40</div>

Maybe Iâm misunderstanding, but arenât these `console` objects actually functions? So it should be okay to lazily import them. (I didnât check all of them, but all of the ones I checked are functions.)



---

archive/issue_comments_558390.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nApologies, indeed, the \"*_console\" objects are just functions that, in the terminal, just starts a fresh process; as far as I can see simply as a \"subshell\": it just executes \"os.system(cmd)\". I think it's very rare current usage of sage would use that and it's easily replicated by other means, so I'd expect the \"*_console\" routines can just go.\n\nIn fact, as it stands, they are not available in my global namespace! So somehow:\n\n```\ntry:\n    from sage.repl.rich_output.display_manager import get_display_manager as _get_display_manager\nexcept ImportError:\n    pass\nelse:\n    if _get_display_manager().is_in_terminal():\n        [BLOCK]\n```\nmust have led to not executing [BLOCK], even though on the IPython command line `is_in_terminal` does return true and the import succeeds as well. Perhaps during initialization one of these things works differently?\n\nMy concern was for the interface objects themselves (the \"magma\" and \"octave\" instances): those are not just functions. They're actually instances of a quite complicated class. \nThey're obviously written to be quite light-weight (only initializing the expect interface if they're called) so you may want to do some timings to see if making them lazy actually saves anything measurable.",
    "created_at": "2022-12-20T19:30:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558390",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:41" align="right">comment:41</div>

Apologies, indeed, the "*_console" objects are just functions that, in the terminal, just starts a fresh process; as far as I can see simply as a "subshell": it just executes "os.system(cmd)". I think it's very rare current usage of sage would use that and it's easily replicated by other means, so I'd expect the "*_console" routines can just go.

In fact, as it stands, they are not available in my global namespace! So somehow:

```
try:
    from sage.repl.rich_output.display_manager import get_display_manager as _get_display_manager
except ImportError:
    pass
else:
    if _get_display_manager().is_in_terminal():
        [BLOCK]
```
must have led to not executing [BLOCK], even though on the IPython command line `is_in_terminal` does return true and the import succeeds as well. Perhaps during initialization one of these things works differently?

My concern was for the interface objects themselves (the "magma" and "octave" instances): those are not just functions. They're actually instances of a quite complicated class. 
They're obviously written to be quite light-weight (only initializing the expect interface if they're called) so you may want to do some timings to see if making them lazy actually saves anything measurable.



---

archive/issue_comments_558391.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nReplying to [John Palmieri](#comment%3A36):\n> The right place for these `*_console` imports is perhaps in `sage.all_cmdline`\n\nI think that's a good solution. \n\nI don't think we need to be concerned about use of these functions in user code that would try to import them from sage.interfaces.all.",
    "created_at": "2022-12-20T20:11:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558391",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:42" align="right">comment:42</div>

Replying to [John Palmieri](#comment%3A36):
> The right place for these `*_console` imports is perhaps in `sage.all_cmdline`

I think that's a good solution. 

I don't think we need to be concerned about use of these functions in user code that would try to import them from sage.interfaces.all.



---

archive/issue_comments_558392.json:
```json
{
    "body": "Changed commit from **[`c1b3670`](https://github.com/sagemath/sagetrac-mirror/commit/c1b3670c593b2c22dd3099e1d2f6506c3cb3441e)** to **[`70b7c44`](https://github.com/sagemath/sagetrac-mirror/commit/70b7c44492bf17587903609f4babe4212cf9f9af)**",
    "created_at": "2022-12-20T20:46:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558392",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`c1b3670`](https://github.com/sagemath/sagetrac-mirror/commit/c1b3670c593b2c22dd3099e1d2f6506c3cb3441e)** to **[`70b7c44`](https://github.com/sagemath/sagetrac-mirror/commit/70b7c44492bf17587903609f4babe4212cf9f9af)**



---

archive/issue_comments_558393.json:
```json
{
    "body": "<div id=\"comment:43\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/70b7c44492bf17587903609f4babe4212cf9f9af\"><code>70b7c44</code></a></td><td><code>trac 34547: unconditionally lazily import *_console and move the</code></td></tr></table>\n",
    "created_at": "2022-12-20T20:46:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558393",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:43"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/70b7c44492bf17587903609f4babe4212cf9f9af"><code>70b7c44</code></a></td><td><code>trac 34547: unconditionally lazily import *_console and move the</code></td></tr></table>




---

archive/issue_comments_558394.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nI have not been able to do any meaningful timings. I tried running `sage --startuptime` multiple times, and at first I saw faster times with the changes on this ticket, but as I repeated the timings, the differences seemed to go away (and `sage --startuptime` reported slightly longer times the more I ran it).",
    "created_at": "2022-12-20T20:50:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558394",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:44" align="right">comment:44</div>

I have not been able to do any meaningful timings. I tried running `sage --startuptime` multiple times, and at first I saw faster times with the changes on this ticket, but as I repeated the timings, the differences seemed to go away (and `sage --startuptime` reported slightly longer times the more I ran it).



---

archive/issue_events_469531.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-12-20T20:50:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469531"
}
```



---

archive/issue_events_469532.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-12-20T20:50:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469532"
}
```



---

archive/issue_comments_558395.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nI also wouldn't object to just removing the top-level imports for the `*_console` functions. I don't remember seeing any complaints about their being broken.",
    "created_at": "2022-12-20T21:30:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558395",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:45" align="right">comment:45</div>

I also wouldn't object to just removing the top-level imports for the `*_console` functions. I don't remember seeing any complaints about their being broken.



---

archive/issue_events_469533.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-20T22:08:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469533"
}
```



---

archive/issue_events_469534.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-20T22:08:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469534"
}
```



---

archive/issue_comments_558396.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nBuild & Test shows failures:\n\n```\nFile \"sage/misc/session.pyx\", line 12, in sage.misc.session\nFailed example:\n    show_identifiers()\nExpected:\n    ['w']\nGot:\n    ['axiom_console',\n     'fricas_console',\n     'gap3_console',\n     'gap_console',\n     'giac_console',\n     'gnuplot_console',\n     'gp_console',\n     'kash_console',\n     'lie_console',\n     'macaulay2_console',\n     'magma_console',\n     'maple_console',\n     'mathematica_console',\n     'mathics_console',\n     'matlab_console',\n     'maxima_console',\n     'mupad_console',\n     'mwrank_console',\n     'octave_console',\n     'pkg',\n     'qepcad_console',\n     'r_console',\n     'sage0_console',\n     'singular_console',\n     'w']\n```",
    "created_at": "2022-12-21T19:35:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558396",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:47" align="right">comment:47</div>

Build & Test shows failures:

```
File "sage/misc/session.pyx", line 12, in sage.misc.session
Failed example:
    show_identifiers()
Expected:
    ['w']
Got:
    ['axiom_console',
     'fricas_console',
     'gap3_console',
     'gap_console',
     'giac_console',
     'gnuplot_console',
     'gp_console',
     'kash_console',
     'lie_console',
     'macaulay2_console',
     'magma_console',
     'maple_console',
     'mathematica_console',
     'mathics_console',
     'matlab_console',
     'maxima_console',
     'mupad_console',
     'mwrank_console',
     'octave_console',
     'pkg',
     'qepcad_console',
     'r_console',
     'sage0_console',
     'singular_console',
     'w']
```



---

archive/issue_events_469535.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-21T19:35:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469535"
}
```



---

archive/issue_events_469536.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-21T19:35:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469536"
}
```



---

archive/issue_comments_558397.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nOne of the failures can be avoided by deleting the loop variable `pkg` at the end. For the others, should we change the doctests?",
    "created_at": "2022-12-21T21:42:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558397",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:48" align="right">comment:48</div>

One of the failures can be avoided by deleting the loop variable `pkg` at the end. For the others, should we change the doctests?



---

archive/issue_comments_558398.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nOh, I see, we can just move `sage.misc.session.init()` after the lazy imports.",
    "created_at": "2022-12-21T21:45:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558398",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:49" align="right">comment:49</div>

Oh, I see, we can just move `sage.misc.session.init()` after the lazy imports.



---

archive/issue_comments_558399.json:
```json
{
    "body": "<div id=\"comment:50\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/09f5d9205f3eeab7e89309f453e803d8e996b918\"><code>09f5d92</code></a></td><td><code>trac 34547: unconditionally lazily import *_console and move the</code></td></tr></table>\n",
    "created_at": "2022-12-21T23:46:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558399",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:50"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/09f5d9205f3eeab7e89309f453e803d8e996b918"><code>09f5d92</code></a></td><td><code>trac 34547: unconditionally lazily import *_console and move the</code></td></tr></table>




---

archive/issue_comments_558400.json:
```json
{
    "body": "Changed commit from **[`70b7c44`](https://github.com/sagemath/sagetrac-mirror/commit/70b7c44492bf17587903609f4babe4212cf9f9af)** to **[`09f5d92`](https://github.com/sagemath/sagetrac-mirror/commit/09f5d9205f3eeab7e89309f453e803d8e996b918)**",
    "created_at": "2022-12-21T23:46:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558400",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`70b7c44`](https://github.com/sagemath/sagetrac-mirror/commit/70b7c44492bf17587903609f4babe4212cf9f9af)** to **[`09f5d92`](https://github.com/sagemath/sagetrac-mirror/commit/09f5d9205f3eeab7e89309f453e803d8e996b918)**



---

archive/issue_events_469537.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-12-22T01:02:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469537"
}
```



---

archive/issue_events_469538.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2022-12-22T01:02:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469538"
}
```



---

archive/issue_comments_558401.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nThis works for me.",
    "created_at": "2022-12-22T01:02:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558401",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:51" align="right">comment:51</div>

This works for me.



---

archive/issue_events_469539.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-22T03:57:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469539"
}
```



---

archive/issue_events_469540.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-22T03:57:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469540"
}
```



---

archive/issue_events_469541.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2023-01-05T23:16:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469541"
}
```



---

archive/issue_events_469542.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "b0cc282500e8c6d5f5a1690fe07dacb6825c2b73",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2023-01-05T23:16:50Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34547#event-469542"
}
```



---

archive/issue_comments_558402.json:
```json
{
    "body": "Changed branch from **[u/jhpalmieri/lazy_imports_for_interfaces](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/lazy_imports_for_interfaces)** to **[`09f5d92`](https://github.com/sagemath/sagetrac-mirror/commit/09f5d9205f3eeab7e89309f453e803d8e996b918)**",
    "created_at": "2023-01-05T23:16:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558402",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jhpalmieri/lazy_imports_for_interfaces](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/lazy_imports_for_interfaces)** to **[`09f5d92`](https://github.com/sagemath/sagetrac-mirror/commit/09f5d9205f3eeab7e89309f453e803d8e996b918)**



---

archive/issue_comments_558403.json:
```json
{
    "body": "Changed commit from **[`09f5d92`](https://github.com/sagemath/sagetrac-mirror/commit/09f5d9205f3eeab7e89309f453e803d8e996b918)** to none",
    "created_at": "2023-01-20T21:57:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558403",
    "user": "https://github.com/jhpalmieri"
}
```

Changed commit from **[`09f5d92`](https://github.com/sagemath/sagetrac-mirror/commit/09f5d9205f3eeab7e89309f453e803d8e996b918)** to none



---

archive/issue_comments_558404.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nFollowup at #34927: a change to a doctest for `__reduce__` in fricas.py along the same lines as above. That doctest was marked as optional, which is why I didn't catch it before.",
    "created_at": "2023-01-20T21:57:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558404",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:54" align="right">comment:54</div>

Followup at #34927: a change to a doctest for `__reduce__` in fricas.py along the same lines as above. That doctest was marked as optional, which is why I didn't catch it before.



---

archive/issue_comments_558405.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">comment:55</div>\n\nMore issues: I have no idea why, but removing these lines from interfaces.all break the emacs sage-shell-mode:\n\n```\n-interfaces = ['gap', 'gap3', 'giac', 'gp', 'mathematica', 'gnuplot', \\\n-              'kash', 'magma', 'macaulay2', 'maple', 'maxima', \\\n-              'mathematica', 'mwrank', 'octave', 'r', \\\n-              'singular', 'sage0', 'sage']\n```\nIf I restore this, or if I just add a line `interfaces = []`, then it seems to work again. I am not going to open a ticket for this right now, in part because I'm busy with other things and in part because I have no idea what's going on.\n\nI thought that this might be related to `repl.interface_magic`, since that's a place that imports `all` from sage.interfaces.all, but I can't see why. However, the code in that file tries to register the various interfaces to create IPython magic commands like `%%gap`, and with the various new lazy imports, those interfaces are no longer registered. The now missing magic commands:\n\n```\n%%axiom\n%%fricas\n%%gap3\n%%giac\n%%kash\n%%lie\n%%lisp\n%%macaulay2\n%%maple\n%%mathematica\n%%mathics\n%%matlab\n%%mupad\n%%mwrank\n%%octave\n%%r\n```\nDo we care? Is it worth restoring these?",
    "created_at": "2023-01-24T22:21:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558405",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:55" align="right">comment:55</div>

More issues: I have no idea why, but removing these lines from interfaces.all break the emacs sage-shell-mode:

```
-interfaces = ['gap', 'gap3', 'giac', 'gp', 'mathematica', 'gnuplot', \
-              'kash', 'magma', 'macaulay2', 'maple', 'maxima', \
-              'mathematica', 'mwrank', 'octave', 'r', \
-              'singular', 'sage0', 'sage']
```
If I restore this, or if I just add a line `interfaces = []`, then it seems to work again. I am not going to open a ticket for this right now, in part because I'm busy with other things and in part because I have no idea what's going on.

I thought that this might be related to `repl.interface_magic`, since that's a place that imports `all` from sage.interfaces.all, but I can't see why. However, the code in that file tries to register the various interfaces to create IPython magic commands like `%%gap`, and with the various new lazy imports, those interfaces are no longer registered. The now missing magic commands:

```
%%axiom
%%fricas
%%gap3
%%giac
%%kash
%%lie
%%lisp
%%macaulay2
%%maple
%%mathematica
%%mathics
%%matlab
%%mupad
%%mwrank
%%octave
%%r
```
Do we care? Is it worth restoring these?



---

archive/issue_comments_558406.json:
```json
{
    "body": "<div id=\"comment:56\" align=\"right\">comment:56</div>\n\nThis line seems to refer to this global Sage variable -- https://github.com/sagemath/sage-shell-mode/blob/master/emacs_sage_shell.py#L55",
    "created_at": "2023-01-24T22:25:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558406",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:56" align="right">comment:56</div>

This line seems to refer to this global Sage variable -- https://github.com/sagemath/sage-shell-mode/blob/master/emacs_sage_shell.py#L55



---

archive/issue_comments_558407.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">comment:57</div>\n\nThank you for finding that. I do enjoy reading uncommented code...",
    "created_at": "2023-01-24T22:39:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558407",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:57" align="right">comment:57</div>

Thank you for finding that. I do enjoy reading uncommented code...



---

archive/issue_comments_558408.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">comment:58</div>\n\nThis variable is not used anywhere in the Sage library, as far as I can tell. I see three options:\n1. restore it just as it was before\n2. restore it and set it to a sensible value, probably asking the sage-shell people what that means\n3. let the sage-shell people set it in their own code to a sensible value\n\n1 is easiest. 2 makes more sense than 1, and 3 makes more sense than 2, at least to me. Unless we think that other people were also using this variable?",
    "created_at": "2023-01-24T22:42:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558408",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:58" align="right">comment:58</div>

This variable is not used anywhere in the Sage library, as far as I can tell. I see three options:
1. restore it just as it was before
2. restore it and set it to a sensible value, probably asking the sage-shell people what that means
3. let the sage-shell people set it in their own code to a sensible value

1 is easiest. 2 makes more sense than 1, and 3 makes more sense than 2, at least to me. Unless we think that other people were also using this variable?



---

archive/issue_comments_558409.json:
```json
{
    "body": "<div id=\"comment:59\" align=\"right\">comment:59</div>\n\nTo spell out the easy solution:\n\n```diff\ndiff --git a/src/sage/interfaces/all.py b/src/sage/interfaces/all.py\nindex 92e19e3d38..53cf7c92dd 100644\n--- a/src/sage/interfaces/all.py\n+++ b/src/sage/interfaces/all.py\n@@ -43,3 +43,9 @@ lazy_import('sage.interfaces.r', ['r', 'R', 'r_version'])\n lazy_import('sage.interfaces.read_data', 'read_data')\n lazy_import('sage.interfaces.scilab', 'scilab')\n lazy_import('sage.interfaces.tachyon', 'tachyon_rt')\n+\n+# The following variable is used by sage-shell-mode in emacs:\n+interfaces = ['gap', 'gap3', 'giac', 'gp', 'mathematica', 'gnuplot', \\\n+              'kash', 'magma', 'macaulay2', 'maple', 'maxima', \\\n+              'mathematica', 'mwrank', 'octave', 'r', \\\n+              'singular', 'sage0', 'sage']\n```",
    "created_at": "2023-01-24T22:49:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558409",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:59" align="right">comment:59</div>

To spell out the easy solution:

```diff
diff --git a/src/sage/interfaces/all.py b/src/sage/interfaces/all.py
index 92e19e3d38..53cf7c92dd 100644
--- a/src/sage/interfaces/all.py
+++ b/src/sage/interfaces/all.py
@@ -43,3 +43,9 @@ lazy_import('sage.interfaces.r', ['r', 'R', 'r_version'])
 lazy_import('sage.interfaces.read_data', 'read_data')
 lazy_import('sage.interfaces.scilab', 'scilab')
 lazy_import('sage.interfaces.tachyon', 'tachyon_rt')
+
+# The following variable is used by sage-shell-mode in emacs:
+interfaces = ['gap', 'gap3', 'giac', 'gp', 'mathematica', 'gnuplot', \
+              'kash', 'magma', 'macaulay2', 'maple', 'maxima', \
+              'mathematica', 'mwrank', 'octave', 'r', \
+              'singular', 'sage0', 'sage']
```



---

archive/issue_comments_558410.json:
```json
{
    "body": "<div id=\"comment:60\" align=\"right\">comment:60</div>\n\nYes, I think that's a good solution, at least for now.\nWe don't really have protocols for documenting and deprecating global variables, so we should probably accept that downstream code makes use of this variable.",
    "created_at": "2023-01-24T22:55:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558410",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:60" align="right">comment:60</div>

Yes, I think that's a good solution, at least for now.
We don't really have protocols for documenting and deprecating global variables, so we should probably accept that downstream code makes use of this variable.



---

archive/issue_comments_558411.json:
```json
{
    "body": "<div id=\"comment:61\" align=\"right\">comment:61</div>\n\nDone in #34935.",
    "created_at": "2023-01-24T23:11:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34547#issuecomment-558411",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:61" align="right">comment:61</div>

Done in #34935.
