# Issue 34915: Graph with G.num_verts() != len(G.vertices()) can be easily build

archive/issues_034678.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\nThe implementation of the Graph class can lead to situation where the number of vertices of a graph (as returned by the method `num_verts`) is different that the length of the list of vertices (as returned by the method `vertices`).\n\nSome examples below:\n\n```python\n  def foo (*args):\n     G = Graph()\n     for a in args:\n         G.add_vertex (a)\n     print (G.num_verts(), G.vertices(sort=False))\n\n  \n  foo (1.0, 1) # OK, prints 1 [1.00000000000000]\n  foo (1, 1.0) # Bug, prints 2 [1.00000000000000]\n```\n\n(Note that the first example is \"OK\" in the sense that the number of vertices reported corresponds to the length of the list of vertices, but from the point of view of the user, I would be tempted to call it a bug, but a different one)\n\nThe bug come from the fact that hash(1) == hash(1.0) and that the Graph class stores the vertices in a set or a dict. I was not able to understand why the order in which the vertices are added matter.\n\nCC:  @kliem\n\nComponent: **graph theory**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/34915_\n\n",
    "created_at": "2023-01-17T13:14:04Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20graph%20theory",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Graph with G.num_verts() != len(G.vertices()) can be easily build",
    "type": "issue",
    "updated_at": "2023-01-29T23:06:23Z",
    "url": "https://github.com/sagemath/sage/issues/34915",
    "user": "https://github.com/sagetrac-bouvier"
}
```
<div id="comment:0"></div>

The implementation of the Graph class can lead to situation where the number of vertices of a graph (as returned by the method `num_verts`) is different that the length of the list of vertices (as returned by the method `vertices`).

Some examples below:

```python
  def foo (*args):
     G = Graph()
     for a in args:
         G.add_vertex (a)
     print (G.num_verts(), G.vertices(sort=False))

  
  foo (1.0, 1) # OK, prints 1 [1.00000000000000]
  foo (1, 1.0) # Bug, prints 2 [1.00000000000000]
```

(Note that the first example is "OK" in the sense that the number of vertices reported corresponds to the length of the list of vertices, but from the point of view of the user, I would be tempted to call it a bug, but a different one)

The bug come from the fact that hash(1) == hash(1.0) and that the Graph class stores the vertices in a set or a dict. I was not able to understand why the order in which the vertices are added matter.

CC:  @kliem

Component: **graph theory**

_Issue created by migration from https://trac.sagemath.org/ticket/34915_





---

archive/issue_events_472879.json:
```json
{
    "actor": "https://github.com/sagetrac-bouvier",
    "created_at": "2023-01-17T13:14:04Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/34915",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34915#event-472879"
}
```



---

archive/issue_events_472880.json:
```json
{
    "actor": "https://github.com/sagetrac-bouvier",
    "created_at": "2023-01-17T13:14:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34915",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20graph%20theory",
    "label_color": "0000ff",
    "label_name": "c: graph theory",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34915#event-472880"
}
```



---

archive/issue_events_472881.json:
```json
{
    "actor": "https://github.com/sagetrac-bouvier",
    "created_at": "2023-01-17T13:14:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34915",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34915#event-472881"
}
```



---

archive/issue_events_472882.json:
```json
{
    "actor": "https://github.com/sagetrac-bouvier",
    "created_at": "2023-01-17T13:14:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34915",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34915#event-472882"
}
```



---

archive/issue_comments_562621.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nA minimal \"fix\" would be to document that vertex labels for a graph should be taken from a single parent. Equality and hashing generally does work as expected when restricted to a single parent.\n\nI don't know if it's doable/desirable to enforce this by requiring a parent to be selected for vertex labels.",
    "created_at": "2023-01-18T06:05:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34915#issuecomment-562621",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:1" align="right">comment:1</div>

A minimal "fix" would be to document that vertex labels for a graph should be taken from a single parent. Equality and hashing generally does work as expected when restricted to a single parent.

I don't know if it's doable/desirable to enforce this by requiring a parent to be selected for vertex labels.



---

archive/issue_comments_562622.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nThis issue is similar to #22374. This is due to some \"optimizations\" of the graph backends that should be removed.\nI assume these optimizations were somehow justified 15 years ago to work on very small graphs with vertex labels in 0..11 in order to avoid hashing vertex labels and so save some computation time. However, it makes the backends more complex to maintain and it causes some issues like the one reported in this ticket.",
    "created_at": "2023-01-19T16:26:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34915#issuecomment-562622",
    "user": "https://github.com/dcoudert"
}
```

<div id="comment:2" align="right">comment:2</div>

This issue is similar to #22374. This is due to some "optimizations" of the graph backends that should be removed.
I assume these optimizations were somehow justified 15 years ago to work on very small graphs with vertex labels in 0..11 in order to avoid hashing vertex labels and so save some computation time. However, it makes the backends more complex to maintain and it causes some issues like the one reported in this ticket.



---

archive/issue_events_472883.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2023-01-29T23:06:23Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/34915",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34915#event-472883"
}
```
