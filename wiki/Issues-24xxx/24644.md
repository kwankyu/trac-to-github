# Issue 24644: Use $SAGE_SUDO when copying files from SAGE_DESTDIR to SAGE_LOCAL

archive/issues_024407.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\nMinor followup to #24106, which didn't support the `SAGE_SUDO` variable properly.\n\nComponent: **build**\n\nAuthor: **Erik Bray**\n\nBranch/Commit: **[`5a23d19`](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)**\n\nReviewer: **Julian R\u00fcth**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/24644_\n\n",
    "closed_at": "2018-05-08T17:26:27Z",
    "created_at": "2018-02-02T12:02:13Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Use $SAGE_SUDO when copying files from SAGE_DESTDIR to SAGE_LOCAL",
    "type": "issue",
    "updated_at": "2018-05-08T17:26:27Z",
    "url": "https://github.com/sagemath/sage/issues/24644",
    "user": "https://github.com/embray"
}
```
<div id="comment:0"></div>

Minor followup to #24106, which didn't support the `SAGE_SUDO` variable properly.

Component: **build**

Author: **Erik Bray**

Branch/Commit: **[`5a23d19`](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)**

Reviewer: **Julian Rüth**

_Issue created by migration from https://trac.sagemath.org/ticket/24644_





---

archive/issue_events_338444.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:02:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338444"
}
```



---

archive/issue_events_338445.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:02:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "0000b0",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338445"
}
```



---

archive/issue_events_338446.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:02:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338446"
}
```



---

archive/issue_events_338447.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:02:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338447"
}
```



---

archive/issue_events_338448.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:02:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338448"
}
```



---

archive/issue_comments_373764.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e\"><code>56b9905</code></a></td><td><code>Don't use SAGE_SUDO in these helpers if SAGE_DESTDIR is set</code></td></tr></table>\n",
    "created_at": "2018-02-02T12:11:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-373764",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:2"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e"><code>56b9905</code></a></td><td><code>Don't use SAGE_SUDO in these helpers if SAGE_DESTDIR is set</code></td></tr></table>




---

archive/issue_comments_373765.json:
```json
{
    "body": "Changed commit from **[`45127cb`](https://github.com/sagemath/sagetrac-mirror/commit/45127cba14768900e1da138252664ba8cc71024c)** to **[`56b9905`](https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e)**",
    "created_at": "2018-02-02T12:11:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-373765",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`45127cb`](https://github.com/sagemath/sagetrac-mirror/commit/45127cba14768900e1da138252664ba8cc71024c)** to **[`56b9905`](https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e)**



---

archive/issue_events_338449.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:20:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338449"
}
```



---

archive/issue_events_338450.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:20:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338450"
}
```



---

archive/issue_comments_373766.json:
```json
{
    "body": "<div id=\"comment:4\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6\"><code>5a23d19</code></a></td><td><code>Don't use SAGE_SUDO in these helpers if SAGE_DESTDIR is set</code></td></tr></table>\n",
    "created_at": "2018-02-02T12:23:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-373766",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:4"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6"><code>5a23d19</code></a></td><td><code>Don't use SAGE_SUDO in these helpers if SAGE_DESTDIR is set</code></td></tr></table>




---

archive/issue_comments_373767.json:
```json
{
    "body": "Changed commit from **[`56b9905`](https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e)** to **[`5a23d19`](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)**",
    "created_at": "2018-02-02T12:23:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-373767",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`56b9905`](https://github.com/sagemath/sagetrac-mirror/commit/56b9905bc57b4f038653c17e8105a846a75d044e)** to **[`5a23d19`](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)**



---

archive/issue_comments_373768.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\n(I was doing some JavaScript earlier and got some wires crossed)",
    "created_at": "2018-02-02T12:24:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-373768",
    "user": "https://github.com/embray"
}
```

<div id="comment:5" align="right">comment:5</div>

(I was doing some JavaScript earlier and got some wires crossed)



---

archive/issue_events_338451.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:24:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338451"
}
```



---

archive/issue_events_338452.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-02-02T12:24:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338452"
}
```



---

archive/issue_events_338453.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-03T09:14:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338453"
}
```



---

archive/issue_events_338454.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-02-03T09:14:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338454"
}
```



---

archive/issue_comments_373769.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nIf this is really meant for installations as \"root\", then the installation in `DESTDIR` should already be done under the \"sudo\" user. So I think that this patch actually reverses existing correct behaviour.\n\n=> Proposal: close as wontfix.",
    "created_at": "2018-02-03T09:14:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-373769",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:7" align="right">comment:7</div>

If this is really meant for installations as "root", then the installation in `DESTDIR` should already be done under the "sudo" user. So I think that this patch actually reverses existing correct behaviour.

=> Proposal: close as wontfix.



---

archive/issue_comments_373770.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nNo, I was wrong: we should keep `SAGE_SUDO` for the `DESTDIR` installation and then also add it for moving the files to `SAGE_LOCAL`.",
    "created_at": "2018-02-03T09:29:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-373770",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:8" align="right">comment:8</div>

No, I was wrong: we should keep `SAGE_SUDO` for the `DESTDIR` installation and then also add it for moving the files to `SAGE_LOCAL`.



---

archive/issue_comments_373771.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI'm not sure about that.  In the staged installation, the install to `DESTDIR` step should be treated as a \"build\" step, and doesn't need to have root privileges to run.  I don't know what makes you think it should be done as root.\n\nOn Debian, fakeroot is provided and I believe install to the `DESTDIR` is done using fakeroot.  But in Debian's case that's because it's being used to build binary tarballs, and you want the files in the resulting tarball to be owned by \"root\" (but fakeroot allows you to do this without *actually* having to gain root privileges on the system you're building on).  For Sage's purposes this isn't necessary because we're not building binary tarballs--at least for now it's just a step needed for easily building a file manifest.\n\nSo only the actual install into `SAGE_LOCAL` should be done with elevated privileges, if any.",
    "created_at": "2018-02-05T10:33:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-373771",
    "user": "https://github.com/embray"
}
```

<div id="comment:9" align="right">comment:9</div>

I'm not sure about that.  In the staged installation, the install to `DESTDIR` step should be treated as a "build" step, and doesn't need to have root privileges to run.  I don't know what makes you think it should be done as root.

On Debian, fakeroot is provided and I believe install to the `DESTDIR` is done using fakeroot.  But in Debian's case that's because it's being used to build binary tarballs, and you want the files in the resulting tarball to be owned by "root" (but fakeroot allows you to do this without *actually* having to gain root privileges on the system you're building on).  For Sage's purposes this isn't necessary because we're not building binary tarballs--at least for now it's just a step needed for easily building a file manifest.

So only the actual install into `SAGE_LOCAL` should be done with elevated privileges, if any.



---

archive/issue_comments_373772.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nWell, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.\n\nBut if you run `sudo ./configure` (which really, you shouldn't have to in the first place) it fails because of `AC_CHECK_ROOT`.",
    "created_at": "2018-02-05T12:47:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-373772",
    "user": "https://github.com/embray"
}
```

<div id="comment:10" align="right">comment:10</div>

Well, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.

But if you run `sudo ./configure` (which really, you shouldn't have to in the first place) it fails because of `AC_CHECK_ROOT`.



---

archive/issue_comments_373773.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@embray](#comment%3A10):\n> Well, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.\n\nThis is addressed by #21532.",
    "created_at": "2018-03-05T23:15:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-373773",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@embray](#comment%3A10):
> Well, it looks like maybe there are some other problems with root installs.  For example, if you try to run something like `./configure --prefix=/opt/sage` where `/opt/sage` is owned by root, it will fail because the `configure` script tries to create some directories under `$SAGE_LOCAL`.

This is addressed by #21532.



---

archive/issue_events_338455.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-05T10:24:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338455"
}
```



---

archive/issue_events_338456.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-05T10:24:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338456"
}
```



---

archive/issue_comments_373774.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nLatest patchbot shows one failure due to the banner issue (#25056) but otherwise ths should be good I think.  I think this approach really makes the most sense for the time being.",
    "created_at": "2018-04-10T16:26:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-373774",
    "user": "https://github.com/embray"
}
```

<div id="comment:13" align="right">comment:13</div>

Latest patchbot shows one failure due to the banner issue (#25056) but otherwise ths should be good I think.  I think this approach really makes the most sense for the time being.



---

archive/issue_comments_373775.json:
```json
{
    "body": "Reviewer: **Julian R\u00fcth**",
    "created_at": "2018-04-10T22:49:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-373775",
    "user": "https://github.com/saraedum"
}
```

Reviewer: **Julian Rüth**



---

archive/issue_events_338457.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-10T22:49:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338457"
}
```



---

archive/issue_events_338458.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-10T22:49:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338458"
}
```



---

archive/issue_events_338459.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338459"
}
```



---

archive/issue_events_338460.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "milestone_number": null,
    "milestone_title": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338460"
}
```



---

archive/issue_comments_373776.json:
```json
{
    "body": "Changed branch from **[u/embray/build/destdir-sudo](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/destdir-sudo)** to **[`5a23d19`](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)**",
    "created_at": "2018-05-08T17:26:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/24644#issuecomment-373776",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/embray/build/destdir-sudo](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/destdir-sudo)** to **[`5a23d19`](https://github.com/sagemath/sagetrac-mirror/commit/5a23d19e72159e4231e1b1a6391b7e9ec04cd1c6)**



---

archive/issue_events_338461.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-08T17:26:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338461"
}
```



---

archive/issue_events_338462.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "68e8076fccc978767d7f4d60c3df7de78bb46474",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-05-08T17:26:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/24644",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/24644#event-338462"
}
```
