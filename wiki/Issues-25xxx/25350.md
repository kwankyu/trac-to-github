# Issue 25350: trivial cases of operations in ℤ[x]

archive/issues_025113.json:
```json
{
    "body": "\n\n**Branch/Commit:** [f5e81d65d1a1778a56f3e5126e8d2c59cc49f542](https://github.com/sagemath/sagetrac-mirror/commit/f5e81d65d1a1778a56f3e5126e8d2c59cc49f542)\n\n**Reviewer:** Travis Scrimshaw\n\n**Author:** Marc Mezzarobba\n\nIssue created by migration from https://trac.sagemath.org/ticket/25350\n\n",
    "closed_at": "2018-05-18T17:48:52Z",
    "created_at": "2018-05-11T19:26:44Z",
    "labels": [
        "component: basic arithmetic",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.3",
    "title": "trivial cases of operations in \u2124[x]",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/25350",
    "user": "https://github.com/mezzarobba"
}
```


**Branch/Commit:** [f5e81d65d1a1778a56f3e5126e8d2c59cc49f542](https://github.com/sagemath/sagetrac-mirror/commit/f5e81d65d1a1778a56f3e5126e8d2c59cc49f542)

**Reviewer:** Travis Scrimshaw

**Author:** Marc Mezzarobba

Issue created by migration from https://trac.sagemath.org/ticket/25350





---

archive/issue_comments_390285.json:
```json
{
    "body": "<a id='comment:1'></a>\nSimilar to #25349, more debatable since trivial operations with flint polynomials are reasonably fast, but, in my use cases at least, handling these special cases without creating temporary objects is faster.\n\n(I considered changing the conversion into the parent to a coercion as it should be, but I didn't do it on this ticket for fear of breaking existing code. In particular, `gcd()` currently accepts fractions with denominator one...)",
    "created_at": "2018-05-11T19:30:29Z",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25350#issuecomment-390285",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:1'></a>
Similar to #25349, more debatable since trivial operations with flint polynomials are reasonably fast, but, in my use cases at least, handling these special cases without creating temporary objects is faster.

(I considered changing the conversion into the parent to a coercion as it should be, but I didn't do it on this ticket for fear of breaking existing code. In particular, `gcd()` currently accepts fractions with denominator one...)



---

archive/issue_comments_390286.json:
```json
{
    "body": "<a id='comment:2'></a>\nSo by my understanding, this test is now stronger than before:\n\n```diff\n-            if right in ZZ:\n-                sig_on()\n-                fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,\n-                        (<Integer>ZZ(right)).value)\n-                sig_off()\n-                return res\n-        if self._parent is not right.parent():\n-            right = self._parent(right)\n-        sig_on()\n-        fmpz_poly_div(res.__poly, self.__poly,\n-                (<Polynomial_integer_dense_flint>right).__poly)\n-        sig_off()\n-        return res\n+            if isinstance(right, Integer):\n+                if (<Integer> right).is_zero():\n+                    raise ZeroDivisionError(\"division by zero\")\n+                else:\n+                    res = self._new()\n+                    sig_on()\n+                    fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,\n+                            (<Integer>ZZ(right)).value)\n+                    sig_off()\n+                    return res\n+            else:\n+                right = self._parent(right)\n```\nHence, you get a slowdown:\n\n```\nsage: R.<x> = ZZ[]\nsage: %timeit (x^2 + 13*x + 169) // QQ(13)\nThe slowest run took 86.24 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 6.97 \u00b5s per loop\n```\nvs 8.3.beta0:\n\n```\nsage: %timeit (x^2 + 13*x + 169) // QQ(13)\nThe slowest run took 174.81 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 3.06 \u00b5s per loop\n```\nThe reason is it converts `QQ -> ZZ['x']` and then does the `floordiv`. This is likely common because if you do, e.g., `4/2` instead of `4//2`, you get something in `QQ`. Plus the extra `ZZ` conversion in your new test is unnecessary. I would instead do:\n\n```python\n            if isinstance(right, Integer):\n                if (<Integer> right).is_zero():\n                    raise ZeroDivisionError(\"division by zero\")\n                else:\n                    res = self._new()\n                    sig_on()\n                    fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,\n                            (<Integer> right).value)\n                    sig_off()\n                    return res\n            elif right in ZZ:\n                res = self._new()\n                sig_on()\n                fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,\n                        (<Integer>ZZ(right)).value)\n                sig_off()\n                return res\n            else:\n                right = self._parent(right)\n```",
    "created_at": "2018-05-11T22:21:59Z",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25350#issuecomment-390286",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:2'></a>
So by my understanding, this test is now stronger than before:

```diff
-            if right in ZZ:
-                sig_on()
-                fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,
-                        (<Integer>ZZ(right)).value)
-                sig_off()
-                return res
-        if self._parent is not right.parent():
-            right = self._parent(right)
-        sig_on()
-        fmpz_poly_div(res.__poly, self.__poly,
-                (<Polynomial_integer_dense_flint>right).__poly)
-        sig_off()
-        return res
+            if isinstance(right, Integer):
+                if (<Integer> right).is_zero():
+                    raise ZeroDivisionError("division by zero")
+                else:
+                    res = self._new()
+                    sig_on()
+                    fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,
+                            (<Integer>ZZ(right)).value)
+                    sig_off()
+                    return res
+            else:
+                right = self._parent(right)
```
Hence, you get a slowdown:

```
sage: R.<x> = ZZ[]
sage: %timeit (x^2 + 13*x + 169) // QQ(13)
The slowest run took 86.24 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 6.97 µs per loop
```
vs 8.3.beta0:

```
sage: %timeit (x^2 + 13*x + 169) // QQ(13)
The slowest run took 174.81 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 3.06 µs per loop
```
The reason is it converts `QQ -> ZZ['x']` and then does the `floordiv`. This is likely common because if you do, e.g., `4/2` instead of `4//2`, you get something in `QQ`. Plus the extra `ZZ` conversion in your new test is unnecessary. I would instead do:

```python
            if isinstance(right, Integer):
                if (<Integer> right).is_zero():
                    raise ZeroDivisionError("division by zero")
                else:
                    res = self._new()
                    sig_on()
                    fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,
                            (<Integer> right).value)
                    sig_off()
                    return res
            elif right in ZZ:
                res = self._new()
                sig_on()
                fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,
                        (<Integer>ZZ(right)).value)
                sig_off()
                return res
            else:
                right = self._parent(right)
```



---

archive/issue_comments_390287.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [@tscrim](#comment%3A2):\n> So by my understanding, this test is now stronger than before:\n\nIndeed. It was intentional (not the Right Way \u21d2 no point in making it fast)... but I didn't think of that:\n\n> This is likely common because if you do, e.g., `4/2` instead of `4//2`, you get something in `QQ`.\n\nand I'm open to reverting the change.\n\n> Plus the extra `ZZ` conversion in your new test is unnecessary.\n\nThat was an oversight, thanks!",
    "created_at": "2018-05-12T04:47:21Z",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25350#issuecomment-390287",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:3'></a>
Replying to [@tscrim](#comment%3A2):
> So by my understanding, this test is now stronger than before:

Indeed. It was intentional (not the Right Way ⇒ no point in making it fast)... but I didn't think of that:

> This is likely common because if you do, e.g., `4/2` instead of `4//2`, you get something in `QQ`.

and I'm open to reverting the change.

> Plus the extra `ZZ` conversion in your new test is unnecessary.

That was an oversight, thanks!



---

archive/issue_comments_390288.json:
```json
{
    "body": "**Changing commit** from \"[3cac92a7306a0a9c7d113c0fa5d8fa1d1884dc70](https://github.com/sagemath/sagetrac-mirror/commit/3cac92a7306a0a9c7d113c0fa5d8fa1d1884dc70)\" to \"[10b4af7e960ae25234198cb4f732042f6aa175df](https://github.com/sagemath/sagetrac-mirror/commit/10b4af7e960ae25234198cb4f732042f6aa175df)\".",
    "created_at": "2018-05-12T04:51:56Z",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25350#issuecomment-390288",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[3cac92a7306a0a9c7d113c0fa5d8fa1d1884dc70](https://github.com/sagemath/sagetrac-mirror/commit/3cac92a7306a0a9c7d113c0fa5d8fa1d1884dc70)" to "[10b4af7e960ae25234198cb4f732042f6aa175df](https://github.com/sagemath/sagetrac-mirror/commit/10b4af7e960ae25234198cb4f732042f6aa175df)".



---

archive/issue_comments_390289.json:
```json
{
    "body": "<a id='comment:4'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/10b4af7e960ae25234198cb4f732042f6aa175df\">10b4af7</a></td><td><code>trivial cases of // and gcd over ZZ[x]</code></td></tr></table>\n",
    "created_at": "2018-05-12T04:51:56Z",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25350#issuecomment-390289",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/10b4af7e960ae25234198cb4f732042f6aa175df">10b4af7</a></td><td><code>trivial cases of // and gcd over ZZ[x]</code></td></tr></table>




---

archive/issue_comments_390290.json:
```json
{
    "body": "<a id='comment:5'></a>\nThis `(<Polynomial_integer_dense_flint>right)` would be better as `_right` given that you've already have the variable and done the typecast. That's all the comments I have (so if with that change, you set this to needs review, then you can set it to a positive review on my behalf).\n\nI was never suggesting to revert the change; just wanted the old faster code path to still be there.",
    "created_at": "2018-05-12T07:08:43Z",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25350#issuecomment-390290",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>
This `(<Polynomial_integer_dense_flint>right)` would be better as `_right` given that you've already have the variable and done the typecast. That's all the comments I have (so if with that change, you set this to needs review, then you can set it to a positive review on my behalf).

I was never suggesting to revert the change; just wanted the old faster code path to still be there.



---

archive/issue_comments_390291.json:
```json
{
    "body": "**Reviewer:** Travis Scrimshaw",
    "created_at": "2018-05-12T07:08:43Z",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25350#issuecomment-390291",
    "user": "https://github.com/tscrim"
}
```

**Reviewer:** Travis Scrimshaw



---

archive/issue_comments_390292.json:
```json
{
    "body": "<a id='comment:6'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1bde2663119905a6dd4f3b7894d7b1bb6ee9ea51\">1bde266</a></td><td><code>trivial cases of // and gcd over ZZ[x]</code></td></tr></table>\n",
    "created_at": "2018-05-12T10:54:57Z",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25350#issuecomment-390292",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1bde2663119905a6dd4f3b7894d7b1bb6ee9ea51">1bde266</a></td><td><code>trivial cases of // and gcd over ZZ[x]</code></td></tr></table>




---

archive/issue_comments_390293.json:
```json
{
    "body": "**Changing commit** from \"[10b4af7e960ae25234198cb4f732042f6aa175df](https://github.com/sagemath/sagetrac-mirror/commit/10b4af7e960ae25234198cb4f732042f6aa175df)\" to \"[1bde2663119905a6dd4f3b7894d7b1bb6ee9ea51](https://github.com/sagemath/sagetrac-mirror/commit/1bde2663119905a6dd4f3b7894d7b1bb6ee9ea51)\".",
    "created_at": "2018-05-12T10:54:57Z",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25350#issuecomment-390293",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[10b4af7e960ae25234198cb4f732042f6aa175df](https://github.com/sagemath/sagetrac-mirror/commit/10b4af7e960ae25234198cb4f732042f6aa175df)" to "[1bde2663119905a6dd4f3b7894d7b1bb6ee9ea51](https://github.com/sagemath/sagetrac-mirror/commit/1bde2663119905a6dd4f3b7894d7b1bb6ee9ea51)".



---

archive/issue_comments_390294.json:
```json
{
    "body": "<a id='comment:7'></a>\nOk, thanks again! (I'll wait for the patchbot to go green before setting it to positive review.)",
    "created_at": "2018-05-12T10:56:57Z",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25350#issuecomment-390294",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:7'></a>
Ok, thanks again! (I'll wait for the patchbot to go green before setting it to positive review.)



---

archive/issue_events_227075.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2018-05-12T10:56:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25350#event-227075"
}
```



---

archive/issue_events_227076.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-05-12T19:43:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25350#event-227076"
}
```



---

archive/issue_events_227077.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-05-12T19:43:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25350#event-227077"
}
```



---

archive/issue_comments_390295.json:
```json
{
    "body": "<a id='comment:8'></a>\nflint has a `fmpz_poly_is_one`.",
    "created_at": "2018-05-12T19:43:59Z",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25350#issuecomment-390295",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>
flint has a `fmpz_poly_is_one`.



---

archive/issue_comments_390296.json:
```json
{
    "body": "**Changing commit** from \"[1bde2663119905a6dd4f3b7894d7b1bb6ee9ea51](https://github.com/sagemath/sagetrac-mirror/commit/1bde2663119905a6dd4f3b7894d7b1bb6ee9ea51)\" to \"[f5e81d65d1a1778a56f3e5126e8d2c59cc49f542](https://github.com/sagemath/sagetrac-mirror/commit/f5e81d65d1a1778a56f3e5126e8d2c59cc49f542)\".",
    "created_at": "2018-05-14T10:45:48Z",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25350#issuecomment-390296",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[1bde2663119905a6dd4f3b7894d7b1bb6ee9ea51](https://github.com/sagemath/sagetrac-mirror/commit/1bde2663119905a6dd4f3b7894d7b1bb6ee9ea51)" to "[f5e81d65d1a1778a56f3e5126e8d2c59cc49f542](https://github.com/sagemath/sagetrac-mirror/commit/f5e81d65d1a1778a56f3e5126e8d2c59cc49f542)".



---

archive/issue_comments_390297.json:
```json
{
    "body": "<a id='comment:9'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f5e81d65d1a1778a56f3e5126e8d2c59cc49f542\">f5e81d6</a></td><td><code>trivial cases of // and gcd over ZZ[x]</code></td></tr></table>\n",
    "created_at": "2018-05-14T10:45:48Z",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25350#issuecomment-390297",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f5e81d65d1a1778a56f3e5126e8d2c59cc49f542">f5e81d6</a></td><td><code>trivial cases of // and gcd over ZZ[x]</code></td></tr></table>




---

archive/issue_events_227078.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2018-05-14T10:46:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25350#event-227078"
}
```



---

archive/issue_events_227079.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2018-05-14T10:46:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25350#event-227079"
}
```



---

archive/issue_events_227080.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-05-14T22:58:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25350#event-227080"
}
```



---

archive/issue_events_227081.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-05-14T22:58:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25350#event-227081"
}
```



---

archive/issue_events_227082.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-18T17:48:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25350#event-227082"
}
```



---

archive/issue_events_227083.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "6c8058f15ed133dd3be10743d63046893de0ec53",
    "created_at": "2018-05-18T17:48:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25350#event-227083"
}
```



---

archive/issue_comments_390298.json:
```json
{
    "body": "**Changing branch** from \"[u/mmezzarobba/fmpz_poly_trivial_cases](https://github.com/sagemath/sagetrac-mirror/tree/u/mmezzarobba/fmpz_poly_trivial_cases)\" to \"[f5e81d65d1a1778a56f3e5126e8d2c59cc49f542](https://github.com/sagemath/sagetrac-mirror/commit/f5e81d65d1a1778a56f3e5126e8d2c59cc49f542)\".",
    "created_at": "2018-05-18T17:48:52Z",
    "issue": "https://github.com/sagemath/sage/issues/25350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25350#issuecomment-390298",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/mmezzarobba/fmpz_poly_trivial_cases](https://github.com/sagemath/sagetrac-mirror/tree/u/mmezzarobba/fmpz_poly_trivial_cases)" to "[f5e81d65d1a1778a56f3e5126e8d2c59cc49f542](https://github.com/sagemath/sagetrac-mirror/commit/f5e81d65d1a1778a56f3e5126e8d2c59cc49f542)".
