# Issue 33572: sage -pytest

archive/issues_033335.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\nThin wrapper around `pytest` for running it in the Sage environment.\n\nas suggested in [#31924 comment:94](https://github.com/sagemath/sage/issues/31924#comment:94)\n\n\nSimilar to our existing wrapper `sage -tox`.\n\n\n\n\nCC:  @tornaria @tobiasdiez @soehms\n\nComponent: **doctest framework**\n\nAuthor: **Matthias Koeppe**\n\nBranch/Commit: **[`8825079`](https://github.com/sagemath/sagetrac-mirror/commit/8825079d65f07e9cf13bb3e65197d276a43b9591)**\n\nReviewer: **Tobias Diez**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/33572_\n\n",
    "closed_at": "2022-04-03T11:13:45Z",
    "created_at": "2022-03-26T18:39:31Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20doctest%20framework",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "sage -pytest",
    "type": "issue",
    "updated_at": "2022-04-03T11:13:45Z",
    "url": "https://github.com/sagemath/sage/issues/33572",
    "user": "https://github.com/mkoeppe"
}
```
<div id="comment:0"></div>

Thin wrapper around `pytest` for running it in the Sage environment.

as suggested in [#31924 comment:94](https://github.com/sagemath/sage/issues/31924#comment:94)


Similar to our existing wrapper `sage -tox`.




CC:  @tornaria @tobiasdiez @soehms

Component: **doctest framework**

Author: **Matthias Koeppe**

Branch/Commit: **[`8825079`](https://github.com/sagemath/sagetrac-mirror/commit/8825079d65f07e9cf13bb3e65197d276a43b9591)**

Reviewer: **Tobias Diez**

_Issue created by migration from https://trac.sagemath.org/ticket/33572_





---

archive/issue_events_458799.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-26T18:39:31Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458799"
}
```



---

archive/issue_events_458800.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-26T18:39:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20doctest%20framework",
    "label_color": "0000b0",
    "label_name": "c: doctest framework",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458800"
}
```



---

archive/issue_events_458801.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-26T18:39:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458801"
}
```



---

archive/issue_events_458802.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-26T18:39:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458802"
}
```



---

archive/issue_comments_542514.json:
```json
{
    "body": "Branch: **[u/mkoeppe/sage__pytest](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage__pytest)**",
    "created_at": "2022-03-26T19:03:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542514",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/sage__pytest](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage__pytest)**



---

archive/issue_comments_542515.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nHere's an attempt at this command, but I think I'll need some help here to make it actually work:\n\n```\n$ ./sage -pytest src/sage/numerical/\n============================================================================================================ test session starts ============================================================================================================\nplatform darwin -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0\nrootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini\ncollected 0 items / 5 errors                                                                                                                                                                                                                \n\n================================================================================================================== ERRORS ===================================================================================================================\n______________________________________________________________________________________ ERROR collecting sage/numerical/backends/cvxopt_backend_test.py ______________________________________________________________________________________\nImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/numerical/backends/cvxopt_backend_test.py'.\nHint: make sure your test modules/packages have valid Python names.\nTraceback:\nsrc/sage/numerical/backends/cvxopt_backend_test.py:5: in <module>\n    from sage.numerical.mip import MixedIntegerLinearProgram\nsage/numerical/mip.pyx:242: in init sage.numerical.mip\n    ???\nsage/rings/integer_ring.pyx:1: in init sage.rings.integer_ring\n    ???\nsage/rings/integer.pyx:1: in init sage.rings.integer\n    ???\nsage/rings/rational.pyx:79: in init sage.rings.rational\n    ???\nE   ImportError: cannot import name ZZ\n```\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/93855017ba6d46a7e83c289b29defc9e82a24d55\"><code>9385501</code></a></td><td><code>src/bin/sage: Implement 'sage --pytest'</code></td></tr></table>\n",
    "created_at": "2022-03-26T19:06:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542515",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:2" align="right">comment:2</div>

Here's an attempt at this command, but I think I'll need some help here to make it actually work:

```
$ ./sage -pytest src/sage/numerical/
============================================================================================================ test session starts ============================================================================================================
platform darwin -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0
rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini
collected 0 items / 5 errors                                                                                                                                                                                                                

================================================================================================================== ERRORS ===================================================================================================================
______________________________________________________________________________________ ERROR collecting sage/numerical/backends/cvxopt_backend_test.py ______________________________________________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/numerical/backends/cvxopt_backend_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
src/sage/numerical/backends/cvxopt_backend_test.py:5: in <module>
    from sage.numerical.mip import MixedIntegerLinearProgram
sage/numerical/mip.pyx:242: in init sage.numerical.mip
    ???
sage/rings/integer_ring.pyx:1: in init sage.rings.integer_ring
    ???
sage/rings/integer.pyx:1: in init sage.rings.integer
    ???
sage/rings/rational.pyx:79: in init sage.rings.rational
    ???
E   ImportError: cannot import name ZZ
```

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/93855017ba6d46a7e83c289b29defc9e82a24d55"><code>9385501</code></a></td><td><code>src/bin/sage: Implement 'sage --pytest'</code></td></tr></table>




---

archive/issue_comments_542516.json:
```json
{
    "body": "Changed author from **Matthias Koeppe** to **Matthias Koeppe, ...**",
    "created_at": "2022-03-26T19:06:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542516",
    "user": "https://github.com/mkoeppe"
}
```

Changed author from **Matthias Koeppe** to **Matthias Koeppe, ...**



---

archive/issue_comments_542517.json:
```json
{
    "body": "Commit: **[`9385501`](https://github.com/sagemath/sagetrac-mirror/commit/93855017ba6d46a7e83c289b29defc9e82a24d55)**",
    "created_at": "2022-03-26T19:06:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542517",
    "user": "https://github.com/mkoeppe"
}
```

Commit: **[`9385501`](https://github.com/sagemath/sagetrac-mirror/commit/93855017ba6d46a7e83c289b29defc9e82a24d55)**



---

archive/issue_comments_542518.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThat looks like a typical cyclic import that relies on `sage.all` to be broken. It is also not specific to pytest as the following example fails with the same error (when run through `./sage src/test_module_load.py`).\n\n```\nimport importlib.util\nspec = importlib.util.spec_from_file_location(\"module.name\", \"src/sage/numerical/backends/cvxopt_backend_test.py\")\nmodule = importlib.util.module_from_spec(spec)\nspec.loader.exec_module(module)\n```",
    "created_at": "2022-03-27T12:05:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542518",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:3" align="right">comment:3</div>

That looks like a typical cyclic import that relies on `sage.all` to be broken. It is also not specific to pytest as the following example fails with the same error (when run through `./sage src/test_module_load.py`).

```
import importlib.util
spec = importlib.util.spec_from_file_location("module.name", "src/sage/numerical/backends/cvxopt_backend_test.py")
module = importlib.util.module_from_spec(spec)
spec.loader.exec_module(module)
```



---

archive/issue_comments_542519.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nMoreover, there are a few dozens of such import errors:\n\n```\nimport importlib.util\nimport pathlib\nfor file in pathlib.Path().glob(\"src/sage/**/*.py\"):\n    try: \n        spec = importlib.util.spec_from_file_location(\"module.name\", file)\n        module = importlib.util.module_from_spec(spec)\n        spec.loader.exec_module(module)\n    except:\n        print(file)\n```",
    "created_at": "2022-03-27T12:15:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542519",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:4" align="right">comment:4</div>

Moreover, there are a few dozens of such import errors:

```
import importlib.util
import pathlib
for file in pathlib.Path().glob("src/sage/**/*.py"):
    try: 
        spec = importlib.util.spec_from_file_location("module.name", file)
        module = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(module)
    except:
        print(file)
```



---

archive/issue_comments_542520.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nCan't you just add `import sage.all` in `conftest.py`?",
    "created_at": "2022-03-27T15:07:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542520",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:5" align="right">comment:5</div>

Can't you just add `import sage.all` in `conftest.py`?



---

archive/issue_comments_542521.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nThere is already a hook which adds `sage.all`, but that one is only executed after the collection phase.",
    "created_at": "2022-03-27T15:17:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542521",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:6" align="right">comment:6</div>

There is already a hook which adds `sage.all`, but that one is only executed after the collection phase.



---

archive/issue_comments_542522.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/abbb61fd2cb99836ab37448326dab7e7e7f37fd7\"><code>abbb61f</code></a></td><td><code>src/conftest.py: import sage.all to avoid cyclic import errors</code></td></tr></table>\n",
    "created_at": "2022-03-27T15:42:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542522",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/abbb61fd2cb99836ab37448326dab7e7e7f37fd7"><code>abbb61f</code></a></td><td><code>src/conftest.py: import sage.all to avoid cyclic import errors</code></td></tr></table>




---

archive/issue_comments_542523.json:
```json
{
    "body": "Changed commit from **[`9385501`](https://github.com/sagemath/sagetrac-mirror/commit/93855017ba6d46a7e83c289b29defc9e82a24d55)** to **[`abbb61f`](https://github.com/sagemath/sagetrac-mirror/commit/abbb61fd2cb99836ab37448326dab7e7e7f37fd7)**",
    "created_at": "2022-03-27T15:42:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542523",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`9385501`](https://github.com/sagemath/sagetrac-mirror/commit/93855017ba6d46a7e83c289b29defc9e82a24d55)** to **[`abbb61f`](https://github.com/sagemath/sagetrac-mirror/commit/abbb61fd2cb99836ab37448326dab7e7e7f37fd7)**



---

archive/issue_events_458803.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-27T15:43:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458803"
}
```



---

archive/issue_comments_542524.json:
```json
{
    "body": "Changed author from **Matthias Koeppe, ...** to **Matthias Koeppe**",
    "created_at": "2022-03-27T15:43:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542524",
    "user": "https://github.com/mkoeppe"
}
```

Changed author from **Matthias Koeppe, ...** to **Matthias Koeppe**



---

archive/issue_events_458804.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-27T16:17:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458804"
}
```



---

archive/issue_events_458805.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-27T16:17:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458805"
}
```



---

archive/issue_comments_542525.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nAh that's what you had in mind. Seems to work indeed. Can you please add a comment that prevents pyright to complain about the unused import and add a link to #33580. Thanks!",
    "created_at": "2022-03-27T16:17:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542525",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:9" align="right">comment:9</div>

Ah that's what you had in mind. Seems to work indeed. Can you please add a comment that prevents pyright to complain about the unused import and add a link to #33580. Thanks!



---

archive/issue_comments_542526.json:
```json
{
    "body": "<div id=\"comment:10\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9bb72ea9ec314940f3c874d492de241fdec96548\"><code>9bb72ea</code></a></td><td><code>src/conftest.py: Add # type: ignore, add reference to trac ticket</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2c167045d66e049751876ddc755304940265c32a\"><code>2c16704</code></a></td><td><code>src/conftest.py: Remove outdated text</code></td></tr></table>\n",
    "created_at": "2022-03-27T16:32:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542526",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:10"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9bb72ea9ec314940f3c874d492de241fdec96548"><code>9bb72ea</code></a></td><td><code>src/conftest.py: Add # type: ignore, add reference to trac ticket</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2c167045d66e049751876ddc755304940265c32a"><code>2c16704</code></a></td><td><code>src/conftest.py: Remove outdated text</code></td></tr></table>




---

archive/issue_comments_542527.json:
```json
{
    "body": "Changed commit from **[`abbb61f`](https://github.com/sagemath/sagetrac-mirror/commit/abbb61fd2cb99836ab37448326dab7e7e7f37fd7)** to **[`2c16704`](https://github.com/sagemath/sagetrac-mirror/commit/2c167045d66e049751876ddc755304940265c32a)**",
    "created_at": "2022-03-27T16:32:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542527",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`abbb61f`](https://github.com/sagemath/sagetrac-mirror/commit/abbb61fd2cb99836ab37448326dab7e7e7f37fd7)** to **[`2c16704`](https://github.com/sagemath/sagetrac-mirror/commit/2c167045d66e049751876ddc755304940265c32a)**



---

archive/issue_events_458806.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-27T16:35:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458806"
}
```



---

archive/issue_events_458807.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-27T16:35:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458807"
}
```



---

archive/issue_events_458808.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-27T17:58:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458808"
}
```



---

archive/issue_events_458809.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-27T17:58:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458809"
}
```



---

archive/issue_comments_542528.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\n\n```\n$ ./sage -pytest\n========================================================================================================= test session starts ==========================================================================================================\nplatform linux -- Python 3.8.10, pytest-7.0.1, pluggy-1.0.0\nrootdir: /workspace/sagetrac-mirror/src\ncollected 0 items / 1 error                                                                                                                                                                                                            \n\n================================================================================================================ ERRORS ================================================================================================================\n____________________________________________________________________________________________________ ERROR collecting test session _____________________________________________________________________________________________________\nlocal/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/IPython/conftest.py:9: in <module>\n    from .testing import tools\nE   ModuleNotFoundError: No module named 'workspace'\n```\nshould probably fallback to `./sage -pytest src`",
    "created_at": "2022-03-27T17:58:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542528",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:12" align="right">comment:12</div>


```
$ ./sage -pytest
========================================================================================================= test session starts ==========================================================================================================
platform linux -- Python 3.8.10, pytest-7.0.1, pluggy-1.0.0
rootdir: /workspace/sagetrac-mirror/src
collected 0 items / 1 error                                                                                                                                                                                                            

================================================================================================================ ERRORS ================================================================================================================
____________________________________________________________________________________________________ ERROR collecting test session _____________________________________________________________________________________________________
local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/IPython/conftest.py:9: in <module>
    from .testing import tools
E   ModuleNotFoundError: No module named 'workspace'
```
should probably fallback to `./sage -pytest src`



---

archive/issue_comments_542529.json:
```json
{
    "body": "Changed commit from **[`2c16704`](https://github.com/sagemath/sagetrac-mirror/commit/2c167045d66e049751876ddc755304940265c32a)** to **[`30642ba`](https://github.com/sagemath/sagetrac-mirror/commit/30642ba190ae9a6a6090b11e51a317a2534028db)**",
    "created_at": "2022-03-27T18:20:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542529",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`2c16704`](https://github.com/sagemath/sagetrac-mirror/commit/2c167045d66e049751876ddc755304940265c32a)** to **[`30642ba`](https://github.com/sagemath/sagetrac-mirror/commit/30642ba190ae9a6a6090b11e51a317a2534028db)**



---

archive/issue_comments_542530.json:
```json
{
    "body": "<div id=\"comment:13\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/30642ba190ae9a6a6090b11e51a317a2534028db\"><code>30642ba</code></a></td><td><code>src/bin/sage: Handle 'sage -pytest' without file args</code></td></tr></table>\n",
    "created_at": "2022-03-27T18:20:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542530",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:13"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/30642ba190ae9a6a6090b11e51a317a2534028db"><code>30642ba</code></a></td><td><code>src/bin/sage: Handle 'sage -pytest' without file args</code></td></tr></table>




---

archive/issue_events_458810.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-27T18:20:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458810"
}
```



---

archive/issue_events_458811.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-27T18:20:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458811"
}
```



---

archive/issue_events_458812.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-27T19:10:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458812"
}
```



---

archive/issue_events_458813.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-27T19:10:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458813"
}
```



---

archive/issue_comments_542531.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nSeems to work, thanks!",
    "created_at": "2022-03-27T19:10:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542531",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:15" align="right">comment:15</div>

Seems to work, thanks!



---

archive/issue_comments_542532.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nThanks",
    "created_at": "2022-03-27T19:12:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542532",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">comment:16</div>

Thanks



---

archive/issue_comments_542533.json:
```json
{
    "body": "Reviewer: **Tobias Diez**",
    "created_at": "2022-03-27T19:12:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542533",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **Tobias Diez**



---

archive/issue_comments_542534.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nmerge conflict",
    "created_at": "2022-03-29T14:34:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542534",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:17" align="right">comment:17</div>

merge conflict



---

archive/issue_events_458814.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-29T14:34:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458814"
}
```



---

archive/issue_events_458815.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-29T14:34:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458815"
}
```



---

archive/issue_comments_542535.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nAnd while you are at it, can you please move the import mode cmd flag to `addopts = --import-mode importlib` in `tox.ini`. https://docs.pytest.org/en/6.2.x/customize.html#tox-ini Thanks!",
    "created_at": "2022-03-29T14:40:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542535",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:18" align="right">comment:18</div>

And while you are at it, can you please move the import mode cmd flag to `addopts = --import-mode importlib` in `tox.ini`. https://docs.pytest.org/en/6.2.x/customize.html#tox-ini Thanks!



---

archive/issue_comments_542536.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nWhile playing around, I've also discovered the following error:\n\n```\n$ ./sage --pytest src/sage/ext_data/nbconvert/postprocess.py\n========================================================================================================= test session starts ==========================================================================================================\nplatform linux -- Python 3.8.10, pytest-7.0.1, pluggy-1.0.0\nrootdir: /workspace/sagetrac-mirror/src, configfile: tox.ini\ncollected 0 items / 1 error                                                                                                                                                                                                            \n\n================================================================================================================ ERRORS ================================================================================================================\n_______________________________________________________________________________________ ERROR collecting sage/ext_data/nbconvert/postprocess.py ________________________________________________________________________________________\nsrc/sage/ext_data/nbconvert/postprocess.py:20: in <module>\n    with open(file_name, 'r') as f:\nE   FileNotFoundError: [Errno 2] No such file or directory: '--rootdir=/workspace/sagetrac-mirror/src'\n======================================================================================================= short test summary info ========================================================================================================\nERROR src/sage/ext_data/nbconvert/postprocess.py - FileNotFoundError: [Errno 2] No such file or directory: '--rootdir=/workspace/sagetrac-mirror/src'\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n=========================================================================================================== 1 error in 0.19s ===========================================================================================================\n```\nwhich seems to be introduced in this ticket.",
    "created_at": "2022-03-29T15:42:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542536",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:19" align="right">comment:19</div>

While playing around, I've also discovered the following error:

```
$ ./sage --pytest src/sage/ext_data/nbconvert/postprocess.py
========================================================================================================= test session starts ==========================================================================================================
platform linux -- Python 3.8.10, pytest-7.0.1, pluggy-1.0.0
rootdir: /workspace/sagetrac-mirror/src, configfile: tox.ini
collected 0 items / 1 error                                                                                                                                                                                                            

================================================================================================================ ERRORS ================================================================================================================
_______________________________________________________________________________________ ERROR collecting sage/ext_data/nbconvert/postprocess.py ________________________________________________________________________________________
src/sage/ext_data/nbconvert/postprocess.py:20: in <module>
    with open(file_name, 'r') as f:
E   FileNotFoundError: [Errno 2] No such file or directory: '--rootdir=/workspace/sagetrac-mirror/src'
======================================================================================================= short test summary info ========================================================================================================
ERROR src/sage/ext_data/nbconvert/postprocess.py - FileNotFoundError: [Errno 2] No such file or directory: '--rootdir=/workspace/sagetrac-mirror/src'
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
=========================================================================================================== 1 error in 0.19s ===========================================================================================================
```
which seems to be introduced in this ticket.



---

archive/issue_comments_542537.json:
```json
{
    "body": "<div id=\"comment:20\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1ab83b27cffeadcbb78b919390064714b735424d\"><code>1ab83b2</code></a></td><td><code>src/bin/sage: Implement 'sage --pytest'</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9036ca89cf11c8b249f7658aed65ee4305affebb\"><code>9036ca8</code></a></td><td><code>src/conftest.py: import sage.all to avoid cyclic import errors</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3c09949849e29992ac4bc3122cf51cfd8ad82511\"><code>3c09949</code></a></td><td><code>src/conftest.py: Add # type: ignore, add reference to trac ticket</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/07b5852d0b2e8b832599f3f3149893511a929c1c\"><code>07b5852</code></a></td><td><code>src/conftest.py: Remove outdated text</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f53bbc7afa99b2a0f727c79a3cfe780bb3aa8484\"><code>f53bbc7</code></a></td><td><code>src/bin/sage: Handle 'sage -pytest' without file args</code></td></tr></table>\n",
    "created_at": "2022-03-29T23:47:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542537",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1ab83b27cffeadcbb78b919390064714b735424d"><code>1ab83b2</code></a></td><td><code>src/bin/sage: Implement 'sage --pytest'</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9036ca89cf11c8b249f7658aed65ee4305affebb"><code>9036ca8</code></a></td><td><code>src/conftest.py: import sage.all to avoid cyclic import errors</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3c09949849e29992ac4bc3122cf51cfd8ad82511"><code>3c09949</code></a></td><td><code>src/conftest.py: Add # type: ignore, add reference to trac ticket</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/07b5852d0b2e8b832599f3f3149893511a929c1c"><code>07b5852</code></a></td><td><code>src/conftest.py: Remove outdated text</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f53bbc7afa99b2a0f727c79a3cfe780bb3aa8484"><code>f53bbc7</code></a></td><td><code>src/bin/sage: Handle 'sage -pytest' without file args</code></td></tr></table>




---

archive/issue_comments_542538.json:
```json
{
    "body": "Changed commit from **[`30642ba`](https://github.com/sagemath/sagetrac-mirror/commit/30642ba190ae9a6a6090b11e51a317a2534028db)** to **[`f53bbc7`](https://github.com/sagemath/sagetrac-mirror/commit/f53bbc7afa99b2a0f727c79a3cfe780bb3aa8484)**",
    "created_at": "2022-03-29T23:47:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542538",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`30642ba`](https://github.com/sagemath/sagetrac-mirror/commit/30642ba190ae9a6a6090b11e51a317a2534028db)** to **[`f53bbc7`](https://github.com/sagemath/sagetrac-mirror/commit/f53bbc7afa99b2a0f727c79a3cfe780bb3aa8484)**



---

archive/issue_comments_542539.json:
```json
{
    "body": "<div id=\"comment:21\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/11219e5ca5819f09f9afe72e0c97c74fa367094a\"><code>11219e5</code></a></td><td><code>src/tox.ini (pytest): Set --import-mode importlib here, not in src/bin/sage, src/bin/sage-runtests</code></td></tr></table>\n",
    "created_at": "2022-03-29T23:51:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542539",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:21"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/11219e5ca5819f09f9afe72e0c97c74fa367094a"><code>11219e5</code></a></td><td><code>src/tox.ini (pytest): Set --import-mode importlib here, not in src/bin/sage, src/bin/sage-runtests</code></td></tr></table>




---

archive/issue_comments_542540.json:
```json
{
    "body": "Changed commit from **[`f53bbc7`](https://github.com/sagemath/sagetrac-mirror/commit/f53bbc7afa99b2a0f727c79a3cfe780bb3aa8484)** to **[`11219e5`](https://github.com/sagemath/sagetrac-mirror/commit/11219e5ca5819f09f9afe72e0c97c74fa367094a)**",
    "created_at": "2022-03-29T23:51:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542540",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`f53bbc7`](https://github.com/sagemath/sagetrac-mirror/commit/f53bbc7afa99b2a0f727c79a3cfe780bb3aa8484)** to **[`11219e5`](https://github.com/sagemath/sagetrac-mirror/commit/11219e5ca5819f09f9afe72e0c97c74fa367094a)**



---

archive/issue_events_458816.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-29T23:53:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458816"
}
```



---

archive/issue_events_458817.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-29T23:53:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458817"
}
```



---

archive/issue_comments_542541.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@tobiasdiez](#comment%3A19):\n> While playing around, I've also discovered the following error:\n> \n> ```\n> $ ./sage --pytest src/sage/ext_data/nbconvert/postprocess.py\n> ```\n\nThis file is to be considered a data file; it's not a module of the Sage library",
    "created_at": "2022-03-29T23:54:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542541",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@tobiasdiez](#comment%3A19):
> While playing around, I've also discovered the following error:
> 
> ```
> $ ./sage --pytest src/sage/ext_data/nbconvert/postprocess.py
> ```

This file is to be considered a data file; it's not a module of the Sage library



---

archive/issue_events_458818.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-30T12:31:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458818"
}
```



---

archive/issue_events_458819.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-30T12:31:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458819"
}
```



---

archive/issue_comments_542542.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nThanks for the follow-up. However, during the merge something seems to went wrong. The collect_ignore in the test config shouldn't be readded.",
    "created_at": "2022-03-30T12:31:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542542",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:24" align="right">comment:24</div>

Thanks for the follow-up. However, during the merge something seems to went wrong. The collect_ignore in the test config shouldn't be readded.



---

archive/issue_comments_542543.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@mkoeppe](#comment%3A23):\n> Replying to [@tobiasdiez](#comment%3A19):\n> > While playing around, I've also discovered the following error:\n> > \n> > ```\n> > $ ./sage --pytest src/sage/ext_data/nbconvert/postprocess.py\n> > ```\n> \n> \n> This file is to be considered a data file; it's not a module of the Sage library\n\nSo you are saying it should be removed during collection? Then please do so by adding a filter in pytest_collect_file similar to  #33560.",
    "created_at": "2022-03-30T12:32:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542543",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@mkoeppe](#comment%3A23):
> Replying to [@tobiasdiez](#comment%3A19):
> > While playing around, I've also discovered the following error:
> > 
> > ```
> > $ ./sage --pytest src/sage/ext_data/nbconvert/postprocess.py
> > ```
> 
> 
> This file is to be considered a data file; it's not a module of the Sage library

So you are saying it should be removed during collection? Then please do so by adding a filter in pytest_collect_file similar to  #33560.



---

archive/issue_comments_542544.json:
```json
{
    "body": "<div id=\"comment:26\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f0d5f840f8442c327a98c9b06bae253c684d243f\"><code>f0d5f84</code></a></td><td><code>src/conftest.py: import sage.all to avoid cyclic import errors</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d881a5a154c751e79cfb68ecaf60653d8e6bdc65\"><code>d881a5a</code></a></td><td><code>src/conftest.py: Add # type: ignore, add reference to trac ticket</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1242e1f5daedfac348824f47b988f55ad653b107\"><code>1242e1f</code></a></td><td><code>src/conftest.py: Remove outdated text</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0d9225d87c57f7bda7247836194ec962de476e7b\"><code>0d9225d</code></a></td><td><code>src/bin/sage: Handle 'sage -pytest' without file args</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/05bc58f97cb8b3a8712f7fb129b40d0446bc35de\"><code>05bc58f</code></a></td><td><code>src/tox.ini (pytest): Set --import-mode importlib here, not in src/bin/sage, src/bin/sage-runtests</code></td></tr></table>\n",
    "created_at": "2022-03-30T16:07:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542544",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:26"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f0d5f840f8442c327a98c9b06bae253c684d243f"><code>f0d5f84</code></a></td><td><code>src/conftest.py: import sage.all to avoid cyclic import errors</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d881a5a154c751e79cfb68ecaf60653d8e6bdc65"><code>d881a5a</code></a></td><td><code>src/conftest.py: Add # type: ignore, add reference to trac ticket</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1242e1f5daedfac348824f47b988f55ad653b107"><code>1242e1f</code></a></td><td><code>src/conftest.py: Remove outdated text</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0d9225d87c57f7bda7247836194ec962de476e7b"><code>0d9225d</code></a></td><td><code>src/bin/sage: Handle 'sage -pytest' without file args</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/05bc58f97cb8b3a8712f7fb129b40d0446bc35de"><code>05bc58f</code></a></td><td><code>src/tox.ini (pytest): Set --import-mode importlib here, not in src/bin/sage, src/bin/sage-runtests</code></td></tr></table>




---

archive/issue_comments_542545.json:
```json
{
    "body": "Changed commit from **[`11219e5`](https://github.com/sagemath/sagetrac-mirror/commit/11219e5ca5819f09f9afe72e0c97c74fa367094a)** to **[`05bc58f`](https://github.com/sagemath/sagetrac-mirror/commit/05bc58f97cb8b3a8712f7fb129b40d0446bc35de)**",
    "created_at": "2022-03-30T16:07:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542545",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`11219e5`](https://github.com/sagemath/sagetrac-mirror/commit/11219e5ca5819f09f9afe72e0c97c74fa367094a)** to **[`05bc58f`](https://github.com/sagemath/sagetrac-mirror/commit/05bc58f97cb8b3a8712f7fb129b40d0446bc35de)**



---

archive/issue_comments_542546.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nIndeed. Thanks for catching the mistake in rebasing",
    "created_at": "2022-03-30T16:08:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542546",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:27" align="right">comment:27</div>

Indeed. Thanks for catching the mistake in rebasing



---

archive/issue_comments_542547.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@tobiasdiez](#comment%3A25):\n> So you are saying it should be removed during collection? Then please do so by adding a filter in pytest_collect_file similar to  #33560.\n\nThe directories marked by the presence of a `nodoctest` file are ignored by the doctester. \n\n```\n$ find src -name nodoctest\nsrc/sage/ext_data/nodoctest\nsrc/sage/doctest/tests/nodoctest\n```\nNot sure if we want to use this mechanism somehow or just hardcode it in `conftest.py`",
    "created_at": "2022-03-30T16:12:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542547",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@tobiasdiez](#comment%3A25):
> So you are saying it should be removed during collection? Then please do so by adding a filter in pytest_collect_file similar to  #33560.

The directories marked by the presence of a `nodoctest` file are ignored by the doctester. 

```
$ find src -name nodoctest
src/sage/ext_data/nodoctest
src/sage/doctest/tests/nodoctest
```
Not sure if we want to use this mechanism somehow or just hardcode it in `conftest.py`



---

archive/issue_events_458820.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-30T16:12:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458820"
}
```



---

archive/issue_events_458821.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-30T16:12:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458821"
}
```



---

archive/issue_comments_542548.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@mkoeppe](#comment%3A28):\n> Replying to [@tobiasdiez](#comment%3A25):\n> > So you are saying it should be removed during collection? Then please do so by adding a filter in pytest_collect_file similar to  #33560.\n> \n> \n> The directories marked by the presence of a `nodoctest` file are ignored by the doctester. \n> \n> ```\n> $ find src -name nodoctest\n> src/sage/ext_data/nodoctest\n> src/sage/doctest/tests/nodoctest\n> ```\n> Not sure if we want to use this mechanism somehow or just hardcode it in `conftest.py`\n\nI would say its simpler to exclude these two directories in conftest. As you already know, I'm not a big fan of such marker files in general.",
    "created_at": "2022-03-30T18:33:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542548",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@mkoeppe](#comment%3A28):
> Replying to [@tobiasdiez](#comment%3A25):
> > So you are saying it should be removed during collection? Then please do so by adding a filter in pytest_collect_file similar to  #33560.
> 
> 
> The directories marked by the presence of a `nodoctest` file are ignored by the doctester. 
> 
> ```
> $ find src -name nodoctest
> src/sage/ext_data/nodoctest
> src/sage/doctest/tests/nodoctest
> ```
> Not sure if we want to use this mechanism somehow or just hardcode it in `conftest.py`

I would say its simpler to exclude these two directories in conftest. As you already know, I'm not a big fan of such marker files in general.



---

archive/issue_comments_542549.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nOK, sounds good.",
    "created_at": "2022-03-30T18:36:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542549",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:31" align="right">comment:31</div>

OK, sounds good.



---

archive/issue_comments_542550.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nGiven that `./sage --pytest src/sage/ext_data/nbconvert/` collects nothing, I don't think we need to do anything about `./sage --pytest src/sage/ext_data/nbconvert/postprocess.py`.",
    "created_at": "2022-03-30T23:52:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542550",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:32" align="right">comment:32</div>

Given that `./sage --pytest src/sage/ext_data/nbconvert/` collects nothing, I don't think we need to do anything about `./sage --pytest src/sage/ext_data/nbconvert/postprocess.py`.



---

archive/issue_comments_542551.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nWhy not?\nIt's the same issue as with `sage -t` and #33560. It works if you specify a folder and let pytest do the collection, but doesn't work correctly if you overwrite the collection by specifying the complete path.",
    "created_at": "2022-03-31T08:33:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542551",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:33" align="right">comment:33</div>

Why not?
It's the same issue as with `sage -t` and #33560. It works if you specify a folder and let pytest do the collection, but doesn't work correctly if you overwrite the collection by specifying the complete path.



---

archive/issue_comments_542552.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nNot the same because there is no existing practice of running pytest on that file.",
    "created_at": "2022-03-31T14:08:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542552",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:34" align="right">comment:34</div>

Not the same because there is no existing practice of running pytest on that file.



---

archive/issue_comments_542553.json:
```json
{
    "body": "Changed commit from **[`05bc58f`](https://github.com/sagemath/sagetrac-mirror/commit/05bc58f97cb8b3a8712f7fb129b40d0446bc35de)** to **[`8825079`](https://github.com/sagemath/sagetrac-mirror/commit/8825079d65f07e9cf13bb3e65197d276a43b9591)**",
    "created_at": "2022-03-31T14:11:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542553",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`05bc58f`](https://github.com/sagemath/sagetrac-mirror/commit/05bc58f97cb8b3a8712f7fb129b40d0446bc35de)** to **[`8825079`](https://github.com/sagemath/sagetrac-mirror/commit/8825079d65f07e9cf13bb3e65197d276a43b9591)**



---

archive/issue_comments_542554.json:
```json
{
    "body": "<div id=\"comment:35\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8825079d65f07e9cf13bb3e65197d276a43b9591\"><code>8825079</code></a></td><td><code>src/doc/en/developer/tools.rst: Update section on pytest</code></td></tr></table>\n",
    "created_at": "2022-03-31T14:11:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542554",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:35"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8825079d65f07e9cf13bb3e65197d276a43b9591"><code>8825079</code></a></td><td><code>src/doc/en/developer/tools.rst: Update section on pytest</code></td></tr></table>




---

archive/issue_comments_542555.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nReplying to [@mkoeppe](#comment%3A34):\n> Not the same because there is no existing practice of running pytest on that file.\n\nThat applies to Cython files as well, or not? We still exclude them in #33560.",
    "created_at": "2022-03-31T14:28:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542555",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:36" align="right">comment:36</div>

Replying to [@mkoeppe](#comment%3A34):
> Not the same because there is no existing practice of running pytest on that file.

That applies to Cython files as well, or not? We still exclude them in #33560.



---

archive/issue_comments_542556.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nThere is very much existing practice of running `sage -t` on Cython files.",
    "created_at": "2022-03-31T14:33:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542556",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:37" align="right">comment:37</div>

There is very much existing practice of running `sage -t` on Cython files.



---

archive/issue_comments_542557.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nLet's get this in please",
    "created_at": "2022-04-01T16:37:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542557",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:38" align="right">comment:38</div>

Let's get this in please



---

archive/issue_events_458822.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-04-01T17:00:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458822"
}
```



---

archive/issue_events_458823.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-04-01T17:00:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458823"
}
```



---

archive/issue_comments_542558.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nOkay. I still think these folders with `nodoctest` files should be skipped; but that can be done in a follow-up ticket. (The sagebot issues don't seem to be related to this ticket.)",
    "created_at": "2022-04-01T17:00:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542558",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:39" align="right">comment:39</div>

Okay. I still think these folders with `nodoctest` files should be skipped; but that can be done in a follow-up ticket. (The sagebot issues don't seem to be related to this ticket.)



---

archive/issue_comments_542559.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nThanks!",
    "created_at": "2022-04-01T17:37:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542559",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:40" align="right">comment:40</div>

Thanks!



---

archive/issue_comments_542560.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/sage__pytest](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage__pytest)** to **[`8825079`](https://github.com/sagemath/sagetrac-mirror/commit/8825079d65f07e9cf13bb3e65197d276a43b9591)**",
    "created_at": "2022-04-03T11:13:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/33572#issuecomment-542560",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/sage__pytest](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage__pytest)** to **[`8825079`](https://github.com/sagemath/sagetrac-mirror/commit/8825079d65f07e9cf13bb3e65197d276a43b9591)**



---

archive/issue_events_458824.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-04-03T11:13:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458824"
}
```



---

archive/issue_events_458825.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "55da3e109e52468644df175545f82e1c7e60cdf5",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2022-04-03T11:13:45Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/33572",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/33572#event-458825"
}
```
