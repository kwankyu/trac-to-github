# Issue 15388: log of NaN in RealField and ComplexField results in infinite loop

archive/issues_015151.json:
```json
{
    "body": "If you have a RealField or ComplexField NaN value and attempt to compute log, the fact that NaN is considered < 0 results in RealField.log calling ComplexField.log, but then ComplexField.log calls RealField.log again, but again on the values NaN for the absolute value. This results in an infinite loop. Example code for the code: \n\nx = RealField()(NaN)\nx.log() # Results in infinite loop\n\nThis patch fixes the log function in RealField and ComplexField to return NaN if fed a number which is NaN (in either the real or the imaginary coordinate). \n\n**Assignee:** Paul Fili\n\n**CC:**  atowsley\n\n**Keywords:** sage-days55\n\n**Reviewer:** Benjamin Hutz\n\n**Author:** Paul Fili, Adam Towsley\n\n**Merged:** sage-5.13.beta3\n\nIssue created by migration from https://trac.sagemath.org/ticket/15388\n\n",
    "closed_at": "2013-11-14T07:54:21Z",
    "created_at": "2013-11-09T15:46:09Z",
    "labels": [
        "component: numerical",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.13",
    "title": "log of NaN in RealField and ComplexField results in infinite loop",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/15388",
    "user": "https://github.com/pfili"
}
```
If you have a RealField or ComplexField NaN value and attempt to compute log, the fact that NaN is considered < 0 results in RealField.log calling ComplexField.log, but then ComplexField.log calls RealField.log again, but again on the values NaN for the absolute value. This results in an infinite loop. Example code for the code: 

x = RealField()(NaN)
x.log() # Results in infinite loop

This patch fixes the log function in RealField and ComplexField to return NaN if fed a number which is NaN (in either the real or the imaginary coordinate). 

**Assignee:** Paul Fili

**CC:**  atowsley

**Keywords:** sage-days55

**Reviewer:** Benjamin Hutz

**Author:** Paul Fili, Adam Towsley

**Merged:** sage-5.13.beta3

Issue created by migration from https://trac.sagemath.org/ticket/15388





---

archive/issue_events_136568.json:
```json
{
    "actor": "https://github.com/pfili",
    "created_at": "2013-11-09T16:26:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136568"
}
```



---

archive/issue_events_136569.json:
```json
{
    "actor": "https://github.com/pfili",
    "created_at": "2013-11-09T16:37:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "component: numerical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136569"
}
```



---

archive/issue_comments_193664.json:
```json
{
    "body": "<a id='comment:3'></a>\nA couple things\n\n1) the patch needs a commit message\n\n2) the patch name should be trac_15388_<description>.patch\n\n3) Please add a doctest to each log function to demonstrate the fix\n\n4) lines 2063, 2064 which are commented out look like they can just be removed as they add no value to the code",
    "created_at": "2013-11-10T00:42:07Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15388#issuecomment-193664",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:3'></a>
A couple things

1) the patch needs a commit message

2) the patch name should be trac_15388_<description>.patch

3) Please add a doctest to each log function to demonstrate the fix

4) lines 2063, 2064 which are commented out look like they can just be removed as they add no value to the code



---

archive/issue_events_136570.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2013-11-10T00:42:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136570"
}
```



---

archive/issue_events_136571.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2013-11-10T00:42:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136571"
}
```



---

archive/issue_comments_193665.json:
```json
{
    "body": "**Reviewer:** Ben Hutz",
    "created_at": "2013-11-10T00:42:38Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15388#issuecomment-193665",
    "user": "https://github.com/bhutz"
}
```

**Reviewer:** Ben Hutz



---

archive/issue_comments_193666.json:
```json
{
    "body": "<a id='comment:5'></a>\nlong doctest looks fine with this, so I'm happy with the code change, just make the minor changes suggested above.\n\nJust to note, I had a few unrelated longtest failures on 5.12 that failed both with and without the patch.\n\n```\nsage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/tests/cmdline.py  # 11 doctests failed\nsage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/calculus/desolvers.py  # 8 doctests failed\nsage -t --long /home/bhutz/sage/sage-5.12/devel/sage/doc/en/constructions/calculus.rst  # 4 doctests failed\nsage -t --long /home/bhutz/sage/sage-5.12/devel/sage/doc/en/prep/Quickstarts/Differential-Equations.rst  # 2 doctests failed\nsage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/misc/interpreter.py  # 1 doctest failed\nsage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/misc/trace.py  # 2 doctests failed\nsage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/tests/interrupt.pyx  # Time out\n```",
    "created_at": "2013-11-10T02:20:52Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15388#issuecomment-193666",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:5'></a>
long doctest looks fine with this, so I'm happy with the code change, just make the minor changes suggested above.

Just to note, I had a few unrelated longtest failures on 5.12 that failed both with and without the patch.

```
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/tests/cmdline.py  # 11 doctests failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/calculus/desolvers.py  # 8 doctests failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/doc/en/constructions/calculus.rst  # 4 doctests failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/doc/en/prep/Quickstarts/Differential-Equations.rst  # 2 doctests failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/misc/interpreter.py  # 1 doctest failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/misc/trace.py  # 2 doctests failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/tests/interrupt.pyx  # Time out
```



---

archive/issue_comments_193667.json:
```json
{
    "body": "<a id='comment:7'></a>\nIt is probably best not to have an example involving NaN in the log's documentation, as it is such a basic function and this case is rather exceptional. (Although we still want it to work in case a log appears in someone's code after an NaN has already appeared, as happened to us when we found this bug.)",
    "created_at": "2013-11-10T15:31:48Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15388#issuecomment-193667",
    "user": "https://github.com/pfili"
}
```

<a id='comment:7'></a>
It is probably best not to have an example involving NaN in the log's documentation, as it is such a basic function and this case is rather exceptional. (Although we still want it to work in case a log appears in someone's code after an NaN has already appeared, as happened to us when we found this bug.)



---

archive/issue_comments_193668.json:
```json
{
    "body": "<a id='comment:8'></a>\nWe have made the changes Ben suggested, except for adding a doctest, which seems undesirable as noted above.",
    "created_at": "2013-11-10T15:34:32Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15388#issuecomment-193668",
    "user": "https://github.com/pfili"
}
```

<a id='comment:8'></a>
We have made the changes Ben suggested, except for adding a doctest, which seems undesirable as noted above.



---

archive/issue_events_136572.json:
```json
{
    "actor": "https://github.com/pfili",
    "created_at": "2013-11-10T15:36:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136572"
}
```



---

archive/issue_events_136573.json:
```json
{
    "actor": "https://github.com/pfili",
    "created_at": "2013-11-10T15:36:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136573"
}
```



---

archive/issue_comments_193669.json:
```json
{
    "body": "<a id='comment:10'></a>\nThis looks good.",
    "created_at": "2013-11-10T16:41:32Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15388#issuecomment-193669",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:10'></a>
This looks good.



---

archive/issue_events_136574.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2013-11-10T16:41:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136574"
}
```



---

archive/issue_events_136575.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2013-11-10T16:41:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136575"
}
```



---

archive/issue_comments_193670.json:
```json
{
    "body": "**Work Issues:** doctest",
    "created_at": "2013-11-10T22:50:25Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15388#issuecomment-193670",
    "user": "https://github.com/jdemeyer"
}
```

**Work Issues:** doctest



---

archive/issue_events_136576.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-10T22:50:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136576"
}
```



---

archive/issue_events_136577.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-10T22:50:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136577"
}
```



---

archive/issue_comments_193671.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [@pfili](#comment%3A7):\n> Although we still want it to work in case a log appears in someone's code after an NaN has already appeared, as happened to us when we found this bug.\n\nWhich is exactly why a doctest is needed.",
    "created_at": "2013-11-10T22:50:25Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15388#issuecomment-193671",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
Replying to [@pfili](#comment%3A7):
> Although we still want it to work in case a log appears in someone's code after an NaN has already appeared, as happened to us when we found this bug.

Which is exactly why a doctest is needed.



---

archive/issue_comments_193672.json:
```json
{
    "body": "<a id='comment:12'></a>\nI have added a doctest that explains the behavior for NaN.",
    "created_at": "2013-11-12T00:36:49Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15388#issuecomment-193672",
    "user": "https://github.com/pfili"
}
```

<a id='comment:12'></a>
I have added a doctest that explains the behavior for NaN.



---

archive/issue_events_136578.json:
```json
{
    "actor": "https://github.com/pfili",
    "created_at": "2013-11-12T00:36:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136578"
}
```



---

archive/issue_events_136579.json:
```json
{
    "actor": "https://github.com/pfili",
    "created_at": "2013-11-12T00:36:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136579"
}
```



---

archive/issue_events_136580.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2013-11-12T01:36:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136580"
}
```



---

archive/issue_events_136581.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2013-11-12T01:36:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136581"
}
```



---

archive/issue_comments_193673.json:
```json
{
    "body": "<a id='comment:13'></a>\nOk. This still looks fine and now we have the doctests.",
    "created_at": "2013-11-12T01:36:20Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15388#issuecomment-193673",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:13'></a>
Ok. This still looks fine and now we have the doctests.



---

archive/issue_comments_193674.json:
```json
{
    "body": "<a id='comment:14'></a>\nYou should add a meaningful commit message (use `hg qrefresh -e` for that)",
    "created_at": "2013-11-12T07:27:38Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15388#issuecomment-193674",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>
You should add a meaningful commit message (use `hg qrefresh -e` for that)



---

archive/issue_comments_193675.json:
```json
{
    "body": "**Changing work issues** from \"doctest\" to \"\".",
    "created_at": "2013-11-12T07:27:38Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15388#issuecomment-193675",
    "user": "https://github.com/jdemeyer"
}
```

**Changing work issues** from "doctest" to "".



---

archive/issue_events_136582.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-12T07:27:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136582"
}
```



---

archive/issue_events_136583.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-12T07:27:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136583"
}
```



---

archive/issue_comments_193676.json:
```json
{
    "body": "Fixes the behavior of log(NaN) in real and complex fields",
    "created_at": "2013-11-12T16:05:55Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15388#issuecomment-193676",
    "user": "https://github.com/pfili"
}
```

Fixes the behavior of log(NaN) in real and complex fields



---

archive/attachments_021103.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_15388_nan_fix.patch",
    "asset_url": "tarball://root/attachments/ticket15388/trac_15388_nan_fix.patch",
    "created_at": "2013-11-12T16:06:19Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket15388/trac_15388_nan_fix.patch",
    "user": "https://github.com/pfili"
}
```



---

archive/issue_comments_193677.json:
```json
{
    "body": "<a id='comment:15'></a>\n**Attachment:** [trac_15388_nan_fix.patch](https://github.com/sagemath/sage/files/ticket15388/trac_15388_nan_fix.patch)\n\nCommit message has been added.",
    "created_at": "2013-11-12T16:06:19Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15388#issuecomment-193677",
    "user": "https://github.com/pfili"
}
```

<a id='comment:15'></a>
**Attachment:** [trac_15388_nan_fix.patch](https://github.com/sagemath/sage/files/ticket15388/trac_15388_nan_fix.patch)

Commit message has been added.



---

archive/issue_events_136584.json:
```json
{
    "actor": "https://github.com/pfili",
    "created_at": "2013-11-12T16:06:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136584"
}
```



---

archive/issue_events_136585.json:
```json
{
    "actor": "https://github.com/pfili",
    "created_at": "2013-11-12T16:06:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136585"
}
```



---

archive/issue_events_136586.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2013-11-13T12:19:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136586"
}
```



---

archive/issue_events_136587.json:
```json
{
    "actor": "https://github.com/bhutz",
    "created_at": "2013-11-13T12:19:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136587"
}
```



---

archive/issue_comments_193678.json:
```json
{
    "body": "<a id='comment:16'></a>\nok. still looks good, but with a commit message this time.",
    "created_at": "2013-11-13T12:19:23Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15388#issuecomment-193678",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:16'></a>
ok. still looks good, but with a commit message this time.



---

archive/issue_events_136588.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-14T07:54:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136588"
}
```



---

archive/issue_events_136589.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-14T07:54:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/15388#event-136589"
}
```



---

archive/issue_comments_193679.json:
```json
{
    "body": "**Merged:** sage-5.13.beta3",
    "created_at": "2013-11-14T07:54:21Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15388#issuecomment-193679",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.13.beta3



---

archive/issue_comments_193680.json:
```json
{
    "body": "**Changing reviewer** from \"Ben Hutz\" to \"Benjamin Hutz\".",
    "created_at": "2013-12-15T08:45:18Z",
    "issue": "https://github.com/sagemath/sage/issues/15388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/15388#issuecomment-193680",
    "user": "https://github.com/jdemeyer"
}
```

**Changing reviewer** from "Ben Hutz" to "Benjamin Hutz".
