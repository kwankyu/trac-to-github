# Issue 27049: py3: some fix in Riemann surfaces

archive/issues_026812.json:
```json
{
    "body": "only partial, there remains 4 failing doctests out of 36\n\n**CC:**  @tscrim\n\n**Branch/Commit:** [f6b68b9ad9b814bc20cdec7275ebfd4375e8f1ca](https://github.com/sagemath/sagetrac-mirror/commit/f6b68b9ad9b814bc20cdec7275ebfd4375e8f1ca)\n\n**Reviewer:** Travis Scrimshaw\n\n**Author:** Fr\u00e9d\u00e9ric Chapoton, Nils Bruin\n\nIssue created by migration from https://trac.sagemath.org/ticket/27049\n\n",
    "closed_at": "2019-01-24T18:17:31Z",
    "created_at": "2019-01-13T09:31:04Z",
    "labels": [
        "component: python3",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.7",
    "title": "py3: some fix in Riemann surfaces",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/27049",
    "user": "https://github.com/fchapoton"
}
```
only partial, there remains 4 failing doctests out of 36

**CC:**  @tscrim

**Branch/Commit:** [f6b68b9ad9b814bc20cdec7275ebfd4375e8f1ca](https://github.com/sagemath/sagetrac-mirror/commit/f6b68b9ad9b814bc20cdec7275ebfd4375e8f1ca)

**Reviewer:** Travis Scrimshaw

**Author:** Frédéric Chapoton, Nils Bruin

Issue created by migration from https://trac.sagemath.org/ticket/27049





---

archive/issue_comments_419908.json:
```json
{
    "body": "**Commit:** [31bceafa0eff35a8ad6a2d701c155794af5ecfa8](https://github.com/sagemath/sagetrac-mirror/commit/31bceafa0eff35a8ad6a2d701c155794af5ecfa8)",
    "created_at": "2019-01-13T09:31:30Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419908",
    "user": "https://github.com/fchapoton"
}
```

**Commit:** [31bceafa0eff35a8ad6a2d701c155794af5ecfa8](https://github.com/sagemath/sagetrac-mirror/commit/31bceafa0eff35a8ad6a2d701c155794af5ecfa8)



---

archive/issue_events_241150.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-01-13T09:31:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27049#event-241150"
}
```



---

archive/issue_comments_419909.json:
```json
{
    "body": "**Branch:** [u/chapoton/27049](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/27049)",
    "created_at": "2019-01-13T09:31:30Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419909",
    "user": "https://github.com/fchapoton"
}
```

**Branch:** [u/chapoton/27049](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/27049)



---

archive/issue_comments_419910.json:
```json
{
    "body": "<a id='comment:1'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/31bceafa0eff35a8ad6a2d701c155794af5ecfa8\">31bceaf</a></td><td><code>py3 some partial fix for Riemann surfaces</code></td></tr></table>\n",
    "created_at": "2019-01-13T09:31:30Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419910",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/31bceafa0eff35a8ad6a2d701c155794af5ecfa8">31bceaf</a></td><td><code>py3 some partial fix for Riemann surfaces</code></td></tr></table>




---

archive/issue_comments_419911.json:
```json
{
    "body": "<a id='comment:2'></a>\ngreen bot, please review",
    "created_at": "2019-01-13T14:18:53Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419911",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'></a>
green bot, please review



---

archive/issue_comments_419912.json:
```json
{
    "body": "<a id='comment:3'></a>\nLGTM.",
    "created_at": "2019-01-13T17:01:18Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419912",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>
LGTM.



---

archive/issue_events_241151.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2019-01-13T17:01:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27049#event-241151"
}
```



---

archive/issue_events_241152.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2019-01-13T17:01:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27049#event-241152"
}
```



---

archive/issue_comments_419913.json:
```json
{
    "body": "**Reviewer:** Travis Scrimshaw",
    "created_at": "2019-01-13T17:01:18Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419913",
    "user": "https://github.com/tscrim"
}
```

**Reviewer:** Travis Scrimshaw



---

archive/issue_comments_419914.json:
```json
{
    "body": "**Changing branch** from \"[u/chapoton/27049](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/27049)\" to \"[u/nbruin/27049](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/27049)\".",
    "created_at": "2019-01-14T20:58:49Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419914",
    "user": "https://github.com/nbruin"
}
```

**Changing branch** from "[u/chapoton/27049](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/27049)" to "[u/nbruin/27049](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/27049)".



---

archive/issue_comments_419915.json:
```json
{
    "body": "<a id='comment:5'></a>\nChanged back to using sqrt method. It's much faster because it doesn't have to do all the generic stuff. This is a core routine -- it actually makes a difference if it's fast.\n\n(also -- not a fan of all the trivial whitespace edits. It makes it hard to tell from the diff what has actually changed. If you have to touch a line anyway: sure, go ahead. Otherwise I think it's better to just leave it in the original form and not impose (subjective) aesthetics --PEP8's suggestions are mainly against too much whitespace; less so for too little :-) )\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9176ecb0378e1329e39cc13164b01b5a6eca22b3\">9176ecb</a></td><td><code>Use sqrt method, which is faster and more specific, rather than generic function</code></td></tr></table>\n",
    "created_at": "2019-01-14T21:09:28Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419915",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:5'></a>
Changed back to using sqrt method. It's much faster because it doesn't have to do all the generic stuff. This is a core routine -- it actually makes a difference if it's fast.

(also -- not a fan of all the trivial whitespace edits. It makes it hard to tell from the diff what has actually changed. If you have to touch a line anyway: sure, go ahead. Otherwise I think it's better to just leave it in the original form and not impose (subjective) aesthetics --PEP8's suggestions are mainly against too much whitespace; less so for too little :-) )

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9176ecb0378e1329e39cc13164b01b5a6eca22b3">9176ecb</a></td><td><code>Use sqrt method, which is faster and more specific, rather than generic function</code></td></tr></table>




---

archive/issue_comments_419916.json:
```json
{
    "body": "**Changing commit** from \"[31bceafa0eff35a8ad6a2d701c155794af5ecfa8](https://github.com/sagemath/sagetrac-mirror/commit/31bceafa0eff35a8ad6a2d701c155794af5ecfa8)\" to \"[9176ecb0378e1329e39cc13164b01b5a6eca22b3](https://github.com/sagemath/sagetrac-mirror/commit/9176ecb0378e1329e39cc13164b01b5a6eca22b3)\".",
    "created_at": "2019-01-14T21:09:28Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419916",
    "user": "https://github.com/nbruin"
}
```

**Changing commit** from "[31bceafa0eff35a8ad6a2d701c155794af5ecfa8](https://github.com/sagemath/sagetrac-mirror/commit/31bceafa0eff35a8ad6a2d701c155794af5ecfa8)" to "[9176ecb0378e1329e39cc13164b01b5a6eca22b3](https://github.com/sagemath/sagetrac-mirror/commit/9176ecb0378e1329e39cc13164b01b5a6eca22b3)".



---

archive/issue_comments_419917.json:
```json
{
    "body": "<a id='comment:6'></a>\nVery minor change, but I guess someone should take a look at it before we set it back to positive review.",
    "created_at": "2019-01-14T21:33:27Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419917",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:6'></a>
Very minor change, but I guess someone should take a look at it before we set it back to positive review.



---

archive/issue_events_241153.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2019-01-14T21:33:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27049#event-241153"
}
```



---

archive/issue_events_241154.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2019-01-14T21:33:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27049#event-241154"
}
```



---

archive/issue_comments_419918.json:
```json
{
    "body": "<a id='comment:7'></a>\nIt would be fine with me except it can have a `float` input, which leads to these doctest failures (according to the patchbot):\n\n```\nsage -t --long src/sage/schemes/riemann_surfaces/riemann_surface.py  # 32 doctests failed\n```",
    "created_at": "2019-01-15T06:28:06Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419918",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>
It would be fine with me except it can have a `float` input, which leads to these doctest failures (according to the patchbot):

```
sage -t --long src/sage/schemes/riemann_surfaces/riemann_surface.py  # 32 doctests failed
```



---

archive/issue_events_241155.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2019-01-15T06:28:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27049#event-241155"
}
```



---

archive/issue_events_241156.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2019-01-15T06:28:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27049#event-241156"
}
```



---

archive/issue_comments_419919.json:
```json
{
    "body": "**Changing author** from \"Fr\u00e9d\u00e9ric Chapoton\" to \"Fr\u00e9d\u00e9ric Chapoton, Nils Bruin\".",
    "created_at": "2019-01-15T06:28:06Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419919",
    "user": "https://github.com/tscrim"
}
```

**Changing author** from "Frédéric Chapoton" to "Frédéric Chapoton, Nils Bruin".



---

archive/issue_comments_419920.json:
```json
{
    "body": "<a id='comment:8'></a>\nWhatever way, the point of this ticket is to make this module's doctests pass with both python2 and python3. If you want to keep the speed, this may not be so easy.\n\nEDIT: pep8 is official for sage, see\n\nhttps://doc.sagemath.org/html/en/developer/coding_basics.html#python-code-style",
    "created_at": "2019-01-15T07:22:28Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419920",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:8'></a>
Whatever way, the point of this ticket is to make this module's doctests pass with both python2 and python3. If you want to keep the speed, this may not be so easy.

EDIT: pep8 is official for sage, see

https://doc.sagemath.org/html/en/developer/coding_basics.html#python-code-style



---

archive/issue_comments_419921.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [@tscrim](#comment%3A7):\n> It would be fine with me except it can have a `float` input, which leads to these doctest failures (according to the patchbot)\n\nThat's strange. I cannot replicate that behaviour. It seems to me this bot is testing python 2, so it doesn't look like a py2/3 issue. Is this bot anomalous? If I had access to a platform where this behaviour occurs, I could probably debug this quite quickly.",
    "created_at": "2019-01-15T07:26:28Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419921",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:9'></a>
Replying to [@tscrim](#comment%3A7):
> It would be fine with me except it can have a `float` input, which leads to these doctest failures (according to the patchbot)

That's strange. I cannot replicate that behaviour. It seems to me this bot is testing python 2, so it doesn't look like a py2/3 issue. Is this bot anomalous? If I had access to a platform where this behaviour occurs, I could probably debug this quite quickly.



---

archive/issue_comments_419922.json:
```json
{
    "body": "<a id='comment:10'></a>\nMaybe this python3-like behaviour is caused by the line\n\n```\nfrom __future__ import division\n```\nthat we really want to add.",
    "created_at": "2019-01-15T07:30:06Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419922",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:10'></a>
Maybe this python3-like behaviour is caused by the line

```
from __future__ import division
```
that we really want to add.



---

archive/issue_comments_419923.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [@fchapoton](#comment%3A10):\n> Maybe this python3-like behaviour is caused by the line\n> \n> ```\n> from __future__ import division\n> ```\n> that we really want to add.\n\nApparently only on some platforms then, because I ran this exact branch without problems. It means some divisions need to be encoded differently. \n\nIs it indeed the case that dividing an element of RealField by a python integer may yield a float on some and a RealField element on others if \"division\" is imported? That would be really bad and would make porting a lot harder.",
    "created_at": "2019-01-15T07:38:47Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419923",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:11'></a>
Replying to [@fchapoton](#comment%3A10):
> Maybe this python3-like behaviour is caused by the line
> 
> ```
> from __future__ import division
> ```
> that we really want to add.

Apparently only on some platforms then, because I ran this exact branch without problems. It means some divisions need to be encoded differently. 

Is it indeed the case that dividing an element of RealField by a python integer may yield a float on some and a RealField element on others if "division" is imported? That would be really bad and would make porting a lot harder.



---

archive/issue_comments_419924.json:
```json
{
    "body": "<a id='comment:12'></a>\nI don't know.\n\nWe could try to use `**QQ((1,2))`but it will probably be just as slow as `sqrt(...)`",
    "created_at": "2019-01-15T07:45:54Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419924",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:12'></a>
I don't know.

We could try to use `**QQ((1,2))`but it will probably be just as slow as `sqrt(...)`



---

archive/issue_comments_419925.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [@fchapoton](#comment%3A12):\n> We could try to use `**QQ((1,2))`but it will probably be just as slow as `sqrt(...)`\n\nNo, if this really is a problem we can replace the \"division by two\" by an exponent operation, which would be very fast. I just need to know which operations are the problematic ones. On the computers I have access to, there is no problem, so I can't debug the problem presently.",
    "created_at": "2019-01-15T08:08:36Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419925",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:13'></a>
Replying to [@fchapoton](#comment%3A12):
> We could try to use `**QQ((1,2))`but it will probably be just as slow as `sqrt(...)`

No, if this really is a problem we can replace the "division by two" by an exponent operation, which would be very fast. I just need to know which operations are the problematic ones. On the computers I have access to, there is no problem, so I can't debug the problem presently.



---

archive/issue_comments_419926.json:
```json
{
    "body": "<a id='comment:14'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0c4d65bc17d3d406ca1f225a27ef49055edc9140\">0c4d65b</a></td><td><code>try to use shift instead of division-by-two, to work around possibly issues with future division. It might be faster too.</code></td></tr></table>\n",
    "created_at": "2019-01-15T08:14:22Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419926",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0c4d65bc17d3d406ca1f225a27ef49055edc9140">0c4d65b</a></td><td><code>try to use shift instead of division-by-two, to work around possibly issues with future division. It might be faster too.</code></td></tr></table>




---

archive/issue_comments_419927.json:
```json
{
    "body": "**Changing commit** from \"[9176ecb0378e1329e39cc13164b01b5a6eca22b3](https://github.com/sagemath/sagetrac-mirror/commit/9176ecb0378e1329e39cc13164b01b5a6eca22b3)\" to \"[0c4d65bc17d3d406ca1f225a27ef49055edc9140](https://github.com/sagemath/sagetrac-mirror/commit/0c4d65bc17d3d406ca1f225a27ef49055edc9140)\".",
    "created_at": "2019-01-15T08:14:22Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419927",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[9176ecb0378e1329e39cc13164b01b5a6eca22b3](https://github.com/sagemath/sagetrac-mirror/commit/9176ecb0378e1329e39cc13164b01b5a6eca22b3)" to "[0c4d65bc17d3d406ca1f225a27ef49055edc9140](https://github.com/sagemath/sagetrac-mirror/commit/0c4d65bc17d3d406ca1f225a27ef49055edc9140)".



---

archive/issue_comments_419928.json:
```json
{
    "body": "<a id='comment:15'></a>\nLet's see how the bot fares with this.",
    "created_at": "2019-01-15T08:14:49Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419928",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:15'></a>
Let's see how the bot fares with this.



---

archive/issue_comments_419929.json:
```json
{
    "body": "<a id='comment:16'></a>\ngot with python2 77 doctests failings in the modified file, for example\n\n```\nFile \"src/sage/schemes/riemann_surfaces/riemann_surface.py\", line 2244, in sage.schemes.riemann_surfaces.riemann_surface.RiemannSurfaceSum.__add__\nFailed example:\n    S1+S1+S1\nException raised:\n    Traceback (most recent call last):\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1086, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.schemes.riemann_surfaces.riemann_surface.RiemannSurfaceSum.__add__[3]>\", line 1, in <module>\n        S1+S1+S1\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py\", line 2043, in __add__\n        return RiemannSurfaceSum([self,other])\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py\", line 2168, in __init__\n        PM = s.period_matrix()\n      File \"sage/misc/cachefunc.pyx\", line 2314, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12763)\n        self.cache = f(self._instance)\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py\", line 1562, in period_matrix\n        PM=self.matrix_of_integral_values(differentials)\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py\", line 1499, in matrix_of_integral_values\n        cycles = self.homology_basis()\n      File \"sage/misc/cachefunc.pyx\", line 2314, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12763)\n        self.cache = f(self._instance)\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py\", line 1170, in homology_basis\n        edgesu = self.upstairs_edges()\n      File \"sage/misc/cachefunc.pyx\", line 2314, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12763)\n        self.cache = f(self._instance)\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py\", line 935, in upstairs_edges\n        homotopycont = self.homotopy_continuation(e)\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py\", line 711, in homotopy_continuation\n        delta = self._compute_delta(path(T), epsilon, wvalues=currw)/path_length\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py\", line 650, in _compute_delta\n        lowerbound = self._CC(self._a0) >> 1\n    TypeError: unsupported operand type(s) for >>: 'sage.rings.complex_number.ComplexNumber' and 'int'\n```",
    "created_at": "2019-01-15T08:18:15Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419929",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:16'></a>
got with python2 77 doctests failings in the modified file, for example

```
File "src/sage/schemes/riemann_surfaces/riemann_surface.py", line 2244, in sage.schemes.riemann_surfaces.riemann_surface.RiemannSurfaceSum.__add__
Failed example:
    S1+S1+S1
Exception raised:
    Traceback (most recent call last):
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.riemann_surfaces.riemann_surface.RiemannSurfaceSum.__add__[3]>", line 1, in <module>
        S1+S1+S1
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py", line 2043, in __add__
        return RiemannSurfaceSum([self,other])
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py", line 2168, in __init__
        PM = s.period_matrix()
      File "sage/misc/cachefunc.pyx", line 2314, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12763)
        self.cache = f(self._instance)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py", line 1562, in period_matrix
        PM=self.matrix_of_integral_values(differentials)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py", line 1499, in matrix_of_integral_values
        cycles = self.homology_basis()
      File "sage/misc/cachefunc.pyx", line 2314, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12763)
        self.cache = f(self._instance)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py", line 1170, in homology_basis
        edgesu = self.upstairs_edges()
      File "sage/misc/cachefunc.pyx", line 2314, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12763)
        self.cache = f(self._instance)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py", line 935, in upstairs_edges
        homotopycont = self.homotopy_continuation(e)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py", line 711, in homotopy_continuation
        delta = self._compute_delta(path(T), epsilon, wvalues=currw)/path_length
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py", line 650, in _compute_delta
        lowerbound = self._CC(self._a0) >> 1
    TypeError: unsupported operand type(s) for >>: 'sage.rings.complex_number.ComplexNumber' and 'int'
```



---

archive/issue_comments_419930.json:
```json
{
    "body": "<a id='comment:17'></a>\nDid you try with a python3-built sage ?\n\nReplying to [@nbruin](#comment%3A13):\n> Replying to [@fchapoton](#comment%3A12):\n> > We could try to use `**QQ((1,2))`but it will probably be just as slow as `sqrt(...)`\n\n> \n> No, if this really is a problem we can replace the \"division by two\" by an exponent operation, which would be very fast. I just need to know which operations are the problematic ones. On the computers I have access to, there is no problem, so I can't debug the problem presently.",
    "created_at": "2019-01-15T08:21:27Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419930",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:17'></a>
Did you try with a python3-built sage ?

Replying to [@nbruin](#comment%3A13):
> Replying to [@fchapoton](#comment%3A12):
> > We could try to use `**QQ((1,2))`but it will probably be just as slow as `sqrt(...)`

> 
> No, if this really is a problem we can replace the "division by two" by an exponent operation, which would be very fast. I just need to know which operations are the problematic ones. On the computers I have access to, there is no problem, so I can't debug the problem presently.



---

archive/issue_comments_419931.json:
```json
{
    "body": "<a id='comment:18'></a>\nWhen undoing the bad change in `lowerbound = self._CC(self._a0) >> 1`,\nI still get 36 failing doctests in python3 and 32 failing doctests in python2 (same as the one reported by Travis above)",
    "created_at": "2019-01-15T08:24:37Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419931",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:18'></a>
When undoing the bad change in `lowerbound = self._CC(self._a0) >> 1`,
I still get 36 failing doctests in python3 and 32 failing doctests in python2 (same as the one reported by Travis above)



---

archive/issue_comments_419932.json:
```json
{
    "body": "**Changing commit** from \"[0c4d65bc17d3d406ca1f225a27ef49055edc9140](https://github.com/sagemath/sagetrac-mirror/commit/0c4d65bc17d3d406ca1f225a27ef49055edc9140)\" to \"[f6b68b9ad9b814bc20cdec7275ebfd4375e8f1ca](https://github.com/sagemath/sagetrac-mirror/commit/f6b68b9ad9b814bc20cdec7275ebfd4375e8f1ca)\".",
    "created_at": "2019-01-15T08:43:37Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419932",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[0c4d65bc17d3d406ca1f225a27ef49055edc9140](https://github.com/sagemath/sagetrac-mirror/commit/0c4d65bc17d3d406ca1f225a27ef49055edc9140)" to "[f6b68b9ad9b814bc20cdec7275ebfd4375e8f1ca](https://github.com/sagemath/sagetrac-mirror/commit/f6b68b9ad9b814bc20cdec7275ebfd4375e8f1ca)".



---

archive/issue_comments_419933.json:
```json
{
    "body": "<a id='comment:19'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f6b68b9ad9b814bc20cdec7275ebfd4375e8f1ca\">f6b68b9</a></td><td><code>Use nth_root to take a root (not a fractional exponent)</code></td></tr></table>\n",
    "created_at": "2019-01-15T08:43:37Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419933",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f6b68b9ad9b814bc20cdec7275ebfd4375e8f1ca">f6b68b9</a></td><td><code>Use nth_root to take a root (not a fractional exponent)</code></td></tr></table>




---

archive/issue_comments_419934.json:
```json
{
    "body": "<a id='comment:20'></a>\nBy running \"sage -b\" I was able to replicate the erroneous behaviour :-). Turns out the problem arose from an erroneous \"fractional\" exponent that was never fractional, so this code was actually not behaving as intended before, but doing so silently.\n\nHopefully the problem is solved now.",
    "created_at": "2019-01-15T08:47:31Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419934",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:20'></a>
By running "sage -b" I was able to replicate the erroneous behaviour :-). Turns out the problem arose from an erroneous "fractional" exponent that was never fractional, so this code was actually not behaving as intended before, but doing so silently.

Hopefully the problem is solved now.



---

archive/issue_comments_419935.json:
```json
{
    "body": "<a id='comment:21'></a>\nok, thanks. This seems to work both in python2 and in python3. I have launched my bot on it.",
    "created_at": "2019-01-15T09:06:21Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419935",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:21'></a>
ok, thanks. This seems to work both in python2 and in python3. I have launched my bot on it.



---

archive/issue_events_241157.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-01-15T09:08:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27049#event-241157"
}
```



---

archive/issue_events_241158.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-01-15T09:08:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27049#event-241158"
}
```



---

archive/issue_events_241159.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-01-15T09:08:29Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "milestone": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27049#event-241159"
}
```



---

archive/issue_events_241160.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-01-15T09:08:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27049#event-241160"
}
```



---

archive/issue_comments_419936.json:
```json
{
    "body": "<a id='comment:24'></a>\nBot is now green. so this should be good to go. Positive review, everybody ?",
    "created_at": "2019-01-15T10:55:03Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419936",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:24'></a>
Bot is now green. so this should be good to go. Positive review, everybody ?



---

archive/issue_comments_419937.json:
```json
{
    "body": "<a id='comment:25'></a>\nLGTM.",
    "created_at": "2019-01-15T16:08:52Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419937",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:25'></a>
LGTM.



---

archive/issue_events_241161.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2019-01-15T16:08:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27049#event-241161"
}
```



---

archive/issue_events_241162.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2019-01-15T16:08:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27049#event-241162"
}
```



---

archive/issue_events_241163.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-01-24T18:17:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27049#event-241163"
}
```



---

archive/issue_events_241164.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "d5d5fc74526cc388f3315cbf29c146d848aba902",
    "created_at": "2019-01-24T18:17:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27049#event-241164"
}
```



---

archive/issue_comments_419938.json:
```json
{
    "body": "**Changing branch** from \"[u/nbruin/27049](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/27049)\" to \"[f6b68b9ad9b814bc20cdec7275ebfd4375e8f1ca](https://github.com/sagemath/sagetrac-mirror/commit/f6b68b9ad9b814bc20cdec7275ebfd4375e8f1ca)\".",
    "created_at": "2019-01-24T18:17:31Z",
    "issue": "https://github.com/sagemath/sage/issues/27049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27049#issuecomment-419938",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/nbruin/27049](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/27049)" to "[f6b68b9ad9b814bc20cdec7275ebfd4375e8f1ca](https://github.com/sagemath/sagetrac-mirror/commit/f6b68b9ad9b814bc20cdec7275ebfd4375e8f1ca)".
